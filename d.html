<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>업비트 조건 스캐너</title>
</head>
<body>
  <h1>업비트 조건 스캐너 (1D 기준)</h1>
  <button onclick="scan()">스캔 시작</button>
  <ul id="result"></ul>

  <script>
    const delay = ms => new Promise(res => setTimeout(res, ms));

    const MA = (data, period, idx) => {
      const slice = data.slice(idx - period + 1, idx + 1);
      if (slice.length < period) return null;
      const sum = slice.reduce((acc, d) => acc + d.tradePrice, 0);
      return sum / period;
    };

    async function getMarketList() {
      const res = await fetch("https://api.upbit.com/v1/market/all");
      const data = await res.json();
      return data
        .filter(d => d.market.startsWith("KRW-"))
        .map(d => d.market);
    }

    async function getCandles(market) {
      const url = `https://crix-api-endpoint.upbit.com/v1/crix/candles/days?code=CRIX.UPBIT.${market}&count=120`;
      const res = await fetch(url);
      if (!res.ok) return null;
      return await res.json();
    }

    async function checkCondition(market) {
      const candles = await getCandles(market);
      if (!candles || candles.length < 100) return false;

      const idx = 1; // 이전 일봉 기준
      const ma7 = MA(candles, 7, idx);
      const ma25 = MA(candles, 25, idx);
      const ma99 = MA(candles, 99, idx);
      if (!ma7 || !ma25 || !ma99) return false;

      // 조건 1: MA 순서
      const condition1 = ma99 < ma25 && ma25 < ma7;

      // 조건 2~5: a < b > c
      const a = ma7;
      const b = MA(candles, 7, idx + 1);
      const c = MA(candles, 7, idx + 2);
      const condition2 = a < b && b > c;

      return condition1 && condition2;
    }

    async function scan() {
      const resultEl = document.getElementById("result");
      resultEl.innerHTML = "스캔 중...";

      const markets = await getMarketList();
      const passed = [];

      for (let i = 0; i < markets.length; i++) {
        const market = markets[i];
        const ok = await checkCondition(market);
        if (ok) passed.push(market);
        resultEl.innerHTML = `<li>진행 중: ${i + 1}/${markets.length} - 조건 만족: ${passed.length}</li>`;
        await delay(150); // 너무 빠르면 비공식 API 차단 가능성 있음
      }

      resultEl.innerHTML = "<h2>조건을 만족하는 코인 목록 (KRW 마켓):</h2>";
      passed.forEach(m => {
        const li = document.createElement("li");
        li.textContent = m;
        resultEl.appendChild(li);
      });
    }
  </script>
</body>
</html>
