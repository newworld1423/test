<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>KR ì¼ë´‰ ì§ì „ë´‰ ìƒìŠ¹ë¥  ìŠ¤ìºë„ˆ (.kr ì „ìš©)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #0f1115; --panel: #151924; --text: #e8ecf1; --muted: #9aa4b2;
            --pos: #18c37e; --neg: #ff6b6b; --border: #242a38; --accent: #5aa7ff;
        }
        body { margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR","Malgun Gothic",sans-serif; }
        .wrap { max-width: 980px; margin: 36px auto; padding: 0 16px; }
        .card { background: linear-gradient(180deg,#151924 0%,#121620 100%); border:1px solid var(--border); border-radius:16px; padding:20px; }
        h1 { margin:0 0 10px; font-size:20px; }
        .desc { color:var(--muted); font-size:13px; line-height:1.5; margin-bottom:12px; }
        .grid { display:grid; grid-template-columns: 1fr 200px; gap:12px; margin-bottom:12px; }
        textarea, input, button { border-radius:10px; border:1px solid var(--border); background:#0e1220; color:var(--text); }
        textarea { padding:12px; min-height:140px; resize:vertical; }
        .right { display:grid; gap:10px; }
        .row { display:grid; grid-template-columns: 1fr; gap:8px; }
        .hint { font-size:12px; color:var(--muted); }
        button { padding:12px 14px; font-weight:700; cursor:pointer; background:linear-gradient(180deg,#1a55ff,#0040ff); border:0; }
        button:disabled { opacity:.5; cursor:not-allowed; }
        table { width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
        th, td { padding:10px 12px; border-bottom:1px solid var(--border); text-align:right; font-variant-numeric: tabular-nums; }
        th { text-align:center; background:#0f1422; color:#c8d3e3; font-weight:700; font-size:12px; letter-spacing:.3px; }
        td.sym, th.sym { text-align:left; }
        .pos { color:var(--pos); font-weight:700; }
        .neg { color:var(--neg); font-weight:700; }
        .skel { opacity:.65; font-style:italic; color:var(--muted); }
        .footer { margin-top:10px; color:var(--muted); font-size:12px; }
        .badge { display:inline-block; border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:11px; color:#b7c3d9; background:#0b0f1a; margin-right:6px; }
        @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <h1>ğŸ‡°ğŸ‡· 1ì¼ë´‰ ì§ì „ë´‰ ìƒìŠ¹ë¥  ìŠ¤ìºë„ˆ (KR ì „ìš©)</h1>
        <div class="desc">
            í•œêµ­ ì¢…ëª© ì½”ë“œë¥¼ ì¤„ë°”ê¿ˆ/ì‰¼í‘œë¡œ ì…ë ¥í•˜ê³  â€œìŠ¤ìº”â€ì„ ëˆ„ë¥´ì„¸ìš”. ëª¨ë“  ì‹¬ë³¼ì€ ìë™ìœ¼ë¡œ <span class="badge">.kr</span> ì ‘ë¯¸ì‚¬ê°€ ì ìš©ë©ë‹ˆë‹¤.
        </div>

        <div class="grid">
            <!-- âœ… ë¯¸ë¦¬ ì…ë ¥ëœ í•œêµ­ ì¢…ëª©ë“¤ -->
            <textarea id="symbols" placeholder="ì˜ˆ) 005930, 000660, 035420">035420, 328130, 304100, 108860, 338220, 452450, 402030, 488280, 463020, 096250, 377480, 300080, 322510, 347860, 382150, 315640, 413640, 384470, 355390</textarea>

            <div class="right">
                <div class="row">
                    <label class="hint">
                        ìµœëŒ€ ë‹¤ìš´ë¡œë“œ ì¼ìˆ˜
                        <input id="limitDays" type="number" min="20" max="365" value="120" style="width:100%; padding:10px; margin-top:6px;">
                    </label>
                </div>
                <button id="scanBtn">ìŠ¤ìº”</button>
                <div class="hint">â€¢ ë°ì´í„° ì†ŒìŠ¤: Stooq (ì¼ë´‰ CSV) â€¢ íœ´ì¥/ê°±ì‹  ì§€ì—° ì‹œ ì§ì „ ë°ì´í„°ê°€ í‘œì‹œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            </div>
        </div>

        <div id="tableWrap" style="margin-top:16px;">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th class="sym">ì‹¬ë³¼</th>
                        <th>ì¼ì(ì§ì „ë´‰)</th>
                        <th>ì‹œê°€</th>
                        <th>ê³ ê°€</th>
                        <th>ì €ê°€</th>
                        <th>ì¢…ê°€</th>
                        <th>ê±°ë˜ëŸ‰</th>
                        <th>ëª¸í†µìƒìŠ¹ë¥ <br/>(ì‹œê°€ëŒ€ë¹„)</th>
                        <th>ë“±ë½ë¥ <br/>(ì „ì¼ì¢…ê°€ëŒ€ë¹„)</th>
                        <th>ë©”ëª¨</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    <tr class="skel"><td class="sym">ì˜ˆì‹œ</td><td>â€”</td><td>â€”</td><td>â€”</td><td>â€”</td><td>â€”</td><td>â€”</td><td>â€”</td><td>â€”</td><td>ë¯¸ë¦¬ ì…ë ¥ëœ ëª©ë¡ìœ¼ë¡œ ìŠ¤ìº”í•´ë³´ì„¸ìš”</td></tr>
                </tbody>
            </table>
            <div class="footer">* ê³„ì‚°ì‹: ëª¸í†µìƒìŠ¹ë¥  = (ì¢…ê°€-ì‹œê°€)/ì‹œê°€Ã—100, ë“±ë½ë¥  = (ì¢…ê°€-ì „ì¼ì¢…ê°€)/ì „ì¼ì¢…ê°€Ã—100</div>
        </div>
    </div>
</div>

<script>
    // ---- CSV íŒŒì„œ (Stooq: date,open,high,low,close,volume)
    function parseStooqCSV(text) {
        const lines = text.trim().split(/\r?\n/);
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',');
            if (cols.length < 6) continue;
            const [date, open, high, low, close, volume] = cols;
            rows.push({
                date,
                open: Number(open),
                high: Number(high),
                low: Number(low),
                close: Number(close),
                volume: Number(volume)
            });
        }
        return rows;
    }

    function formatNumber(n) {
        if (!isFinite(n)) return 'â€”';
        return n.toLocaleString(undefined, { maximumFractionDigits: 6 });
    }
    function formatPct(n) {
        if (!isFinite(n)) return 'â€”';
        return n.toFixed(2) + '%';
    }

    // ---- í•œêµ­ ì „ìš©: ì–´ë–¤ ì…ë ¥ì´ ì™€ë„ .krë¡œ ê°•ì œ
    function toKRSymbol(input) {
        const s = input.trim();
        if (!s) return '';
        const base = s.replace(/\.[a-z]{2,3}$/i, ''); // ì ‘ë¯¸ì‚¬ ì œê±°
        return (base + '.kr').toLowerCase();
    }

    async function fetchStooqDailyKR(symbolKR, limitDays = 120) {
        const url = `https://stooq.com/q/d/l/?s=${encodeURIComponent(symbolKR)}&i=d`;
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const rows = parseStooqCSV(text);
        return rows.slice(-limitDays);
    }

    function calcPrevCandleMetrics(rows) {
        if (!rows || rows.length < 2) return null;
        const last = rows[rows.length - 1];   // ì§ì „ë´‰(ê°€ì¥ ìµœê·¼ í™•ì •)
        const prev = rows[rows.length - 2];   // ì „ì¼ ì¢…ê°€
        if (!isFinite(last.open) || !isFinite(last.close) || !isFinite(prev.close)) return null;

        const bodyPct = ((last.close - last.open) / last.open) * 100;
        const dayPct  = ((last.close - prev.close) / prev.close) * 100;

        return {
            date: last.date,
            open: last.open,
            high: last.high,
            low: last.low,
            close: last.close,
            volume: last.volume,
            bodyPct,
            dayPct
        };
    }

    function addRow(tbody, rawInput, sym, data, note = '') {
        const tr = document.createElement('tr');

        const tdSym = document.createElement('td');
        tdSym.className = 'sym';
        tdSym.textContent = rawInput + ' ';
        const small = document.createElement('small');
        small.style.color = '#8aa2c9';
        small.textContent = `(${sym})`;
        tdSym.appendChild(small);

        const tdDate = document.createElement('td');
        const tdOpen = document.createElement('td');
        const tdHigh = document.createElement('td');
        const tdLow = document.createElement('td');
        const tdClose = document.createElement('td');
        const tdVol = document.createElement('td');
        const tdBody = document.createElement('td');
        const tdDay = document.createElement('td');
        const tdNote = document.createElement('td');

        if (data) {
            tdDate.textContent = data.date;
            tdOpen.textContent = formatNumber(data.open);
            tdHigh.textContent = formatNumber(data.high);
            tdLow.textContent = formatNumber(data.low);
            tdClose.textContent = formatNumber(data.close);
            tdVol.textContent = formatNumber(data.volume);

            tdBody.textContent = formatPct(data.bodyPct);
            tdDay.textContent = formatPct(data.dayPct);

            tdBody.className = data.bodyPct >= 0 ? 'pos' : 'neg';
            tdDay.className = data.dayPct >= 0 ? 'pos' : 'neg';
        } else {
            tdDate.colSpan = 8;
            tdDate.textContent = 'ë°ì´í„° ì—†ìŒ';
            tdDate.style.textAlign = 'center';
        }

        tdNote.textContent = note || '';

        tr.appendChild(tdSym);
        tr.appendChild(tdDate);
        if (data) {
            tr.appendChild(tdOpen);
            tr.appendChild(tdHigh);
            tr.appendChild(tdLow);
            tr.appendChild(tdClose);
            tr.appendChild(tdVol);
            tr.appendChild(tdBody);
            tr.appendChild(tdDay);
        }
        tr.appendChild(tdNote);
        tbody.appendChild(tr);
    }

    async function scan() {
        const btn = document.getElementById('scanBtn');
        const tbody = document.getElementById('tbody');
        const symbolsInput = document.getElementById('symbols').value;
        const limitDays = Math.max(20, Math.min(365, parseInt(document.getElementById('limitDays').value || '120', 10)));

        tbody.innerHTML = '';
        btn.disabled = true;
        btn.textContent = 'ìŠ¤ìº” ì¤‘â€¦';

        const rawList = symbolsInput.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean);
        if (rawList.length === 0) {
            addRow(tbody, 'â€”', 'â€”', null, 'ì‹¬ë³¼ì„ ì…ë ¥í•˜ì„¸ìš”');
            btn.disabled = false;
            btn.textContent = 'ìŠ¤ìº”';
            return;
        }

        for (const raw of rawList) {
            const symKR = toKRSymbol(raw);

            let got = null, note = '';
            try {
                const rows = await fetchStooqDailyKR(symKR, limitDays);
                if (rows && rows.length >= 2) {
                    const metrics = calcPrevCandleMetrics(rows);
                    if (metrics) got = metrics;
                }
            } catch (e) {
                note = 'ìš”ì²­ ì‹¤íŒ¨';
            }

            if (!got) {
                addRow(tbody, raw, symKR, null, note || 'ë°ì´í„° ë¶€ì¡±/ì‹¬ë³¼ ë¶ˆì¼ì¹˜/íœ´ì¥ ê°€ëŠ¥ì„±');
            } else {
                const bodyDir = got.bodyPct >= 0 ? 'ìƒìŠ¹' : 'í•˜ë½';
                const dayDir  = got.dayPct  >= 0 ? 'ìƒìŠ¹' : 'í•˜ë½';
                note = `ëª¸í†µ ${bodyDir}, ì „ì¼ëŒ€ë¹„ ${dayDir}`;
                addRow(tbody, raw, symKR, got, note);
            }
        }

        btn.disabled = false;
        btn.textContent = 'ìŠ¤ìº”';
    }

    document.getElementById('scanBtn').addEventListener('click', scan);
</script>
</body>
</html>
