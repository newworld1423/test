<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>KR 일봉 직전봉 상승률 스캐너 (.kr 전용)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #0f1115; --panel: #151924; --text: #e8ecf1; --muted: #9aa4b2;
            --pos: #18c37e; --neg: #ff6b6b; --border: #242a38; --accent: #5aa7ff;
        }
        body { margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR","Malgun Gothic",sans-serif; }
        .wrap { max-width: 980px; margin: 36px auto; padding: 0 16px; }
        .card { background: linear-gradient(180deg,#151924 0%,#121620 100%); border:1px solid var(--border); border-radius:16px; padding:20px; }
        h1 { margin:0 0 10px; font-size:20px; }
        .desc { color:var(--muted); font-size:13px; line-height:1.5; margin-bottom:12px; }
        .grid { display:grid; grid-template-columns: 1fr 200px; gap:12px; margin-bottom:12px; }
        textarea, input, button { border-radius:10px; border:1px solid var(--border); background:#0e1220; color:var(--text); }
        textarea { padding:12px; min-height:140px; resize:vertical; }
        .right { display:grid; gap:10px; }
        .row { display:grid; grid-template-columns: 1fr; gap:8px; }
        .hint { font-size:12px; color:var(--muted); }
        button { padding:12px 14px; font-weight:700; cursor:pointer; background:linear-gradient(180deg,#1a55ff,#0040ff); border:0; }
        button:disabled { opacity:.5; cursor:not-allowed; }
        table { width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius:12px; overflow:hidden; }
        th, td { padding:10px 12px; border-bottom:1px solid var(--border); text-align:right; font-variant-numeric: tabular-nums; }
        th { text-align:center; background:#0f1422; color:#c8d3e3; font-weight:700; font-size:12px; letter-spacing:.3px; }
        td.sym, th.sym { text-align:left; }
        .pos { color:var(--pos); font-weight:700; }
        .neg { color:var(--neg); font-weight:700; }
        .skel { opacity:.65; font-style:italic; color:var(--muted); }
        .footer { margin-top:10px; color:var(--muted); font-size:12px; }
        .badge { display:inline-block; border:1px solid var(--border); padding:2px 8px; border-radius:999px; font-size:11px; color:#b7c3d9; background:#0b0f1a; margin-right:6px; }
        @media (max-width: 800px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card">
        <h1>🇰🇷 1일봉 직전봉 상승률 스캐너 (KR 전용)</h1>
        <div class="desc">
            한국 종목 코드를 줄바꿈/쉼표로 입력하고 “스캔”을 누르세요. 모든 심볼은 자동으로 <span class="badge">.kr</span> 접미사가 적용됩니다.
        </div>

        <div class="grid">
            <!-- ✅ 미리 입력된 한국 종목들 -->
            <textarea id="symbols" placeholder="예) 005930, 000660, 035420">035420, 328130, 304100, 108860, 338220, 452450, 402030, 488280, 463020, 096250, 377480, 300080, 322510, 347860, 382150, 315640, 413640, 384470, 355390</textarea>

            <div class="right">
                <div class="row">
                    <label class="hint">
                        최대 다운로드 일수
                        <input id="limitDays" type="number" min="20" max="365" value="120" style="width:100%; padding:10px; margin-top:6px;">
                    </label>
                </div>
                <button id="scanBtn">스캔</button>
                <div class="hint">• 데이터 소스: Stooq (일봉 CSV) • 휴장/갱신 지연 시 직전 데이터가 표시될 수 있습니다.</div>
            </div>
        </div>

        <div id="tableWrap" style="margin-top:16px;">
            <table id="resultTable">
                <thead>
                    <tr>
                        <th class="sym">심볼</th>
                        <th>일자(직전봉)</th>
                        <th>시가</th>
                        <th>고가</th>
                        <th>저가</th>
                        <th>종가</th>
                        <th>거래량</th>
                        <th>몸통상승률<br/>(시가대비)</th>
                        <th>등락률<br/>(전일종가대비)</th>
                        <th>메모</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    <tr class="skel"><td class="sym">예시</td><td>—</td><td>—</td><td>—</td><td>—</td><td>—</td><td>—</td><td>—</td><td>—</td><td>미리 입력된 목록으로 스캔해보세요</td></tr>
                </tbody>
            </table>
            <div class="footer">* 계산식: 몸통상승률 = (종가-시가)/시가×100, 등락률 = (종가-전일종가)/전일종가×100</div>
        </div>
    </div>
</div>

<script>
    // ---- CSV 파서 (Stooq: date,open,high,low,close,volume)
    function parseStooqCSV(text) {
        const lines = text.trim().split(/\r?\n/);
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',');
            if (cols.length < 6) continue;
            const [date, open, high, low, close, volume] = cols;
            rows.push({
                date,
                open: Number(open),
                high: Number(high),
                low: Number(low),
                close: Number(close),
                volume: Number(volume)
            });
        }
        return rows;
    }

    function formatNumber(n) {
        if (!isFinite(n)) return '—';
        return n.toLocaleString(undefined, { maximumFractionDigits: 6 });
    }
    function formatPct(n) {
        if (!isFinite(n)) return '—';
        return n.toFixed(2) + '%';
    }

    // ---- 한국 전용: 어떤 입력이 와도 .kr로 강제
    function toKRSymbol(input) {
        const s = input.trim();
        if (!s) return '';
        const base = s.replace(/\.[a-z]{2,3}$/i, ''); // 접미사 제거
        return (base + '.kr').toLowerCase();
    }

    async function fetchStooqDailyKR(symbolKR, limitDays = 120) {
        const url = `https://stooq.com/q/d/l/?s=${encodeURIComponent(symbolKR)}&i=d`;
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const rows = parseStooqCSV(text);
        return rows.slice(-limitDays);
    }

    function calcPrevCandleMetrics(rows) {
        if (!rows || rows.length < 2) return null;
        const last = rows[rows.length - 1];   // 직전봉(가장 최근 확정)
        const prev = rows[rows.length - 2];   // 전일 종가
        if (!isFinite(last.open) || !isFinite(last.close) || !isFinite(prev.close)) return null;

        const bodyPct = ((last.close - last.open) / last.open) * 100;
        const dayPct  = ((last.close - prev.close) / prev.close) * 100;

        return {
            date: last.date,
            open: last.open,
            high: last.high,
            low: last.low,
            close: last.close,
            volume: last.volume,
            bodyPct,
            dayPct
        };
    }

    function addRow(tbody, rawInput, sym, data, note = '') {
        const tr = document.createElement('tr');

        const tdSym = document.createElement('td');
        tdSym.className = 'sym';
        tdSym.textContent = rawInput + ' ';
        const small = document.createElement('small');
        small.style.color = '#8aa2c9';
        small.textContent = `(${sym})`;
        tdSym.appendChild(small);

        const tdDate = document.createElement('td');
        const tdOpen = document.createElement('td');
        const tdHigh = document.createElement('td');
        const tdLow = document.createElement('td');
        const tdClose = document.createElement('td');
        const tdVol = document.createElement('td');
        const tdBody = document.createElement('td');
        const tdDay = document.createElement('td');
        const tdNote = document.createElement('td');

        if (data) {
            tdDate.textContent = data.date;
            tdOpen.textContent = formatNumber(data.open);
            tdHigh.textContent = formatNumber(data.high);
            tdLow.textContent = formatNumber(data.low);
            tdClose.textContent = formatNumber(data.close);
            tdVol.textContent = formatNumber(data.volume);

            tdBody.textContent = formatPct(data.bodyPct);
            tdDay.textContent = formatPct(data.dayPct);

            tdBody.className = data.bodyPct >= 0 ? 'pos' : 'neg';
            tdDay.className = data.dayPct >= 0 ? 'pos' : 'neg';
        } else {
            tdDate.colSpan = 8;
            tdDate.textContent = '데이터 없음';
            tdDate.style.textAlign = 'center';
        }

        tdNote.textContent = note || '';

        tr.appendChild(tdSym);
        tr.appendChild(tdDate);
        if (data) {
            tr.appendChild(tdOpen);
            tr.appendChild(tdHigh);
            tr.appendChild(tdLow);
            tr.appendChild(tdClose);
            tr.appendChild(tdVol);
            tr.appendChild(tdBody);
            tr.appendChild(tdDay);
        }
        tr.appendChild(tdNote);
        tbody.appendChild(tr);
    }

    async function scan() {
        const btn = document.getElementById('scanBtn');
        const tbody = document.getElementById('tbody');
        const symbolsInput = document.getElementById('symbols').value;
        const limitDays = Math.max(20, Math.min(365, parseInt(document.getElementById('limitDays').value || '120', 10)));

        tbody.innerHTML = '';
        btn.disabled = true;
        btn.textContent = '스캔 중…';

        const rawList = symbolsInput.split(/[\n,;]+/).map(s => s.trim()).filter(Boolean);
        if (rawList.length === 0) {
            addRow(tbody, '—', '—', null, '심볼을 입력하세요');
            btn.disabled = false;
            btn.textContent = '스캔';
            return;
        }

        for (const raw of rawList) {
            const symKR = toKRSymbol(raw);

            let got = null, note = '';
            try {
                const rows = await fetchStooqDailyKR(symKR, limitDays);
                if (rows && rows.length >= 2) {
                    const metrics = calcPrevCandleMetrics(rows);
                    if (metrics) got = metrics;
                }
            } catch (e) {
                note = '요청 실패';
            }

            if (!got) {
                addRow(tbody, raw, symKR, null, note || '데이터 부족/심볼 불일치/휴장 가능성');
            } else {
                const bodyDir = got.bodyPct >= 0 ? '상승' : '하락';
                const dayDir  = got.dayPct  >= 0 ? '상승' : '하락';
                note = `몸통 ${bodyDir}, 전일대비 ${dayDir}`;
                addRow(tbody, raw, symKR, got, note);
            }
        }

        btn.disabled = false;
        btn.textContent = '스캔';
    }

    document.getElementById('scanBtn').addEventListener('click', scan);
</script>
</body>
</html>
