<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRW 상장 예측 스캐너</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f4f4f4; }
        #scanBtn { padding: 10px 20px; font-size: 16px; }
        #status { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>바이낸스 무기한 선물 KRW 상장 예측 스캐너</h1>
    <button id="scanBtn">스캔 시작</button>
    <p id="status">초기화 중...</p>
    <table id="resultTable">
        <thead>
            <tr>
                <th>심볼</th>
                <th>24h 거래량 변화(%)</th>
                <th>미결제약정 변화(%)</th>
                <th>종합 점수</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const exchangeInfoUrl = 'https://fapi.binance.com/fapi/v1/exchangeInfo';
        const tickerUrl = 'https://fapi.binance.com/fapi/v1/ticker/24hr';
        const STORAGE_KEY = 'baselineData';

        // 로컬스토리지에 baseline 저장/로드
        function saveBaseline(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }
        function loadStoredBaseline() {
            const json = localStorage.getItem(STORAGE_KEY);
            return json ? JSON.parse(json) : null;
        }

        // 영구 계약 baseline 생성
        async function createBaseline() {
            const infoRes = await fetch(exchangeInfoUrl);
            const infoData = await infoRes.json();
            const symbols = infoData.symbols
                .filter(s => s.contractType === 'PERPETUAL')
                .map(s => s.symbol);

            const tickerRes = await fetch(tickerUrl);
            const tickerData = await tickerRes.json();

            const baseline = {};
            tickerData.forEach(item => {
                if (symbols.includes(item.symbol)) {
                    baseline[item.symbol] = {
                        volume: parseFloat(item.volume),
                        openInterest: parseFloat(item.openInterest)
                    };
                }
            });
            saveBaseline(baseline);
            return baseline;
        }

        // 스캔 실행: 로드된 baseline과 비교
        async function scan() {
            const statusEl = document.getElementById('status');
            let baseline = loadStoredBaseline();
            if (!baseline) {
                statusEl.innerText = 'Baseline이 없어 새로 생성합니다...';
                baseline = await createBaseline();
                statusEl.innerText = 'Baseline 생성 완료. 1분 후 재시도하세요.';
                return [];
            }

            const res = await fetch(tickerUrl);
            const data = await res.json();
            const results = [];

            data.forEach(item => {
                const symbol = item.symbol;
                const base = baseline[symbol];
                if (!base) return;

                const curVol = parseFloat(item.volume);
                const curOI = parseFloat(item.openInterest);
                const volChange = ((curVol - base.volume) / base.volume) * 100;
                const oiChange = ((curOI - base.openInterest) / base.openInterest) * 100;
                const score = volChange * 0.6 + oiChange * 0.4;
                if (isFinite(score)) {
                    results.push({ symbol, volChange, oiChange, score });
                }
            });

            // 스캔 후 기준 데이터 업데이트
            const newBaseline = {};
            data.forEach(item => {
                newBaseline[item.symbol] = {
                    volume: parseFloat(item.volume),
                    openInterest: parseFloat(item.openInterest)
                };
            });
            saveBaseline(newBaseline);

            return results;
        }

        // 결과 렌더
        function displayResults(list) {
            const tbody = document.querySelector('#resultTable tbody');
            tbody.innerHTML = '';
            list.sort((a, b) => b.score - a.score).slice(0, 20).forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.symbol}</td>
                    <td>${item.volChange.toFixed(2)}</td>
                    <td>${item.oiChange.toFixed(2)}</td>
                    <td>${item.score.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('scanBtn').addEventListener('click', async () => {
            const btn = document.getElementById('scanBtn');
            const statusEl = document.getElementById('status');
            btn.disabled = true;
            btn.innerText = '스캔 중...';
            statusEl.innerText = '스캔 실행 중...';

            const results = await scan();
            if (results.length > 0) {
                displayResults(results);
                statusEl.innerText = `Scan completed: ${results.length} results`;
                statusEl.style.color = 'green';
            } else if (results.length === 0 && localStorage.getItem(STORAGE_KEY)) {
                statusEl.innerText = '변화량이 없어 결과가 없습니다.';
                statusEl.style.color = 'orange';
            }

            btn.disabled = false;
            btn.innerText = '스캔 시작';
        });

        // 최초 로드 시 baseline이 없으면 생성
        window.onload = async () => {
            const statusEl = document.getElementById('status');
            if (!loadStoredBaseline()) {
                statusEl.innerText = 'Baseline이 없어 생성 중...';
                await createBaseline();
                statusEl.innerText = 'Baseline 생성 완료. 스캔 버튼을 눌러주세요.';
                statusEl.style.color = 'blue';
            } else {
                statusEl.innerText = 'Baseline 있음. 스캔 버튼을 눌러주세요.';
                statusEl.style.color = 'green';
            }
        };
    </script>
</body>
</html>
