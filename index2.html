<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>바이낸스 무기한선물 1일봉 스캐너</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px;background:#fafafa}
h1{margin:0 0 12px;font-size:20px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
label{font-weight:700;margin-right:6px}
input{padding:8px 10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px}
button{padding:10px 14px;border:1px solid #111827;background:#111827;color:#fff;border-radius:8px;cursor:pointer}
button.ghost{background:#fff;color:#111827}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;font-weight:700;font-size:12px}
.ok{background:#ecfdf5;color:#047857}
.fail{background:#fef2f2;color:#b91c1c}
table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff}
th,td{border:1px solid #e5e7eb;padding:6px 8px;text-align:right;font-size:13px}
th{background:#f8fafc;white-space:nowrap}
td.sticky,th.sticky{position:sticky;left:0;background:#fff}
.status{margin-top:8px;font-size:12px;color:#374151}
</style>
</head>
<body>
<h1>무기한선물 1일봉 스캐너</h1>

<div class="row">
<label>심볼:</label><input id="symbol" value="BTCUSDT">
<label>스캔일수:</label><input id="days" type="number" value="10" min="5" max="500">
<label>기본성공기준(%):</label><input id="base" type="number" value="10" step="0.1">
<button id="scanBtn">스캔</button>
<button id="csvBtn" class="ghost">CSV다운로드</button>
</div>
<div id="status" class="status"></div>

<table id="result">
<thead>
<tr>
<th class="sticky">날짜</th><th>코인</th><th>상태</th><th>기준(%)</th>
<th>직전봉 저가</th><th>현재봉 시가</th><th>현재봉 고가</th><th>현재봉 저가</th>
<th>(고-시)/시</th><th>평균매수가</th><th>다음날 고가</th><th>달성률</th><th>성공여부</th>
</tr>
</thead><tbody></tbody>
</table>

<script>
const $=(s)=>document.querySelector(s);
function ymd(t){const d=new Date(t);return d.toISOString().slice(0,10);}
function n(x,d=5){return (x==null||isNaN(x))?"":Number(x).toFixed(d);}
function pct(x,d=2){return (x==null||isNaN(x))?"":(x*100).toFixed(d)+"%";}

async function fetchKlines(symbol,limit){
    const url=`https://fapi.binance.com/fapi/v1/klines?symbol=${encodeURIComponent(symbol)}&interval=1d&limit=${limit}`;
    const r=await fetch(url);
    if(!r.ok)throw new Error("HTTP "+r.status);
    const j=await r.json();
    return j.map(a=>({openTime:a[0],open:+a[1],high:+a[2],low:+a[3],close:+a[4]}));
}

function runScan(candles,symbol,days,basePct){
    const data=candles.slice(-days);
    let inDCA=false,threshold=basePct/100,avg=null;
    const rows=[];
    for(let i=1;i<data.length;i++){
        const p=data[i-1],c=data[i];
        const prevLow=p.low,curOpen=c.open,curHigh=c.high,curLow=c.low;
        const curRise=(curHigh-curOpen)/curOpen;
        const out={
            "날짜":ymd(c.openTime),"코인":symbol,"상태":inDCA?"물타기중":"일반",
            "기준(%)":(threshold*100).toFixed(2)+"%","직전봉 저가":n(prevLow),
            "현재봉 시가":n(curOpen),"현재봉 고가":n(curHigh),
            "현재봉 저가":n(curLow),"(고-시)/시":pct(curRise),
            "평균매수가":"","다음날 고가":"","달성률":"","성공여부":""
        };
        if(!inDCA){
            if(curRise>=basePct/100){out["성공여부"]="성공";inDCA=false;threshold=basePct/100;avg=null;}
            else{out["성공여부"]="실패";avg=(prevLow>curLow)?(curOpen+prevLow)/2:curOpen;
                 inDCA=true;threshold=threshold/2;out["평균매수가"]=n(avg);}
        }else{
            const achieve=(curHigh-avg)/avg;
            out["평균매수가"]=n(avg);out["다음날 고가"]=n(curHigh);out["달성률"]=pct(achieve);
            if(achieve>=threshold){out["성공여부"]="성공";inDCA=false;threshold=basePct/100;avg=null;}
            else{out["성공여부"]="실패";avg=(prevLow>curLow)?(curOpen+prevLow)/2:curOpen;threshold/=2;}
        }
        rows.push(out);
    }
    return rows;
}

function render(rows){
    const tb=$("#result tbody");tb.innerHTML="";
    for(const r of rows){
        const tr=document.createElement("tr");
        const order=["날짜","코인","상태","기준(%)","직전봉 저가","현재봉 시가","현재봉 고가","현재봉 저가","(고-시)/시","평균매수가","다음날 고가","달성률","성공여부"];
        for(const k of order){
            const td=document.createElement("td");
            if(k==="날짜")td.classList.add("sticky");
            if(k==="성공여부"){const s=document.createElement("span");s.className="badge "+(r[k]==="성공"?"ok":"fail");s.textContent=r[k];td.appendChild(s);}
            else td.textContent=r[k]||"";
            tr.appendChild(td);
        }
        tb.appendChild(tr);
    }
}

function toCSV(rows){
    if(!rows.length)return"";
    const h=Object.keys(rows[0]);
    const esc=s=>`"${String(s).replaceAll('"','""')}"`;
    return h.map(esc).join(",")+"\n"+rows.map(r=>h.map(k=>esc(r[k]??"")).join(",")).join("\n");
}

let lastRows=[];
$("#scanBtn").onclick=async()=>{
 try{
  $("#status").textContent="데이터 불러오는 중...";
  const sym=$("#symbol").value.trim().toUpperCase(),days=+$("#days").value||10,base=+$("#base").value||10;
  const kl=await fetchKlines(sym,days+5);
  $("#status").textContent="스캔 계산 중...";
  lastRows=runScan(kl,sym,days,base);
  render(lastRows);
  $("#status").textContent=`${sym} ${days}일 데이터 스캔 완료`;
 }catch(e){
  $("#status").innerHTML=`<span class="err">에러:</span> ${e.message}`;
 }
};

$("#csvBtn").onclick=()=>{
 if(!lastRows.length){alert("스캔 후 다운로드 가능합니다.");return;}
 const csv=toCSV(lastRows);
 const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
 const url=URL.createObjectURL(blob);
 const a=document.createElement("a");a.href=url;a.download="scan_result.csv";
 document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
};
</script>
</body>
</html>