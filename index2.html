<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>코인 20일 스캐너 (1일봉)</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; }
        h1 { margin: 0 0 12px; }
        .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
        input, select, button { padding: 8px 10px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { border: 1px solid #e5e7eb; padding: 6px 8px; text-align: right; }
        th { background: #f8fafc; white-space: nowrap; }
        td.sticky, th.sticky { position: sticky; left: 0; background: #fff; z-index: 1; text-align: left; }
        .tag { display: inline-block; padding: 2px 6px; border-radius: 6px; font-weight: 600; font-size: 12px; }
        .ok { background: #ecfdf5; color: #047857; }
        .fail { background: #fef2f2; color: #b91c1c; }
        .muted { color: #6b7280; }
        .hint { font-size: 12px; color: #6b7280; }
    </style>
</head>
<body>
    <h1>코인 20일 스캐너 (1일봉)</h1>

    <div class="controls">
        <label>심볼
            <input id="symbol" value="BTCUSDT" />
        </label>
        <label>조회일수
            <input id="days" type="number" value="20" min="5" max="500" />
        </label>
        <label>기본 성공 기준(%) 
            <input id="baseThreshold" type="number" value="10" step="0.1" />
        </label>
        <button id="scanBtn">스캔</button>
        <button id="csvBtn">CSV 다운로드</button>
        <span class="hint">* 데이터: Binance 현물 / 1일봉</span>
    </div>

    <table id="result">
        <thead>
        <tr>
            <th class="sticky">날짜</th>
            <th>코인</th>
            <th>직전봉 상승률</th>
            <th>직전봉 저가</th>
            <th>현재봉 시가</th>
            <th>현재봉 고가</th>
            <th>현재봉 저가</th>
            <th>현재봉 (고가-시가)/시가</th>
            <th>적용 기준(%)</th>
            <th>성공 여부</th>
            <th>실패 시 평균매수가</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

<script>
/*
 Binanace klines: https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1d&limit=30
 반환 배열 각 원소: [ openTime, open, high, low, close, volume, closeTime, ... ]
*/

const $ = (sel) => document.querySelector(sel);
const api = (symbol, limit=50) => 
  `https://cors.isomorphic-git.org/https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(symbol)}&interval=1d&limit=${limit}`;

function fmtPct(x, digits=2) { return (x==null || isNaN(x)) ? "" : (x*100).toFixed(digits) + "%"; }
function pct(x, digits=2) { return (x==null || isNaN(x)) ? "" : x.toFixed(digits) + "%"; }
function n(x, digits=5) { return (x==null || isNaN(x)) ? "" : Number(x).toFixed(digits); }
function ymd(ts) {
    const d = new Date(ts);
    const yyyy = d.getUTCFullYear();
    const mm = String(d.getUTCMonth()+1).padStart(2, "0");
    const dd = String(d.getUTCDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
}

function toCSV(rows, headers) {
    const esc = (v) => `"${String(v).replaceAll('"','""')}"`;
    const head = headers.map(esc).join(",");
    const body = rows.map(r => headers.map(h => esc(r[h] ?? "")).join(",")).join("\n");
    return head + "\n" + body;
}

async function scan() {
    const symbol = $("#symbol").value.trim().toUpperCase();
    const days = Math.max(5, Math.min(500, Number($("#days").value) || 20));
    const base = Number($("#baseThreshold").value) || 10;

    const limit = days + 5; // 여유분(직전봉 계산용)
    const url = api(symbol, limit);

    let res;
    try {
        const r = await fetch(url);
        if (!r.ok) throw new Error("HTTP " + r.status);
        res = await r.json();
    } catch (e) {
        alert("데이터 요청 실패: " + e.message);
        return;
    }

    // 마지막 days개만 사용 (과거→현재 순으로 정렬되어 들어옴)
    const data = res.slice(-days);
    const rows = [];

    // 물타기 단계 (실패할 때마다 1씩 증가, 성공 시 0으로 리셋)
    let averagingLevel = 0;

    for (let i = 0; i < data.length; i++) {
        const prev = res[res.length - days - 1 + i]; // 현재행의 '직전봉'
        const cur  = data[i];

        if (!prev || !cur) continue;

        const [pOpenTime, pOpen, pHigh, pLow, pClose] = [prev[0], +prev[1], +prev[2], +prev[3], +prev[4]];
        const [cOpenTime, cOpen, cHigh, cLow, cClose] = [cur[0],  +cur[1],  +cur[2],  +cur[3],  +cur[4]];

        // 직전봉 상승률 = (C - O) / O
        const prevRise = (pClose - pOpen) / pOpen; // 비율

        // 현재봉 (고가-시가)/시가
        const curRise = (cHigh - cOpen) / cOpen; // 비율

        // 물타기 레벨에 따른 가변 기준 (기본 10% → 5% → 2.5% …)
        const appliedThresholdPct = (base * Math.pow(0.5, averagingLevel)); // %
        const appliedThreshold = appliedThresholdPct / 100; // 비율

        const success = (curRise >= appliedThreshold);

        // 실패 시 평균매수가 규칙
        // 1) 직전봉 저가 > 현재봉 저가 → (현재봉 시가 + 직전봉 저가) / 2
        // 2) 직전봉 저가 <= 현재봉 저가 → 현재봉 시가
        const avgBuyOnFail = (pLow > cLow) ? (cOpen + pLow) / 2 : cOpen;

        // 물타기 단계 갱신
        if (success) {
            averagingLevel = 0;
        } else {
            averagingLevel += 1;
        }

        rows.push({
            "날짜": ymd(cOpenTime),
            "코인": symbol,
            "직전봉 상승률": pct(prevRise),
            "직전봉 저가": n(pLow),
            "현재봉 시가": n(cOpen),
            "현재봉 고가": n(cHigh),
            "현재봉 저가": n(cLow),
            "현재봉 (고가-시가)/시가": pct(curRise),
            "적용 기준(%)": appliedThresholdPct.toFixed(2) + "%",
            "성공 여부": success ? "성공" : "실패",
            "실패 시 평균매수가": n(avgBuyOnFail)
        });
    }

    // 표 렌더
    const tbody = $("#result tbody");
    tbody.innerHTML = "";
    for (const r of rows) {
        const tr = document.createElement("tr");
        const cells = [
            ["날짜", true],
            ["코인"],
            ["직전봉 상승률"],
            ["직전봉 저가"],
            ["현재봉 시가"],
            ["현재봉 고가"],
            ["현재봉 저가"],
            ["현재봉 (고가-시가)/시가"],
            ["적용 기준(%)"],
            ["성공 여부"],
            ["실패 시 평균매수가"]
        ];
        for (const [key, sticky] of cells) {
            const td = document.createElement("td");
            if (sticky) td.classList.add("sticky");
            if (key === "성공 여부") {
                const span = document.createElement("span");
                span.className = "tag " + (r[key] === "성공" ? "ok" : "fail");
                span.textContent = r[key];
                td.appendChild(span);
            } else {
                td.textContent = r[key];
            }
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
    }

    // CSV 다운로드
    $("#csvBtn").onclick = () => {
        const headers = ["날짜","코인","직전봉 상승률","직전봉 저가","현재봉 시가","현재봉 고가","현재봉 저가","현재봉 (고가-시가)/시가","적용 기준(%)","성공 여부","실패 시 평균매수가"];
        const csv = toCSV(rows, headers);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${($("#symbol").value || "symbol")}_scan.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    };
}

$("#scanBtn").addEventListener("click", scan);

// 초기 1회 실행
scan();
</script>
</body>
</html>

