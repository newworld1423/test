<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Binance BTC 1D MA Scanner</title>
</head>
<body>
    <h1>BTC/USDT 1D MA 계산 예제</h1>
    <button id="startBtn">데이터 불러와서 MA 계산하기</button>
    <pre id="output"></pre>

    <script>
        const symbol = 'BTCUSDT';
        const interval = '1d';
        const limit = 1000;  // 한 번에 최대 1000개 캔들
        const maPeriods = [7, 25, 99];

        document.getElementById('startBtn').addEventListener('click', async () => {
            let allCandles = [];
            let startTime = 0; // 0이면 가장 오래된 데이터부터
            const now = Date.now();

            // 1. 페이징하며 모든 캔들 데이터 수집
            while (true) {
                const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&startTime=${startTime}&limit=${limit}`;
                const resp = await fetch(url);
                if (!resp.ok) {
                    console.error('API 호출 오류:', resp.statusText);
                    break;
                }
                const data = await resp.json();
                if (data.length === 0) break;

                allCandles = allCandles.concat(data);
                // 마지막 candle의 closeTime 다음부터
                const lastCloseTime = data[data.length - 1][6];
                // 더 이상 불러올 게 없으면 중지
                if (data.length < limit || lastCloseTime >= now) break;
                startTime = lastCloseTime + 1;
            }

            // 2. 종가 배열만 추출
            const closes = allCandles.map(c => parseFloat(c[4]));

            // 3. 이동평균 계산 함수
            function calcMA(arr, period) {
                const result = [];
                let sum = 0;
                for (let i = 0; i < arr.length; i++) {
                    sum += arr[i];
                    if (i >= period) {
                        sum -= arr[i - period];
                    }
                    if (i >= period - 1) {
                        result[i] = sum / period;
                    } else {
                        result[i] = null; // 계산 불가
                    }
                }
                return result;
            }

            // 4. 각 기간별 MA 배열 생성
            const maResults = {};
            for (const p of maPeriods) {
                maResults[p] = calcMA(closes, p);
            }

            // 5. 결과 출력 (예: 콘솔 또는 HTML)
            const outEl = document.getElementById('output');
            outEl.textContent = '';
            allCandles.forEach((candle, idx) => {
                const date = new Date(candle[0]).toISOString().slice(0, 10);
                const close = closes[idx].toFixed(2);
                const ma7  = maResults[7][idx]?.toFixed(2)  ?? '-';
                const ma25 = maResults[25][idx]?.toFixed(2) ?? '-';
                const ma99 = maResults[99][idx]?.toFixed(2) ?? '-';
                outEl.textContent += `${date}   close: ${close}   7MA: ${ma7}   25MA: ${ma25}   99MA: ${ma99}\n`;
            });
        });
    </script>
</body>
</html>
