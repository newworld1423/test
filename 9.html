<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Binance Perp USDT â€” 15m 7MA Cross Scanner (ìë™)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #05060a;
            --card: #11131a;
            --border: #262a33;
            --text: #e8eaed;
            --muted: #9aa0a6;
            --accent: #3ea6ff;
            --good: #00c853;
            --bad: #ff5252;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 16px;
            background: radial-gradient(circle at top, #171b24 0, #05060a 55%, #020308 100%);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                         "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
        }

        h1 {
            margin: 0 0 8px;
            font-size: 20px;
        }

        .card {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(10, 12, 18, 0.95);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 16px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
        }

        .desc {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .desc strong {
            color: var(--accent);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
        }

        button {
            border: none;
            border-radius: 999px;
            padding: 8px 16px;
            font-size: 13px;
            cursor: pointer;
            color: #ffffff;
            background: linear-gradient(135deg, #3ea6ff, #2962ff);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.35);
            transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.15s ease;
        }

        button:disabled {
            opacity: 0.45;
            cursor: default;
            box-shadow: none;
        }

        button:not(:disabled):active {
            transform: translateY(1px) scale(0.99);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .status {
            font-size: 12px;
            color: var(--muted);
        }

        .status strong {
            color: var(--accent);
        }

        .table-wrap {
            margin-top: 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead {
            background: linear-gradient(to right, #171a23, #13151d);
        }

        th, td {
            padding: 6px 8px;
            text-align: right;
            border-bottom: 1px solid #1d2029;
            white-space: nowrap;
        }

        th:first-child,
        td:first-child {
            text-align: left;
        }

        th {
            font-weight: 600;
            color: #cfd4e3;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tbody tr:nth-child(even) {
            background: rgba(15, 17, 25, 0.9);
        }

        tbody tr:nth-child(odd) {
            background: rgba(9, 11, 18, 0.9);
        }

        tbody tr:hover {
            background: rgba(62, 166, 255, 0.09);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(62, 166, 255, 0.12);
            color: var(--accent);
        }

        .good {
            color: var(--good);
        }

        .muted {
            color: var(--muted);
        }

        .count {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
        }

        .scroll {
            max-height: 480px;
            overflow: auto;
        }

        @media (max-width: 768px) {
            .card {
                padding: 12px;
            }
            th, td {
                padding: 4px 6px;
                font-size: 11px;
            }
            h1 {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>Binance Perp USDT â€” 15m 7MA Cross ìŠ¤ìºë„ˆ (ìë™)</h1>
        <div class="desc">
            ì¡°ê±´:
            <div>â€¢ <strong>2ë´‰ ì „</strong> 7MA &lt; 25MA <strong>ë˜ëŠ”</strong> 7MA &lt; 99MA (ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ì•„ë˜ë©´ í¬í•¨)</div>
            <div>â€¢ <strong>1ë´‰ ì „</strong> 7MA &gt; 25MA <strong>ê·¸ë¦¬ê³ </strong> 7MA &gt; 99MA</div>
            <div>â€¢ ê²°ê³¼ëŠ” <strong>ìµœê·¼ 24ì‹œê°„ USDT ê±°ë˜ëŒ€ê¸ˆ(quoteVolume)</strong> ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬</div>
            <div>â€¢ [ìŠ¤ìº” ì‹œì‘] í´ë¦­ ì‹œ â‘  í˜„ì¬ ì‹œê°„ ê¸°ì¤€ ì¦‰ì‹œ 1íšŒ ìŠ¤ìº” â‘¡ ì´í›„ ë§¤ ì‹œ 00/15/30/45ë¶„ë§ˆë‹¤ ìë™ ìŠ¤ìº”</div>
        </div>

        <div class="controls">
            <button id="scanBtn" type="button">15m ìŠ¤ìº” ì‹œì‘ (ìë™)</button>
            <div id="status" class="status">ëŒ€ê¸° ì¤‘...</div>
        </div>

        <div class="count" id="countInfo"></div>

        <div class="table-wrap">
            <div class="scroll">
                <table>
                    <thead>
                        <tr>
                            <th>ì‹¬ë³¼</th>
                            <th>24h ê±°ë˜ëŒ€ê¸ˆ (USDT)</th>
                            <th>1ë´‰ ì „ ì¢…ê°€</th>
                            <th>1ë´‰ ì „ 7MA</th>
                            <th>1ë´‰ ì „ 25MA</th>
                            <th>1ë´‰ ì „ 99MA</th>
                            <th>2ë´‰ ì „ 7 / 25 / 99</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody">
                        <!-- ê²°ê³¼ í–‰ì´ ì—¬ê¸° ì±„ì›Œì§‘ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "https://fapi.binance.com";
        const INTERVAL = "15m";
        const KLINES_LIMIT = 120; // 99MA ê³„ì‚° + ì—¬ìœ 

        const scanBtn = document.getElementById("scanBtn");
        const statusEl = document.getElementById("status");
        const resultBody = document.getElementById("resultBody");
        const countInfo = document.getElementById("countInfo");

        let autoTimerId = null;

        function formatNumber(value, fractionDigits = 4) {
            if (!Number.isFinite(value)) return "-";
            return value.toLocaleString("en-US", {
                minimumFractionDigits: 0,
                maximumFractionDigits: fractionDigits
            });
        }

        function formatVolume(value) {
            if (!Number.isFinite(value)) return "-";
            if (value >= 1e9) return (value / 1e9).toFixed(2) + "B";
            if (value >= 1e6) return (value / 1e6).toFixed(2) + "M";
            if (value >= 1e3) return (value / 1e3).toFixed(2) + "K";
            return value.toFixed(2);
        }

        function sma(values, period) {
            const result = new Array(values.length).fill(null);
            if (!values || values.length < period) return result;

            let sum = 0;
            for (let i = 0; i < values.length; i++) {
                const v = Number(values[i]);
                if (Number.isFinite(v)) {
                    sum += v;
                }

                if (i >= period) {
                    const old = Number(values[i - period]);
                    if (Number.isFinite(old)) {
                        sum -= old;
                    }
                }

                if (i >= period - 1) {
                    result[i] = sum / period;
                }
            }
            return result;
        }

        async function fetchAllUSDTPerpSymbols() {
            const url = API_BASE + "/fapi/v1/exchangeInfo";
            const res = await fetch(url);
            if (!res.ok) throw new Error("exchangeInfo ìš”ì²­ ì‹¤íŒ¨: " + res.status);
            const data = await res.json();
            const symbols = data.symbols || [];
            return symbols
                .filter(s =>
                    s.contractType === "PERPETUAL" &&
                    s.quoteAsset === "USDT" &&
                    s.status === "TRADING"
                )
                .map(s => s.symbol)
                .sort();
        }

        async function fetch24hTickersMap() {
            const url = API_BASE + "/fapi/v1/ticker/24hr";
            const res = await fetch(url);
            if (!res.ok) throw new Error("24hr ticker ìš”ì²­ ì‹¤íŒ¨: " + res.status);
            const data = await res.json();
            const map = Object.create(null);
            for (const item of data) {
                map[item.symbol] = {
                    volume: Number(item.volume),
                    quoteVolume: Number(item.quoteVolume)
                };
            }
            return map;
        }

        async function fetchKlines(symbol) {
            const url =
                API_BASE +
                "/fapi/v1/klines?symbol=" +
                encodeURIComponent(symbol) +
                "&interval=" +
                encodeURIComponent(INTERVAL) +
                "&limit=" +
                KLINES_LIMIT;
            const res = await fetch(url);
            if (!res.ok) {
                throw new Error("klines ìš”ì²­ ì‹¤íŒ¨(" + symbol + "): " + res.status);
            }
            return res.json();
        }

        // â˜… ì¡°ê±´ ë³€ê²½ í¬ì¸íŠ¸
        // 2ë´‰ ì „: 7MA < 25MA ë˜ëŠ” 7MA < 99MA (ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ì•„ë˜ì—¬ë„ í¬í•¨)
        // 1ë´‰ ì „: 7MA > 25MA && 7MA > 99MA
        function checkCrossCondition(closes) {
            if (!closes || closes.length < 100) {
                return null;
            }
        
            const ma7 = sma(closes, 7);
            const ma25 = sma(closes, 25);
            const ma99 = sma(closes, 99);
        
            const idx1 = closes.length - 2; // 1ë´‰ ì „ (ë§ˆê°ëœ ì§ì „ ë´‰)
            const idx2 = closes.length - 3; // 2ë´‰ ì „
        
            if (idx2 < 0 || idx1 < 0) return null;
        
            const ma7_1 = ma7[idx1];
            const ma25_1 = ma25[idx1];
            const ma99_1 = ma99[idx1];
        
            const ma7_2 = ma7[idx2];
            const ma25_2 = ma25[idx2];
            const ma99_2 = ma99[idx2];
        
            if (
                ![ma7_1, ma25_1, ma99_1, ma7_2, ma25_2, ma99_2].every(Number.isFinite)
            ) {
                return null;
            }
        
            // ğŸ”¹ 2ë´‰ ì „ ì¡°ê±´: 7MA < 99MA ë§Œ ì‚¬ìš© (25MAëŠ” ì¡°ê±´ì—ì„œ ì œì™¸)
            const cond2 = ma7_2 < ma99_2;
        
            // ğŸ”¹ 1ë´‰ ì „ ì¡°ê±´: ê·¸ëŒ€ë¡œ ìœ ì§€
            const cond1 =
                ma7_1 > ma25_1 &&
                ma7_1 > ma99_1;
        
            if (!(cond1 && cond2)) {
                return null;
            }
        
            return {
                idx1,
                idx2,
                ma7_1,
                ma25_1,
                ma99_1,
                ma7_2,
                ma25_2,
                ma99_2
            };
        }

        function renderResults(results) {
            resultBody.innerHTML = "";
            if (!results || results.length === 0) {
                countInfo.textContent = "ì¡°ê±´ì— ë§ëŠ” ì‹¬ë³¼ì´ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }

            const frag = document.createDocumentFragment();

            for (const r of results) {
                const tr = document.createElement("tr");

                const tdSymbol = document.createElement("td");
                tdSymbol.textContent = r.symbol;
                tr.appendChild(tdSymbol);

                const tdVol = document.createElement("td");
                tdVol.innerHTML =
                    "<span class='chip'>" +
                    formatVolume(r.quoteVolume24h) +
                    "</span>";
                tr.appendChild(tdVol);

                const tdClose = document.createElement("td");
                tdClose.textContent = formatNumber(r.close1, 6);
                tr.appendChild(tdClose);

                const td7_1 = document.createElement("td");
                td7_1.className = "good";
                td7_1.textContent = formatNumber(r.ma7_1, 6);
                tr.appendChild(td7_1);

                const td25_1 = document.createElement("td");
                td25_1.className = "muted";
                td25_1.textContent = formatNumber(r.ma25_1, 6);
                tr.appendChild(td25_1);

                const td99_1 = document.createElement("td");
                td99_1.className = "muted";
                td99_1.textContent = formatNumber(r.ma99_1, 6);
                tr.appendChild(td99_1);

                const tdPrev = document.createElement("td");
                tdPrev.textContent =
                    formatNumber(r.ma7_2, 6) +
                    " / " +
                    formatNumber(r.ma25_2, 6) +
                    " / " +
                    formatNumber(r.ma99_2, 6);
                tr.appendChild(tdPrev);

                frag.appendChild(tr);
            }

            resultBody.appendChild(frag);
            countInfo.textContent = "ì¡°ê±´ ì¼ì¹˜ ì‹¬ë³¼: " + results.length + "ê°œ";
        }

        // ë‹¤ìŒ 00/15/30/45ë¶„ê¹Œì§€ ë‚¨ì€ ms ê³„ì‚°
        function getNextQuarterDelayMs() {
            const now = new Date();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const ms = now.getMilliseconds();

            const currentQuarterIndex = Math.floor(minutes / 15);
            const nextQuarterIndex = currentQuarterIndex + 1;
            const nextQuarterMinutes = (nextQuarterIndex * 15) % 60;
            const hourOffset = Math.floor((minutes + 15) / 60);

            const next = new Date(now.getTime());
            next.setHours(now.getHours() + hourOffset, nextQuarterMinutes, 0, 0);

            // í˜¹ì‹œë‚˜ ë™ì¼ ì‹œê°ì´ë©´ 15ë¶„ ë’¤ë¡œ ë°€ì–´ì¤Œ
            if (next.getTime() <= now.getTime()) {
                next.setMinutes(next.getMinutes() + 15);
            }

            return next.getTime() - now.getTime();
        }

        // ë‹¤ìŒ ìë™ ìŠ¤ìº” ì˜ˆì•½
        function scheduleNextAutoScan() {
            if (autoTimerId) {
                clearTimeout(autoTimerId);
                autoTimerId = null;
            }

            const delay = getNextQuarterDelayMs();
            const next = new Date(Date.now() + delay);
            const timeStr = next.toLocaleTimeString("ko-KR", {
                hour12: false,
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit"
            });

            // ì§ì „ runScanì—ì„œ ì“´ ìƒíƒœ ë©”ì‹œì§€ ë’¤ì— ë‹¤ìŒ ìŠ¤ìº” ì‹œê°ì„ ë¶™ì—¬ì¤Œ
            statusEl.innerHTML +=
                ' <span class="muted">(ë‹¤ìŒ ìë™ ìŠ¤ìº” ì˜ˆì •: ' + timeStr + ')</span>';

            autoTimerId = setTimeout(async () => {
                autoTimerId = null;
                await runScan();        // ìë™ ìŠ¤ìº” 1íšŒ
                scheduleNextAutoScan(); // ë‹¤ìŒ 00/15/30/45ë¶„ìœ¼ë¡œ ë˜ ì˜ˆì•½
            }, delay);
        }

        async function runScan() {
            scanBtn.disabled = true;
            statusEl.innerHTML = "<strong>ì‹¬ë³¼ ëª©ë¡ / 24h ê±°ë˜ëŒ€ê¸ˆ ë¡œë”© ì¤‘...</strong>";
            resultBody.innerHTML = "";
            countInfo.textContent = "";

            try {
                const [symbols, tickerMap] = await Promise.all([
                    fetchAllUSDTPerpSymbols(),
                    fetch24hTickersMap()
                ]);

                statusEl.innerHTML =
                    "ì‹¬ë³¼ ìˆ˜: <strong>" +
                    symbols.length +
                    "</strong> â€” 15m klines ìŠ¤ìº” ì¤‘...";

                const results = [];
                const batchSize = 8; // ë™ì‹œ ìš”ì²­ ê°œìˆ˜

                for (let i = 0; i < symbols.length; i += batchSize) {
                    const batch = symbols.slice(i, i + batchSize);
                    const promises = batch.map(async symbol => {
                        try {
                            const klines = await fetchKlines(symbol);
                            if (!Array.isArray(klines) || klines.length === 0) {
                                return null;
                            }

                            const closes = klines.map(k => Number(k[4]));
                            const cond = checkCrossCondition(closes);
                            if (!cond) return null;

                            const close1 = closes[cond.idx1];
                            const ticker = tickerMap[symbol] || { quoteVolume: 0 };
                            const quoteVolume24h = Number(ticker.quoteVolume) || 0;

                            return {
                                symbol,
                                quoteVolume24h,
                                close1,
                                ma7_1: cond.ma7_1,
                                ma25_1: cond.ma25_1,
                                ma99_1: cond.ma99_1,
                                ma7_2: cond.ma7_2,
                                ma25_2: cond.ma25_2,
                                ma99_2: cond.ma99_2
                            };
                        } catch (err) {
                            console.warn("ìŠ¤ìº” ì‹¤íŒ¨:", symbol, err);
                            return null;
                        }
                    });

                    const batchResults = await Promise.all(promises);
                    for (const r of batchResults) {
                        if (r) results.push(r);
                    }

                    statusEl.innerHTML =
                        "15m klines ìŠ¤ìº” ì§„í–‰ ì¤‘... <strong>" +
                        Math.min(symbols.length, i + batchSize) +
                        " / " +
                        symbols.length +
                        "</strong>";
                }

                results.sort((a, b) => b.quoteVolume24h - a.quoteVolume24h);
                renderResults(results);

                statusEl.innerHTML =
                    "<strong>ì™„ë£Œ!</strong> ì¡°ê±´ ì¼ì¹˜: " +
                    results.length +
                    "ê°œ (24h USDT ê±°ë˜ëŒ€ê¸ˆ ìˆœ)";
            } catch (err) {
                console.error(err);
                statusEl.textContent =
                    "ì—ëŸ¬ ë°œìƒ: " + (err && err.message ? err.message : String(err));
            } finally {
                scanBtn.disabled = false;
            }
        }

        // ë²„íŠ¼ í´ë¦­ ì‹œ:
        // 1) ê¸°ì¡´ ìë™ íƒ€ì´ë¨¸ ì œê±°
        // 2) í˜„ì¬ ì‹œê°„ ê¸°ì¤€ ì¦‰ì‹œ 1íšŒ ìŠ¤ìº”
        // 3) ë‹¤ìŒ 00/15/30/45ë¶„ì— ìë™ ìŠ¤ìº” ì˜ˆì•½
        scanBtn.addEventListener("click", async () => {
            if (autoTimerId) {
                clearTimeout(autoTimerId);
                autoTimerId = null;
            }

            await runScan();
            scheduleNextAutoScan();
        });
    </script>
</body>
</html>
