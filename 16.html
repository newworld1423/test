<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Binance Perp USDT — 2024 1M 최고/최저가 스캐너</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --bg: #05060a;
            --card: #12131a;
            --muted: #9aa0a6;
            --text: #e8eaed;
            --accent: #3ea6ff;
            --good: #00c853;
            --bad: #ff5252;
            --border: #2a2e36;
            --row-alt: #181924;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: radial-gradient(circle at top, #151821 0, #050609 55%, #020308 100%);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
        }

        .page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        header {
            margin-bottom: 16px;
        }

        header h1 {
            font-size: 20px;
            margin: 0 0 4px;
        }

        header p {
            margin: 2px 0;
            font-size: 13px;
            color: var(--muted);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        button {
            border: none;
            border-radius: 999px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            background: var(--accent);
            color: #000;
            box-shadow: 0 0 0 1px #00000040, 0 10px 20px rgba(0, 0, 0, 0.55);
            transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, opacity 0.08s;
        }

        button:disabled {
            opacity: 0.5;
            cursor: default;
            box-shadow: none;
            transform: none;
        }

        button:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 0 0 1px #00000070, 0 16px 30px rgba(0, 0, 0, 0.75);
        }

        #status {
            font-size: 13px;
            color: var(--muted);
        }

        .table-wrap {
            border-radius: 16px;
            background: rgba(10, 11, 18, 0.9);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead {
            background: linear-gradient(to right, #151826, #10121b);
        }

        th, td {
            padding: 6px 8px;
            text-align: right;
            white-space: nowrap;
        }

        th {
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            color: var(--muted);
            position: sticky;
            top: 0;
            z-index: 1;
            backdrop-filter: blur(12px);
        }

        tbody tr:nth-child(odd) {
            background: #0e1017;
        }

        tbody tr:nth-child(even) {
            background: var(--row-alt);
        }

        tbody tr:hover {
            background: #242840;
        }

        td.symbol {
            text-align: left;
            font-weight: 600;
        }

        td.min {
            color: var(--good);
        }

        td.max {
            color: var(--bad);
        }

        td.ratio {
            font-weight: 600;
        }

        .hint {
            font-size: 11px;
            color: var(--muted);
            margin-top: 4px;
        }

        .scroll {
            max-height: 70vh;
            overflow: auto;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 17px;
            }
            th, td {
                padding: 5px 6px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <header>
            <h1>Binance Perp USDT — 2024년 1M 최저/최고가 스캐너</h1>
            <p>· 바이낸스 무기한 선물 USDT PERPETUAL 페어 전체를 대상으로 2024-01-01 ~ 2024-12-31(UTC) 구간 1M 캔들 스캔</p>
            <p>· 각 심볼의 2024년 최저 Low / 최고 High와 나온 월, 그리고 최고/최저 배율을 계산</p>
        </header>

        <section class="controls">
            <button id="scanBtn">2024년 스캔 시작 (1M 캔들)</button>
            <span id="status"></span>
        </section>
        <div class="hint">
            ※ 1M = 1달 캔들 기준입니다. (1분봉 1m 아님)<br>
            ※ 현재 바이낸스 선물 마켓에 존재하는 USDT PERPETUAL 심볼 기준입니다.
        </div>

        <section class="table-wrap" style="margin-top:10px;">
            <div class="scroll">
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th style="text-align:left;">심볼</th>
                            <th>2024 최저가</th>
                            <th>최저가 월</th>
                            <th>2024 최고가</th>
                            <th>최고가 월</th>
                            <th>최고/최저 배율</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 결과 행이 여기에 채워짐 -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        const API_BASE = "https://fapi.binance.com";

        // 2024-01-01 ~ 2025-01-01 (UTC 기준)
        const START_TIME = Date.UTC(2024, 0, 1); // 2024-01-01
        const END_TIME = Date.UTC(2025, 0, 1);   // 2025-01-01 (2024-12 캔들 끝)

        const scanBtn = document.getElementById("scanBtn");
        const statusEl = document.getElementById("status");
        const tbody = document.querySelector("#resultTable tbody");

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function loadSymbols() {
            const url = `${API_BASE}/fapi/v1/exchangeInfo`;
            const res = await fetch(url);
            if (!res.ok) {
                throw new Error(`exchangeInfo 에러: ${res.status}`);
            }
            const json = await res.json();
            const all = json.symbols || [];

            // USDT 선물 PERPETUAL만 필터
            const filtered = all.filter(s =>
                s.contractType === "PERPETUAL" &&
                s.quoteAsset === "USDT"
            );

            // 심볼별 소수점 자리수(PRICE_FILTER.tickSize 기준) 계산
            const meta = {};
            for (const s of filtered) {
                const priceFilter = (s.filters || []).find(f => f.filterType === "PRICE_FILTER");
                let decimals = 4;
                if (priceFilter && priceFilter.tickSize) {
                    const ts = priceFilter.tickSize;
                    const idx = ts.indexOf("1");
                    if (idx > 0) {
                        decimals = idx - 1;
                    } else {
                        decimals = 0;
                    }
                }
                meta[s.symbol] = { decimals };
            }

            return {
                symbols: filtered.map(s => s.symbol),
                meta
            };
        }

        async function fetchYearKlines(symbol) {
            const url = `${API_BASE}/fapi/v1/klines?symbol=${symbol}&interval=1M&startTime=${START_TIME}&endTime=${END_TIME}`;
            const res = await fetch(url);
            if (!res.ok) {
                throw new Error(`klines 에러 ${symbol}: ${res.status}`);
            }
            return res.json();
        }

        function formatMonth(ts) {
            if (!ts && ts !== 0) return "-";
            const d = new Date(ts);
            const y = d.getUTCFullYear();
            const m = (d.getUTCMonth() + 1).toString().padStart(2, "0");
            return `${y}-${m}`;
        }

        function formatPrice(v, decimals) {
            if (!isFinite(v)) return "-";
            const d = Math.max(0, Math.min(decimals, 8));
            return Number(v).toFixed(d);
        }

        async function scan2024() {
            scanBtn.disabled = true;
            tbody.innerHTML = "";
            statusEl.textContent = "심볼 목록 불러오는 중...";

            try {
                const { symbols, meta } = await loadSymbols();
                statusEl.textContent = `총 ${symbols.length}개 심볼 로드 완료. 2024년 1M 캔들 스캔 중...`;

                const results = [];
                let done = 0;

                for (const symbol of symbols) {
                    try {
                        const klines = await fetchYearKlines(symbol);

                        done += 1;
                        statusEl.textContent = `스캔 중... ${done}/${symbols.length} (${symbol})`;

                        if (!klines || !klines.length) {
                            await sleep(30);
                            continue;
                        }

                        let minLow = Infinity;
                        let minLowTime = null;
                        let maxHigh = -Infinity;
                        let maxHighTime = null;

                        for (const k of klines) {
                            const openTime = k[0];  // 캔들 시작 시간 (ms)
                            const high = parseFloat(k[2]);
                            const low = parseFloat(k[3]);

                            if (low < minLow) {
                                minLow = low;
                                minLowTime = openTime;
                            }
                            if (high > maxHigh) {
                                maxHigh = high;
                                maxHighTime = openTime;
                            }
                        }

                        if (!isFinite(minLow) || !isFinite(maxHigh)) {
                            await sleep(30);
                            continue;
                        }

                        const ratio = maxHigh / minLow;

                        results.push({
                            symbol,
                            minLow,
                            minLowTime,
                            maxHigh,
                            maxHighTime,
                            ratio
                        });

                        // 살짝 쉬어주기 (레이트리밋 완화용)
                        await sleep(30);
                    } catch (err) {
                        console.error(err);
                        await sleep(80);
                    }
                }

                // 최고/최저 배율 높은 순으로 정렬
                results.sort((a, b) => b.ratio - a.ratio);

                for (const row of results) {
                    const metaInfo = meta[row.symbol] || { decimals: 4 };
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
                        <td class="symbol">${row.symbol}</td>
                        <td class="min">${formatPrice(row.minLow, metaInfo.decimals)}</td>
                        <td>${formatMonth(row.minLowTime)}</td>
                        <td class="max">${formatPrice(row.maxHigh, metaInfo.decimals)}</td>
                        <td>${formatMonth(row.maxHighTime)}</td>
                        <td class="ratio">${row.ratio.toFixed(2)}x</td>
                    `;

                    tbody.appendChild(tr);
                }

                statusEl.textContent = `완료: ${results.length}개 심볼 스캔 완료 (배율 높은 순으로 정렬됨).`;
            } catch (e) {
                console.error(e);
                statusEl.textContent = "에러: " + e.message;
            } finally {
                scanBtn.disabled = false;
            }
        }

        scanBtn.addEventListener("click", scan2024);
    </script>
</body>
</html>
