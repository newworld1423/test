<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Binance Perp USDT — 4H 99MA 크로스 스캐너</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #05060a;
            --card: #111319;
            --muted: #9aa0a6;
            --text: #e8eaed;
            --accent: #3ea6ff;
            --good: #00c853;
            --bad: #ff5252;
            --border: #2a2e36;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 16px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                         Roboto, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
            background: radial-gradient(circle at top, #141726 0, #05060a 55%);
            color: var(--text);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            margin: 0 0 8px;
            font-size: 1.4rem;
            font-weight: 600;
        }
        .desc {
            margin: 0 0 12px;
            font-size: 0.85rem;
            color: var(--muted);
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        button#runScan {
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid var(--accent);
            background: rgba(62, 166, 255, 0.1);
            color: var(--accent);
            font-size: 0.9rem;
            cursor: pointer;
        }
        button#runScan:hover {
            background: rgba(62, 166, 255, 0.18);
        }
        #status {
            font-size: 0.8rem;
            color: var(--muted);
        }
        .table-wrap {
            background: rgba(9, 11, 18, 0.9);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            box-shadow: 0 14px 40px rgba(0, 0, 0, 0.5);
            padding: 8px;
            overflow: hidden;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        thead {
            background: rgba(255, 255, 255, 0.02);
        }
        th, td {
            padding: 6px 8px;
            text-align: right;
            white-space: nowrap;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }
        th {
            font-weight: 500;
            font-size: 0.75rem;
            color: var(--muted);
        }
        tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.01);
        }
        tbody tr:hover {
            background: rgba(62, 166, 255, 0.08);
        }
        td.symbol {
            text-align: left;
            font-weight: 600;
        }
        td.idx {
            text-align: right;
            color: var(--muted);
            font-size: 0.75rem;
        }
        td.up {
            color: var(--good);
        }
        td.down {
            color: var(--bad);
        }
        .note {
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--muted);
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Binance Perp USDT — 4H 99MA 크로스 스캐너</h1>
        <p class="desc">
            4시간봉 기준으로 <strong>전전봉 종가 &lt; 99MA</strong>, <strong>전봉 종가 &gt; 99MA</strong> 인
            USDT 무기한 선물만 모아서 24h 거래대금(USDT) 내림차순으로 정렬합니다.
        </p>

        <div class="controls">
            <button id="runScan" type="button">스캔 실행</button>
            <span id="status">준비됨</span>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>심볼</th>
                        <th>전봉 종가</th>
                        <th>전봉 99MA</th>
                        <th>乂 차이%</th>
                        <th>전전봉 종가</th>
                        <th>전전봉 99MA</th>
                        <th>24h 거래대금(USDT)</th>
                        <th>24h 거래량(코인)</th>
                        <th>현재가(24h)</th>
                    </tr>
                </thead>
                <tbody id="resultBody">
                </tbody>
            </table>
        </div>

        <div class="note">
            • 심볼 목록은 <code>/fapi/v1/exchangeInfo</code>에서 USDT 무기한(PERPETUAL)만 가져옵니다.<br>
            • 24h 거래대금은 <code>/fapi/v1/ticker/24hr</code>의 <code>quoteVolume</code> 기준입니다.<br>
            • 캔들은 <code>/fapi/v1/klines</code> 4h 기준, 마지막 봉은 진행 중으로 보고
              <strong>전봉 = 마지막에서 두 번째, 전전봉 = 마지막에서 세 번째</strong>로 계산합니다.
        </div>
    </div>

    <script>
        const API_BASE = 'https://fapi.binance.com';

        const statusEl = document.getElementById('status');
        const tbodyEl = document.getElementById('resultBody');
        const runBtn = document.getElementById('runScan');

        runBtn.addEventListener('click', function () {
            runScan().catch(function (err) {
                console.error(err);
                setStatus('에러: ' + (err.message || err));
            });
        });

        function setStatus(text) {
            statusEl.textContent = text;
        }

        function sma(values, endIndex, period) {
            let sum = 0;
            for (let i = endIndex - period + 1; i <= endIndex; i += 1) {
                sum += values[i];
            }
            return sum / period;
        }

        function formatNumber(value, decimals) {
            const num = Number(value);
            if (!isFinite(num)) {
                return '-';
            }
            const fixed = num.toFixed(decimals);
            const parts = fixed.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }

        function renderResults(rows) {
            tbodyEl.innerHTML = '';
            rows.forEach(function (row, idx) {
                const tr = document.createElement('tr');

                tr.innerHTML =
                    '<td class="idx">' + (idx + 1) + '</td>' +
                    '<td class="symbol">' + row.symbol + '</td>' +
                    '<td>' + formatNumber(row.closePrev, 6) + '</td>' +
                    '<td>' + formatNumber(row.maPrev, 6) + '</td>' +
                    '<td class="' + (row.diffPrev >= 0 ? 'up' : 'down') + '">' +
                        formatNumber(row.diffPrev, 2) + '%</td>' +
                    '<td>' + formatNumber(row.closePrevPrev, 6) + '</td>' +
                    '<td>' + formatNumber(row.maPrevPrev, 6) + '</td>' +
                    '<td>' + formatNumber(row.quoteVolume, 0) + '</td>' +
                    '<td>' + formatNumber(row.baseVolume, 0) + '</td>' +
                    '<td>' + formatNumber(row.lastPrice, 6) + '</td>';

                tbodyEl.appendChild(tr);
            });
        }

        async function scanSymbol(symInfo, ticker) {
            const symbol = symInfo.symbol;
            if (!ticker) {
                return null;
            }

            const url = API_BASE +
                '/fapi/v1/klines?symbol=' + symbol +
                '&interval=4h&limit=150';

            const res = await fetch(url);
            if (!res.ok) {
                throw new Error('klines 요청 실패: ' + symbol);
            }
            const klines = await res.json();
            // 99MA 계산을 위해 최소 99 + 2봉 필요
            if (!Array.isArray(klines) || klines.length < 101) {
                return null;
            }

            const closes = klines.map(function (k) {
                return Number(k[4]);
            });
            const len = closes.length;
            const period = 99;

            const idxPrev = len - 2;      // 이전(완료된) 봉
            const idxPrevPrev = len - 3;  // 이전의 이전 봉

            if (idxPrevPrev < period - 1) {
                return null;
            }

            const maPrev = sma(closes, idxPrev, period);
            const maPrevPrev = sma(closes, idxPrevPrev, period);

            const closePrev = closes[idxPrev];
            const closePrevPrev = closes[idxPrevPrev];

            if (!isFinite(maPrev) || !isFinite(maPrevPrev)) {
                return null;
            }

            // 조건: 전봉 종가 > 99MA && 전전봉 종가 < 99MA  (위/밑)
            if (!(closePrev > maPrev && closePrevPrev < maPrevPrev)) {
                return null;
            }

            const quoteVolume = Number(ticker.quoteVolume || 0);
            const baseVolume = Number(ticker.volume || 0);
            const lastPrice = Number(ticker.lastPrice || closes[len - 1] || 0);
            const diffPrev = ((closePrev - maPrev) / maPrev) * 100;

            return {
                symbol: symbol,
                closePrev: closePrev,
                maPrev: maPrev,
                diffPrev: diffPrev,
                closePrevPrev: closePrevPrev,
                maPrevPrev: maPrevPrev,
                quoteVolume: quoteVolume,
                baseVolume: baseVolume,
                lastPrice: lastPrice
            };
        }

        async function runScan() {
            tbodyEl.innerHTML = '';
            setStatus('ExchangeInfo 불러오는 중...');

            // 1) USDT 무기한 페어 가져오기
            const exRes = await fetch(API_BASE + '/fapi/v1/exchangeInfo');
            if (!exRes.ok) {
                throw new Error('exchangeInfo 요청 실패');
            }
            const exJson = await exRes.json();
            const symbols = (exJson.symbols || []).filter(function (s) {
                return s.contractType === 'PERPETUAL' &&
                       s.quoteAsset === 'USDT' &&
                       s.status === 'TRADING';
            });

            if (!symbols.length) {
                setStatus('USDT 무기한 심볼을 찾지 못했습니다.');
                return;
            }

            // 2) 24h ticker (거래대금 등) 가져오기
            setStatus('24h 거래량 불러오는 중...');
            const tRes = await fetch(API_BASE + '/fapi/v1/ticker/24hr');
            if (!tRes.ok) {
                throw new Error('ticker/24hr 요청 실패');
            }
            const tickers = await tRes.json();
            const tickerMap = {};
            tickers.forEach(function (t) {
                tickerMap[t.symbol] = t;
            });

            // 3) 심볼별로 4H 캔들 스캔 (동시 8개씩)
            setStatus('4H 캔들 스캔 중... (0 / ' + symbols.length + ')');

            const results = [];
            let processed = 0;
            const maxConcurrency = 8;
            let index = 0;

            async function worker() {
                while (true) {
                    let currentIndex;
                    if (index >= symbols.length) {
                        break;
                    }
                    currentIndex = index;
                    index += 1;

                    const symInfo = symbols[currentIndex];
                    try {
                        const row = await scanSymbol(symInfo, tickerMap[symInfo.symbol]);
                        if (row) {
                            results.push(row);
                        }
                    } catch (e) {
                        console.error('scan error', symInfo.symbol, e);
                    }

                    processed += 1;
                    if (processed % 5 === 0 || processed === symbols.length) {
                        setStatus('4H 캔들 스캔 중... (' +
                            processed + ' / ' + symbols.length + ')');
                    }
                }
            }

            const workers = [];
            for (let i = 0; i < maxConcurrency; i += 1) {
                workers.push(worker());
            }
            await Promise.all(workers);

            if (!results.length) {
                setStatus('조건에 맞는 심볼이 없습니다.');
                return;
            }

            // 4) 24h 거래대금(USDT, quoteVolume) 기준 내림차순 정렬
            results.sort(function (a, b) {
                return b.quoteVolume - a.quoteVolume;
            });

            renderResults(results);
            setStatus('완료: ' + results.length +
                '개 심볼 (총 ' + symbols.length + '개 중)');
        }
    </script>
</body>
</html>
