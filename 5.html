<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Binance Perp USDT â€” 4H MA ì—­ë°°ì—´ Â· 99MA ê·¼ì ‘ë„ ìŠ¤ìºë„ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #0b0c10;
            --card: #121318;
            --muted: #9aa0a6;
            --text: #e8eaed;
            --accent: #3ea6ff;
            --good: #00c853;
            --bad: #ff5252;
            --warn: #ffd54f;
            --border: #2a2e36;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 16px;
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
                         Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo",
                         "Noto Sans KR", sans-serif;
            background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
            color: var(--text);
        }

        h1 {
            font-size: 20px;
            margin: 0 0 4px;
        }

        .subtitle {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 16px;
        }

        .card {
            background: rgba(9, 11, 17, 0.96);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.65);
            padding: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px 12px;
            margin-bottom: 12px;
        }

        .toolbar-left {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px 12px;
            flex: 1 1 auto;
        }

        .toolbar-right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            border: 1px solid var(--accent);
            background: rgba(62, 166, 255, 0.1);
            color: var(--accent);
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s, transform 0.1s, box-shadow 0.2s, opacity 0.2s;
            white-space: nowrap;
        }

        .btn:hover {
            background: rgba(62, 166, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(62, 166, 255, 0.35);
        }

        .btn:disabled {
            opacity: 0.55;
            cursor: default;
            box-shadow: none;
            transform: none;
        }

        .pill {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid var(--border);
            color: var(--muted);
            background: rgba(15, 23, 42, 0.9);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .pill strong {
            color: var(--text);
        }

        .progress {
            font-size: 12px;
            color: var(--muted);
        }

        .progress span {
            color: var(--accent);
        }

        .table-wrap {
            margin-top: 8px;
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            background: rgba(10, 12, 18, 0.98);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead {
            background: radial-gradient(circle at top left, #1f2937 0, #020617 70%);
        }

        th, td {
            padding: 6px 8px;
            text-align: right;
            border-bottom: 1px solid rgba(31, 41, 55, 0.75);
            white-space: nowrap;
        }

        th:first-child,
        td:first-child {
            text-align: left;
        }

        th:nth-child(2),
        td:nth-child(2) {
            text-align: left;
        }

        thead th {
            font-weight: 600;
            color: var(--muted);
        }

        tbody tr:nth-child(even) {
            background: rgba(15, 23, 42, 0.9);
        }

        tbody tr:nth-child(odd) {
            background: rgba(3, 7, 18, 0.9);
        }

        .badge-direction {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid var(--border);
        }

        .badge-up {
            border-color: var(--good);
            color: var(--good);
            background: rgba(0, 200, 83, 0.05);
        }

        .badge-down {
            border-color: var(--bad);
            color: var(--bad);
            background: rgba(255, 82, 82, 0.05);
        }

        .distance-strong {
            font-weight: 600;
            color: var(--accent);
        }

        .footer-note {
            margin-top: 10px;
            font-size: 11px;
            color: var(--muted);
            line-height: 1.5;
        }

        .footer-note code {
            font-size: 11px;
            background: rgba(15, 23, 42, 0.95);
            padding: 2px 5px;
            border-radius: 4px;
            border: 1px solid rgba(31, 41, 55, 0.9);
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            .card {
                padding: 12px;
                border-radius: 12px;
            }
            h1 {
                font-size: 18px;
            }
            .toolbar {
                flex-direction: column;
                align-items: flex-start;
            }
            .toolbar-left,
            .toolbar-right {
                width: 100%;
                justify-content: space-between;
            }
            table {
                font-size: 11px;
            }
            th, td {
                padding: 5px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>4H MA ì—­ë°°ì—´ Â· 99MA ê·¼ì ‘ë„ ìŠ¤ìºë„ˆ</h1>
        <div class="subtitle">
            Binance USDT ë¬´ê¸°í•œ ì„ ë¬¼ Â· <strong>4ì‹œê°„ë´‰</strong> ê¸°ì¤€
            â€” <strong>ì§ì „ë´‰ 7/25/99MA ì—­ë°°ì—´</strong> + <strong>ì§ì „ë´‰ ì¢…ê°€ì˜ 99MA ê·¼ì ‘ë„</strong>ë¡œ ì •ë ¬
        </div>

        <div class="toolbar">
            <div class="toolbar-left">
                <button id="scanBtn" class="btn">
                    ğŸ” ìŠ¤ìº” ì‹œì‘ (4H)
                </button>
                <div class="pill">
                    ì¡°ê±´: <strong>ì´ì „ë´‰ 7MA &lt; 25MA &lt; 99MA</strong>
                </div>
            </div>
            <div class="toolbar-right">
                <div id="progressText" class="progress">ëŒ€ê¸° ì¤‘â€¦</div>
            </div>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ì‹¬ë³¼</th>
                        <th>ì´ì „ë´‰ ì‹œê° (UTC)</th>
                        <th>ì´ì „ë´‰ ì¢…ê°€</th>
                        <th>7MA</th>
                        <th>25MA</th>
                        <th>99MA</th>
                        <th>99MA ëŒ€ë¹„ ê±°ë¦¬%</th>
                        <th>ìœ„ì¹˜</th>
                    </tr>
                </thead>
                <tbody id="resultBody">
                    <!-- ê²°ê³¼ í–‰ì´ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤ -->
                </tbody>
            </table>
        </div>

        <div class="footer-note">
            Â· â€œì´ì „ë´‰â€ì€ <strong>í˜„ì¬ ì§„í–‰ ì¤‘ì¸ 4ì‹œê°„ë´‰ ë°”ë¡œ ì „, ë§ˆì§€ë§‰ìœ¼ë¡œ ì™„ì„±ëœ ìº”ë“¤</strong> ê¸°ì¤€ì…ë‹ˆë‹¤.<br />
            Â· â€œ99MA ëŒ€ë¹„ ê±°ë¦¬%â€ = <code>|ì¢…ê°€ - 99MA| / 99MA Ã— 100</code>, ê°’ì´ ì‘ì„ìˆ˜ë¡ 99MAì— ë” ê°€ê¹ìŠµë‹ˆë‹¤.<br />
            Â· ì—­ë°°ì—´ ì •ì˜: <code>7MA &lt; 25MA &lt; 99MA</code> ì¸ ì¢…ëª©ë§Œ ë¦¬ìŠ¤íŠ¸ì— í¬í•¨ë©ë‹ˆë‹¤.
        </div>
    </div>

    <script>
        const API_BASE = "https://fapi.binance.com";
        const progressEl = document.getElementById("progressText");
        const scanBtn = document.getElementById("scanBtn");
        const resultBody = document.getElementById("resultBody");

        // ìˆ«ì í¬ë§·
        function formatNumber(x, digits) {
            if (!isFinite(x)) return "-";
            return Number(x).toFixed(digits);
        }

        function formatTimeUTC(ms) {
            const d = new Date(ms);
            const yyyy = d.getUTCFullYear();
            const MM = String(d.getUTCMonth() + 1).padStart(2, "0");
            const dd = String(d.getUTCDate()).padStart(2, "0");
            const hh = String(d.getUTCHours()).padStart(2, "0");
            const mi = String(d.getUTCMinutes()).padStart(2, "0");
            return `${yyyy}-${MM}-${dd} ${hh}:${mi}`;
        }

        // ê°„ë‹¨ SMA
        function sma(values, period) {
            const out = new Array(values.length).fill(null);
            let sum = 0;
            for (let i = 0; i < values.length; i++) {
                const v = values[i];
                sum += v;
                if (i >= period) {
                    sum -= values[i - period];
                }
                if (i >= period - 1) {
                    out[i] = sum / period;
                }
            }
            return out;
        }

        async function fetchSymbols() {
            const url = `${API_BASE}/fapi/v1/exchangeInfo`;
            const res = await fetch(url);
            if (!res.ok) {
                throw new Error("exchangeInfo ìš”ì²­ ì‹¤íŒ¨: " + res.status);
            }
            const data = await res.json();
            const symbols = data.symbols || [];

            // USDT ë¬´ê¸°í•œ ì„ ë¬¼ë§Œ í•„í„° (PERPETUAL + quoteAsset=USDT + TRADING)
            return symbols
                .filter(s =>
                    s.contractType === "PERPETUAL" &&
                    s.quoteAsset === "USDT" &&
                    s.status === "TRADING"
                )
                .map(s => s.symbol)
                .sort();
        }

        async function fetchKlines(symbol) {
            // 4ì‹œê°„ë´‰, 150ê°œ ì •ë„ë©´ 99MA ê³„ì‚°ì— ì¶©ë¶„
            const url = `${API_BASE}/fapi/v1/klines?symbol=${symbol}&interval=4h&limit=150`;
            const res = await fetch(url);
            if (!res.ok) {
                throw new Error(symbol + " klines ìš”ì²­ ì‹¤íŒ¨: " + res.status);
            }
            const data = await res.json();
            return data;
        }

        async function analyzeSymbol(symbol) {
            const klines = await fetchKlines(symbol);
            if (!Array.isArray(klines) || klines.length < 120) {
                return null; // ë°ì´í„° ë¶€ì¡±
            }

            const closes = klines.map(k => Number(k[4]));
            const openTimes = klines.map(k => Number(k[0]));

            const ma7  = sma(closes, 7);
            const ma25 = sma(closes, 25);
            const ma99 = sma(closes, 99);

            // ë§ˆì§€ë§‰ ìš”ì†ŒëŠ” í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìº”ë“¤ì´ í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ,
            // "ì´ì „ë´‰" = ëì—ì„œ ë‘ ë²ˆì§¸ ì¸ë±ìŠ¤ ì‚¬ìš©
            const lastIndex = closes.length - 1;
            const idx = lastIndex - 1;

            if (idx < 99) {
                return null;
            }

            const cPrev   = closes[idx];
            const m7Prev  = ma7[idx];
            const m25Prev = ma25[idx];
            const m99Prev = ma99[idx];

            if (m7Prev == null || m25Prev == null || m99Prev == null) {
                return null;
            }

            // ì—­ë°°ì—´ ì¡°ê±´: 7MA < 25MA < 99MA
            if (!(m7Prev < m25Prev && m25Prev < m99Prev)) {
                return null;
            }

            const diffAbs = Math.abs(cPrev - m99Prev);
            const diffPct = (diffAbs / m99Prev) * 100;

            const direction = cPrev >= m99Prev ? "above" : "below";

            return {
                symbol,
                openTimePrev: openTimes[idx],
                closePrev: cPrev,
                ma7: m7Prev,
                ma25: m25Prev,
                ma99: m99Prev,
                diffAbs,
                diffPct,
                direction
            };
        }

        function renderResults(rows) {
            resultBody.innerHTML = "";

            if (!rows.length) {
                const tr = document.createElement("tr");
                const td = document.createElement("td");
                td.colSpan = 9;
                td.textContent = "ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì‹¬ë³¼ì´ ì—†ìŠµë‹ˆë‹¤.";
                td.style.textAlign = "center";
                td.style.color = "var(--muted)";
                tr.appendChild(td);
                resultBody.appendChild(tr);
                return;
            }

            rows.forEach((row, idx) => {
                const tr = document.createElement("tr");

                const rankTd = document.createElement("td");
                rankTd.textContent = idx + 1;

                const symbolTd = document.createElement("td");
                symbolTd.textContent = row.symbol;

                const timeTd = document.createElement("td");
                timeTd.textContent = formatTimeUTC(row.openTimePrev);

                const closeTd = document.createElement("td");
                closeTd.textContent = formatNumber(row.closePrev, 4);

                const ma7Td = document.createElement("td");
                ma7Td.textContent = formatNumber(row.ma7, 4);

                const ma25Td = document.createElement("td");
                ma25Td.textContent = formatNumber(row.ma25, 4);

                const ma99Td = document.createElement("td");
                ma99Td.textContent = formatNumber(row.ma99, 4);

                const distTd = document.createElement("td");
                distTd.textContent = formatNumber(row.diffPct, 3);
                distTd.className = "distance-strong";

                const dirTd = document.createElement("td");
                const span = document.createElement("span");
                span.classList.add("badge-direction");
                if (row.direction === "above") {
                    span.classList.add("badge-up");
                    span.textContent = "ìƒë‹¨ (ì¢…ê°€ > 99MA)";
                } else {
                    span.classList.add("badge-down");
                    span.textContent = "í•˜ë‹¨ (ì¢…ê°€ < 99MA)";
                }
                dirTd.appendChild(span);

                tr.appendChild(rankTd);
                tr.appendChild(symbolTd);
                tr.appendChild(timeTd);
                tr.appendChild(closeTd);
                tr.appendChild(ma7Td);
                tr.appendChild(ma25Td);
                tr.appendChild(ma99Td);
                tr.appendChild(distTd);
                tr.appendChild(dirTd);

                resultBody.appendChild(tr);
            });
        }

        async function runScan() {
            scanBtn.disabled = true;
            progressEl.textContent = "ì‹¬ë³¼ ëª©ë¡ ê°€ì ¸ì˜¤ëŠ” ì¤‘â€¦";

            try {
                const symbols = await fetchSymbols();
                const total = symbols.length;
                let processed = 0;
                const results = [];

                progressEl.textContent = `4ì‹œê°„ë´‰ ìŠ¤ìº” ì¤‘â€¦ 0 / ${total}`;

                // ë„ˆë¬´ ë§ì´ ë™ì‹œì— ìš”ì²­í•˜ë©´ Binance rate limit ê±¸ë¦´ ìˆ˜ ìˆìœ¼ë‹ˆ
                // ê°„ë‹¨í•œ ì›Œì»¤ ë°©ì‹ìœ¼ë¡œ ë™ì‹œ ìš”ì²­ ìˆ˜ ì œí•œ (ì˜ˆ: ìµœëŒ€ 6ê°œ)
                const maxWorkers = 6;
                let index = 0;

                async function worker() {
                    while (true) {
                        const myIndex = index++;
                        if (myIndex >= total) break;
                        const symbol = symbols[myIndex];

                        try {
                            const r = await analyzeSymbol(symbol);
                            if (r) {
                                results.push(r);
                            }
                        } catch (err) {
                            console.error("ì—ëŸ¬:", symbol, err);
                        }

                        processed++;
                        progressEl.innerHTML = `4ì‹œê°„ë´‰ ìŠ¤ìº” ì¤‘â€¦ <span>${processed}</span> / ${total}`;
                    }
                }

                const workers = [];
                for (let i = 0; i < maxWorkers; i++) {
                    workers.push(worker());
                }

                await Promise.all(workers);

                // 99MA ê·¼ì ‘ë„(%) ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                results.sort((a, b) => a.diffPct - b.diffPct);

                progressEl.innerHTML =
                    `ì™„ë£Œ Â· ì´ ì‹¬ë³¼ <span>${total}</span>ê°œ ì¤‘ `
                    + `<span>${results.length}</span>ê°œê°€ ì¡°ê±´(ì—­ë°°ì—´)ì„ ë§Œì¡±í–ˆìŠµë‹ˆë‹¤.`;

                renderResults(results);
            } catch (err) {
                console.error(err);
                progressEl.textContent = "ì—ëŸ¬ ë°œìƒ: " + err.message;
                resultBody.innerHTML = "";
            } finally {
                scanBtn.disabled = false;
            }
        }

        scanBtn.addEventListener("click", () => {
            runScan();
        });
    </script>
</body>
</html>
