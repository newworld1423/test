<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Binance 선물 1일봉 해머 스캐너</title>
    <style>
        :root { --bg:#0b1220; --fg:#eaeef7; --muted:#93a1b1; --accent:#4da3ff; }
        * { box-sizing: border-box; }
        body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; background:var(--bg); color:var(--fg); }
        header { position:sticky; top:0; background:#0b1220cc; backdrop-filter: blur(6px); border-bottom:1px solid #223; padding:12px 16px; z-index:10; }
        .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
        input, select, button, label { font-size:14px; }
        input, select, button { padding:10px 12px; border-radius:12px; border:1px solid #334; background:#111827; color:var(--fg); }
        button { background:var(--accent); color:#081018; border:0; font-weight:600; cursor:pointer; }
        button:disabled { opacity:0.6; cursor:not-allowed; }
        .wrap { padding:16px; }
        .hint { color:var(--muted); font-size:12px; }
        table { width:100%; border-collapse:collapse; }
        th, td { padding:10px 8px; border-bottom:1px solid #1e293b; font-size:14px; }
        th { position:sticky; top:110px; background:#0b1220; text-align:left; z-index:5; }
        .badge { padding:2px 8px; border-radius:999px; background:#13263b; color:#a7e1ff; font-size:12px; }
        .ok { color:#5cf1a6; }
        .err { color:#ff6b6b; }
        .right { text-align:right; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
        #metaSummary { margin-top:6px; font-size:12px; color:#cbe4ff; }
        @media (max-width: 860px) {
            th:nth-child(4), td:nth-child(4) { display:none; } /* 하단/몸통 비율 컬럼 모바일에서 숨김 */
        }
    </style>
</head>
<body>
<header>
    <div class="row">
        <label><input type="checkbox" id="backtest" /> 과거 백테스팅</label>
        <input type="date" id="dateInput" disabled />
        <select id="sortBy" title="정렬 기준">
            <option value="pctDesc">% 변화(내림차순)</option>
            <option value="ratioDesc">하단/몸통 비율(내림차순)</option>
            <option value="volDesc">직전봉 volume(내림차순)</option>
            <option value="txnDesc">직전봉 txn(내림차순)</option>
            <option value="symAsc">심볼 (A→Z)</option>
        </select>
        <input type="text" id="symbolFilter" placeholder="심볼 필터 (예: BTC, SOL)" />
        <button id="scanBtn">스캔</button>
        <span id="status" class="hint"></span>
    </div>
    <div class="hint" style="margin-top:6px">
        * 1일봉 UTC 00:00(한국 09:00 전환) · 해머: <span class="mono">아래꼬리 ≥ 2 × 몸통</span> · volume/txn은 <b>직전봉</b> 값
    </div>
    <div id="metaSummary"></div>
</header>

<div class="wrap">
    <table id="resultTable">
        <thead>
            <tr>
                <th>심볼</th>
                <th>체크일(UTC)</th>
                <th>직전봉(해머)</th>
                <th class="right">하단/몸통</th>
                <th class="right">체크일 시가</th>
                <th class="right">체크일 종가</th>
                <th class="right">% 변화</th>
                <th class="right">직전봉 volume</th>
                <th class="right">직전봉 txn</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    // ---------- 유틸 ----------
    function toUTCDateStr(ms) {
        const d = new Date(ms);
        const y = d.getUTCFullYear();
        const m = String(d.getUTCMonth() + 1).padStart(2, "0");
        const day = String(d.getUTCDate()).padStart(2, "0");
        return `${y}-${m}-${day}`;
    }
    function dateToUTCStartMs(localDateStr) {
        const [y, m, d] = localDateStr.split("-").map(Number);
        return Date.UTC(y, m - 1, d, 0, 0, 0, 0);
    }
    function pct(curr, base) {
        return base === 0 ? 0 : ((curr - base) / base) * 100;
    }
    function fmt(n, digits = 2) {
        return Number.isFinite(n) ? n.toFixed(digits) : "-";
    }
    function fmtInt(n) {
        if (!Number.isFinite(n)) return "-";
        return Math.round(n).toLocaleString("ko-KR");
    }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
    function debounce(fn, wait = 200) {
        let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); };
    }

    // ---------- Binance API ----------
    const API_INFO = "https://fapi.binance.com/fapi/v1/exchangeInfo";
    const API_K = "https://fapi.binance.com/fapi/v1/klines";

    async function getUsdtPerpSymbols() {
        const res = await fetch(API_INFO);
        if (!res.ok) throw new Error("exchangeInfo 오류");
        const data = await res.json();
        return data.symbols
            .filter(s => s.status === "TRADING" && s.quoteAsset === "USDT" && s.contractType === "PERPETUAL")
            .map(s => s.symbol);
    }

    async function getDailyTwoCandles(symbol, targetUTCStartMs) {
        const startTime = targetUTCStartMs - 24 * 60 * 60 * 1000; // 전일 00:00Z
        const url = `${API_K}?symbol=${symbol}&interval=1d&startTime=${startTime}&limit=2`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`klines 오류: ${symbol}`);
        const arr = await res.json();
        return arr.map(k => ({
            openTime: k[0],
            open: parseFloat(k[1]),
            high: parseFloat(k[2]),
            low: parseFloat(k[3]),
            close: parseFloat(k[4]),
            volume: parseFloat(k[5]),           // base asset volume
            closeTime: k[6],
            quoteVolume: parseFloat(k[7]),
            numberOfTrades: parseInt(k[8], 10)  // txn
        }));
    }

    // 해머 정의: 아래꼬리 ≥ 2 × 몸통
    function isHammer(prev) {
        const body = Math.abs(prev.close - prev.open);
        const lower = Math.min(prev.open, prev.close) - prev.low;
        return body > 0 && lower >= 2 * body;
    }

    // ---------- 스캔 ----------
    async function scan({ targetDateUTCStartMs, symbols, concurrency = 10, signal }) {
        const results = [];

        // 전체 코인 직전봉 등락률 집계용
        let prevSumPct = 0;
        let prevCount = 0;

        let done = 0;
        async function worker(sym) {
            if (signal?.aborted) return;
            try {
                const candles = await getDailyTwoCandles(sym, targetDateUTCStartMs);
                if (candles.length < 2) return;
                const [prev, target] = candles;

                // 전체코인 직전봉 등락률 집계
                const prevChg = pct(prev.close, prev.open);
                if (Number.isFinite(prevChg)) {
                    prevSumPct += prevChg;
                    prevCount += 1;
                }

                // 직전봉 해머인 경우 결과 수집
                if (isHammer(prev)) {
                    const body = Math.abs(prev.close - prev.open);
                    const lower = Math.min(prev.open, prev.close) - prev.low;
                    const ratio = lower / body;

                    results.push({
                        symbol: sym,
                        checkDate: toUTCDateStr(targetDateUTCStartMs),
                        prevDate: toUTCDateStr(prev.openTime),
                        open: target.open,
                        close: target.close,
                        changePct: pct(target.close, target.open), // 체크일 등락률
                        ratio,
                        volumePrev: prev.volume,                    // 직전봉 volume
                        txnPrev: prev.numberOfTrades               // 직전봉 txn
                    });
                }
            } catch (e) {
                // 심볼별 오류는 스킵
            } finally {
                done++;
                document.getElementById("status").textContent = `진행: ${done}/${symbols.length}`;
            }
        }

        const queue = [...symbols];
        const runners = Array.from({ length: concurrency }).map(async () => {
            while (queue.length) {
                const sym = queue.shift();
                await worker(sym);
                await sleep(60); // 과요청 방지
            }
        });
        await Promise.all(runners);

        const meta = {
            avgPrevAll: prevCount ? (prevSumPct / prevCount) : NaN,
            nPrevAll: prevCount
        };
        return { results, meta };
    }

    // ---------- UI 상태 ----------
    const backtestEl = document.getElementById("backtest");
    const dateEl = document.getElementById("dateInput");
    const scanBtn = document.getElementById("scanBtn");
    const sortByEl = document.getElementById("sortBy");
    const filterEl = document.getElementById("symbolFilter");
    const tbody = document.querySelector("#resultTable tbody");
    const metaSummaryEl = document.getElementById("metaSummary");

    let lastScan = [];            // 마지막 스캔 원본(해머 대상들)
    let lastMeta = null;          // 마지막 메타(전체코인 직전봉 평균 등)
    let lastTotalSymbols = 0;     // 상태표시용
    let aborter = null;

    backtestEl.addEventListener("change", () => {
        dateEl.disabled = !backtestEl.checked;
        updateMetaSummary(); // 표시/숨김 갱신
    });

    sortByEl.addEventListener("change", updateView);
    filterEl.addEventListener("input", debounce(updateView, 150));
    scanBtn.addEventListener("click", startScan);

    function getTargetUTCStartMs() {
        if (backtestEl.checked && dateEl.value) {
            return dateToUTCStartMs(dateEl.value);
        } else {
            const now = new Date();
            return Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate());
        }
    }

    function renderRows(rows) {
        tbody.innerHTML = "";
        for (const r of rows) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><span class="badge">USDT</span> ${r.symbol}</td>
                <td class="mono">${r.checkDate}</td>
                <td><span class="ok">해머</span> <span class="hint mono">(${r.prevDate})</span></td>
                <td class="right mono">${Number.isFinite(r.ratio) ? r.ratio.toFixed(2) + "×" : "-"}</td>
                <td class="right mono">${fmt(r.open, 4)}</td>
                <td class="right mono">${fmt(r.close, 4)}</td>
                <td class="right mono">${fmt(r.changePct, 2)}%</td>
                <td class="right mono">${fmt(r.volumePrev, 2)}</td>
                <td class="right mono">${fmtInt(r.txnPrev)}</td>
            `;
            tbody.appendChild(tr);
        }
    }

    function applySortAndFilter(arr) {
        const key = sortByEl.value;
        const term = filterEl.value.trim().toUpperCase();
        let out = arr.slice();

        if (term) out = out.filter(r => r.symbol.includes(term));

        if (key === "pctDesc") {
            out.sort((a, b) => b.changePct - a.changePct);
        } else if (key === "ratioDesc") {
            out.sort((a, b) => (b.ratio ?? -Infinity) - (a.ratio ?? -Infinity));
        } else if (key === "volDesc") {
            out.sort((a, b) => (b.volumePrev ?? -Infinity) - (a.volumePrev ?? -Infinity));
        } else if (key === "txnDesc") {
            out.sort((a, b) => (b.txnPrev ?? -Infinity) - (a.txnPrev ?? -Infinity));
        } else if (key === "symAsc") {
            out.sort((a, b) => a.symbol.localeCompare(b.symbol));
        }
        return out;
    }

    function updateMetaSummary() {
        if (backtestEl.checked && lastMeta && Number.isFinite(lastMeta.avgPrevAll)) {
            metaSummaryEl.textContent =
                `백테스트 요약 · 전체코인 직전봉 평균 변화: ${fmt(lastMeta.avgPrevAll, 2)}% (N=${lastMeta.nPrevAll})`;
        } else {
            metaSummaryEl.textContent = "";
        }
    }

    function updateView() {
        if (!lastScan.length) return;
        const rows = applySortAndFilter(lastScan);
        renderRows(rows);
        document.getElementById("status").textContent =
            `완료: ${rows.length}개 해머 발견 (총 ${lastTotalSymbols || rows.length})`;
        updateMetaSummary();
    }

    async function startScan() {
        scanBtn.disabled = true;
        tbody.innerHTML = "";
        metaSummaryEl.textContent = "";
        document.getElementById("status").textContent = "심볼 불러오는 중…";

        try {
            const symbols = await getUsdtPerpSymbols();
            const targetUTC = getTargetUTCStartMs();
            aborter = new AbortController();

            document.getElementById("status").textContent = `총 ${symbols.length}개 심볼 스캔 중…`;

            const { results, meta } = await scan({
                targetDateUTCStartMs: targetUTC,
                symbols,
                concurrency: 10,
                signal: aborter.signal
            });

            lastScan = results;
            lastMeta = meta;
            lastTotalSymbols = symbols.length;
            updateView(); // 정렬/필터 적용 + 요약 표시
        } catch (e) {
            document.getElementById("status").innerHTML = `<span class="err">오류: ${e.message}</span>`;
        } finally {
            scanBtn.disabled = false;
        }
    }
</script>
</body>
</html>
