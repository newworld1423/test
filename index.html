<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>15분봉 공동 방향 뷰어 — 96행(09:00 시작) 고정</title>
    <style>
        :root { --bg:#0b0f16; --panel:#121826; --muted:#9aa4b2; --text:#e5e7eb; --accent:#60a5fa; --pos:#16a34a; --neg:#ef4444; --grid:#1f2937; }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial}
        header{padding:20px 24px;border-bottom:1px solid var(--grid);position:sticky;top:0;background:linear-gradient(180deg,rgba(11,15,22,.95),rgba(11,15,22,.85));backdrop-filter:blur(8px)}
        h1{margin:0 0 4px;font-size:20px}
        .sub{color:var(--muted);font-size:13px}
        main{padding:18px 24px 48px}
        .panel{background:var(--panel);border:1px solid var(--grid);border-radius:16px;padding:16px}
        .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
        .grow{flex:1 1 240px}
        input[type=file]{width:100%;padding:10px;border:1px dashed var(--grid);background:transparent;color:var(--muted);border-radius:12px}
        .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--grid);background:#0f172a;color:var(--text);cursor:pointer}
        .btn.primary{background:var(--accent);color:#0b0f16;border-color:transparent;font-weight:700}
        .btn.ghost{background:transparent}
        .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--grid);color:var(--muted)}
        .grid{display:grid;gap:12px;grid-template-columns:1fr}
        @media(min-width:1100px){.grid{grid-template-columns:380px 1fr}}
        .list{max-height:140px;overflow:auto;border:1px solid var(--grid);border-radius:12px;padding:8px;font-size:13px;background:#0d1320}
        .list div{padding:6px 8px;border-radius:8px}
        .list div:hover{background:rgba(96,165,250,.12)}
        .tabs{display:flex;gap:8px;margin-top:16px}
        .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--grid);background:#0e1524;cursor:pointer;font-size:13px;color:var(--muted)}
        .tab.active{border-color:var(--accent);color:#fff;box-shadow:0 0 0 1px inset rgba(96,165,250,.35)}
        .views>section{display:none}
        .views>section.active{display:block}
        table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px}
        thead th{position:sticky;top:0;background:#0f172a;z-index:1;text-align:left;padding:8px 10px;border-bottom:1px solid var(--grid);font-weight:700}
        tbody td{padding:8px 10px;border-bottom:1px solid var(--grid)}
        tbody tr:hover{background:rgba(148,163,184,.08)}
        .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
        .pos{color:var(--pos)}
        .neg{color:var(--neg)}
        .muted{color:var(--muted)}
        .caps{text-transform:uppercase;letter-spacing:.02em}
        .right{text-align:right}
        .scroll{overflow:auto;max-height:68vh;border:1px solid var(--grid);border-radius:12px}
        .footer{margin-top:16px;display:flex;gap:10px;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px}
        .controls{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .cell{background:#0d1320;border:1px solid var(--grid);border-radius:12px;padding:10px}
        label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
        input[type=number],select{width:100%;padding:8px 10px;border:1px solid var(--grid);background:#0b0f16;color:var(--text);border-radius:10px}
        .tag{display:inline-flex;gap:6px;align-items:center;padding:3px 8px;border-radius:999px;border:1px solid var(--grid);font-size:12px}
        .tag.up{color:var(--pos);border-color:rgba(34,197,94,.35)}
        .tag.down{color:var(--neg);border-color:rgba(239,68,68,.35)}
        .tag.flat{color:var(--muted);border-color:rgba(148,163,184,.35)}
        .status{font-weight:700;padding:2px 8px;border-radius:8px}
        .status.allup{background:rgba(34,197,94,.15);color:var(--pos)}
        .status.alldown{background:rgba(239,68,68,.15);color:var(--neg)}
        .status.mixed{background:rgba(96,165,250,.15);color:#fff}
        .status.allflat{background:rgba(148,163,184,.15);color:var(--muted)}
    </style>
</head>
<body>
<header>
    <h1>15분봉 공동 방향 뷰어</h1>
    <div class="sub">행은 항상 <b>96개(09:00 → 08:45)</b> 고정. 각 행 값은 그날의 <b>09:00 시가(B2)</b> 기준 <b>(Dn - B2)/B2</b> (%)입니다. 실제 시간 누락/불일치와 무관하게 슬롯에 매핑합니다.</div>
</header>

<main class="grid">
    <section class="panel" id="controls">
        <div class="row">
            <div class="grow">
                <label class="sub">CSV 파일 선택 (여러 개 가능)</label>
                <input id="fileInput" type="file" accept=".csv" multiple>
            </div>
            <button id="loadBtn" class="btn primary">분석하기</button>
            <button id="clearBtn" class="btn ghost">초기화</button>
        </div>
        <div style="height:12px"></div>
        <div class="row">
            <span class="badge">타임존: Asia/Seoul (UTC+9)</span>
            <span class="badge">기준: 09:00 시가(B2)</span>
            <span class="badge" id="countBadge">파일 0개</span>
        </div>
        <div style="height:12px"></div>
        <div class="controls">
            <div class="cell">
                <label class="small">무시 임계값 ε (절대값 % &lt; ε → 보합)</label>
                <input id="epsilon" type="number" step="0.01" min="0" value="0.10">
            </div>
            <div class="cell">
                <label class="small">필터</label>
                <select id="statusFilter">
                    <option value="all">전체</option>
                    <option value="allup">같이 상승 (모두 +)</option>
                    <option value="alldown">같이 하락 (모두 -)</option>
                    <option value="allflat">모두 보합 (±ε)</option>
                    <option value="mixed">혼조 (섞임)</option>
                </select>
            </div>
        </div>
        <div style="height:12px"></div>
        <div>
            <div class="sub">선택된 파일</div>
            <div id="fileList" class="list"></div>
        </div>
    </section>

    <section class="panel">
        <div class="tabs">
            <button class="tab active" data-view="summaryView">공동 방향 표</button>
            <button class="tab" data-view="pivotView">피벗 (증감률만)</button>
        </div>
        <div class="views">
            <section id="summaryView" class="active">
                <div class="scroll">
                    <table>
                        <thead>
                            <tr>
                                <th style="min-width:120px">시각 (슬롯)</th>
                                <th>상태</th>
                                <th>요약</th>
                                <th>상세 (심볼: 증감률%)</th>
                            </tr>
                        </thead>
                        <tbody id="sumBody"></tbody>
                    </table>
                </div>
                <div class="footer">
                    <div>ε를 조정해 미세한 변동을 보합으로 처리할 수 있어요.</div>
                    <button id="downloadSummary" class="btn">CSV로 저장 (공동 방향)</button>
                </div>
            </section>
            <section id="pivotView">
                <div class="scroll">
                    <table>
                        <thead id="pivotHead"></thead>
                        <tbody id="pivotBody"></tbody>
                    </table>
                </div>
                <div class="footer">
                    <div>행=슬롯(09:00 시작 96개), 열=심볼, 값=09:00 시가 대비%</div>
                    <button id="downloadPivot" class="btn">CSV로 저장 (피벗)</button>
                </div>
            </section>
        </div>
    </section>
</main>

<script>
// ========= 유틸 =========
function parseSymbolFromFilename(name){
    var base = name.replace(/\.[^.]+$/,'');
    var dash = base.indexOf('-');
    return (dash > 0 ? base.slice(0, dash) : base).toUpperCase();
}
function getSeriesLabel(name){
    return name.replace(/\.[^.]+$/,'').toUpperCase();
}
function toEpochMs(x){
    var n = Number(x);
    if (!isFinite(n)) return NaN;
    return n < 1e11 ? n * 1000 : n; // 초 → ms
}
function parseCSV(text){
    var lines = text.trim().split(/\r?\n/);
    var rows = [];
    for (var i=0;i<lines.length;i++){
        var cols = lines[i].split(',');
        if (cols.length < 12) continue;
        rows.push({
            open_time: toEpochMs(cols[0]),
            open: Number(cols[1]),
            high: Number(cols[2]),
            low: Number(cols[3]),
            close: Number(cols[4]),
            volume: Number(cols[5]),
            close_time: toEpochMs(cols[6]),
            trades: Number(cols[8])
        });
    }
    return rows;
}
function kstDateAndHHMM(ms){
    var d = new Date(ms + 9*3600*1000);
    var yyyy = d.getUTCFullYear();
    var mm = ('0'+(d.getUTCMonth()+1)).slice(-2);
    var dd = ('0'+d.getUTCDate()).slice(-2);
    var hh = ('0'+d.getUTCHours()).slice(-2);
    var mi = ('0'+d.getUTCMinutes()).slice(-2);
    return { date:`${yyyy}-${mm}-${dd}`, hhmm:`${hh}:${mi}` };
}
function fmt(n,d){
    if (n==null || isNaN(n)) return '';
    return Number(n).toLocaleString(undefined,{maximumFractionDigits:d, minimumFractionDigits:d});
}
function classifyStatus(pcts, eps){
    var up=0,down=0,flat=0,total=0;
    for (var i=0;i<pcts.length;i++){
        var v=pcts[i]; if (v==null) continue; total++;
        var a=Math.abs(v);
        if (a<eps) flat++; else if (v>0) up++; else down++;
    }
    var status='mixed';
    if (total===flat) status='allflat';
    else if (up>0 && down===0 && flat===0) status='allup';
    else if (down>0 && up===0 && flat===0) status='alldown';
    return {up,down,flat,total,status};
}
function downloadCSV(filename,rows){
    if(!rows.length) return;
    var headers = Object.keys(rows[0]);
    var esc = v => v==null? '' : (String(v).includes(',')? '"' + String(v).replace(/"/g,'""') + '"' : String(v));
    var csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(','))).join('\n');
    var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a'); a.href=url; a.download=filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),3000);
}
function clockToMinutes(hhmm){
    var p=(hhmm||'00:00').split(':'), h=parseInt(p[0],10)||0, m=parseInt(p[1],10)||0;
    return h*60+m;
}

// === 96개 슬롯(09:00 시작) 생성 ===
function allHHMM15From0900(){
    var out=[];
    for (var i=0;i<96;i++){
        var mins = (540 + i*15) % 1440; // 540 = 09:00
        var h = Math.floor(mins/60), m = mins%60;
        out.push(('0'+h).slice(-2)+':'+('0'+m).slice(-2));
    }
    return out;
}
// HH:MM → 슬롯 인덱스(0~95), 09:00을 0으로
function slotIndexFromHHMM(hhmm){
    var idx = Math.floor(((clockToMinutes(hhmm) - 540 + 1440) % 1440) / 15);
    return idx; // 0..95
}

// ========= 상태/DOM =========
var state={ files:[], symbols:[], times:[], map:new Map(), counts:new Map() };

var fileInput=document.getElementById('fileInput');
var fileList=document.getElementById('fileList');
var countBadge=document.getElementById('countBadge');
var loadBtn=document.getElementById('loadBtn');
var clearBtn=document.getElementById('clearBtn');
var epsilonEl=document.getElementById('epsilon');
var statusFilterEl=document.getElementById('statusFilter');
var sumBody=document.getElementById('sumBody');
var pivotHead=document.getElementById('pivotHead');
var pivotBody=document.getElementById('pivotBody');
var downloadSummary=document.getElementById('downloadSummary');
var downloadPivot=document.getElementById('downloadPivot');
var tabs=document.querySelectorAll('.tab');
var views=document.querySelectorAll('.views > section');

// ========= 이벤트 =========
fileInput.addEventListener('change',function(){
    state.files=[...(fileInput.files||[])];
    fileList.innerHTML=state.files.map(f=>`<div>${f.name} <span class="muted">(${(f.size/1024).toFixed(1)} KB)</span></div>`).join('');
    countBadge.textContent=`파일 ${state.files.length}개`;
});
clearBtn.addEventListener('click',function(){
    state={ files:[], symbols:[], times:[], map:new Map(), counts:new Map() };
    fileInput.value=''; fileList.innerHTML=''; countBadge.textContent='파일 0개';
    sumBody.innerHTML=''; pivotHead.innerHTML=''; pivotBody.innerHTML='';
});
loadBtn.addEventListener('click',runAnalysis);
epsilonEl.addEventListener('change',renderAll);
statusFilterEl.addEventListener('change',renderSummary);
tabs.forEach(btn=>btn.addEventListener('click',function(){
    tabs.forEach(b=>b.classList.remove('active'));
    views.forEach(v=>v.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.getAttribute('data-view')).classList.add('active');
}));
downloadSummary.addEventListener('click',downloadSummaryCSV);
downloadPivot.addEventListener('click',downloadPivotCSV);

// ========= 핵심 로직 =========
// 요구사항: 시간은 재지 않고, 96행(09:00 시작 15분 간격) 고정.
// 각 날짜별로 B2(09:00 시가 또는 09:00 이후 첫 봉 시가)를 잡고, 그날의 모든 봉 close를 해당 슬롯에 매핑하여 (Dn-B2)/B2 계산.
function runAnalysis(){
    if(!state.files.length){ alert('CSV 파일을 선택해 주세요.'); return; }

    var symbolsSet = new Set();
    var times96 = allHHMM15From0900(); // 표시할 고정 슬롯 라벨 (길이 96)
    var map = new Map();   // 슬롯라벨 -> { SYMBOL: 평균값 }
    var counts = new Map();// 슬롯라벨 -> { SYMBOL: 샘플수 }

    // 슬롯 초기화
    times96.forEach(t => { map.set(t, {}); counts.set(t, {}); });

    var promises = state.files.map(file => file.text().then(text => {
        var series = getSeriesLabel(file.name); symbolsSet.add(series);
        var arr = parseCSV(text);

        // 날짜별로 모으기
        var byDate = new Map(); // date -> [{ open_time, open, close, hhmm }]
        for (var i=0;i<arr.length;i++){
            var o=arr[i]; var k=kstDateAndHHMM(o.open_time);
            if(!byDate.has(k.date)) byDate.set(k.date,[]);
            byDate.get(k.date).push({ open_time:o.open_time, open:o.open, close:o.close, hhmm:k.hhmm });
        }

        byDate.forEach(list => {
            // 시간순 정렬
            list.sort((a,b)=>(a.hhmm<b.hhmm?-1:a.hhmm>b.hhmm?1:(a.open_time-b.open_time)));

            // B2(09:00 시가 또는 09:00 이후 첫 봉 시가)
            var baseOpen = null;
            for (var j=0;j<list.length;j++){
                if (list[j].hhmm==='09:00'){ baseOpen=list[j].open; break; }
            }
            if (baseOpen==null){
                for (var j2=0;j2<list.length;j2++){
                    if (clockToMinutes(list[j2].hhmm) >= 9*60){ baseOpen=list[j2].open; break; }
                }
            }
            if (!(baseOpen!=null && baseOpen!==0)) return;

            // 그날의 모든 봉을 슬롯(0~95)에 매핑 → (Dn-B2)/B2
            for (var k=0;k<list.length;k++){
                var it=list[k];
                var slotIdx = slotIndexFromHHMM(it.hhmm);
                var slotLabel = times96[slotIdx];
                var pct = ((it.close - baseOpen)/baseOpen)*100;

                var agg = map.get(slotLabel);
                var cnt = counts.get(slotLabel);
                var prev = agg[series];
                var n = cnt[series] || 0;
                agg[series] = (prev==null)? pct : (prev*n + pct)/(n+1);
                cnt[series] = n+1;
            }
        });
    }));

    Promise.all(promises).then(()=>{
        state.symbols = Array.from(symbolsSet).sort();
        state.times = times96;   // 96행 고정
        state.map = map;
        state.counts = counts;
        renderAll();
    });
}

// ========= 렌더링 =========
function renderAll(){
    renderSummary();
    renderPivot();
}
function renderSummary(){
    var eps = Math.max(0, Number(epsilonEl.value)||0);
    var filter = statusFilterEl.value;
    var frag=document.createDocumentFragment(); sumBody.innerHTML='';

    state.times.forEach(function(t){
        var entry = state.map.get(t)||{};
        var cnts = state.counts.get(t)||{};
        var pcts = state.symbols.map(s => entry[s]!=null? entry[s]:null);
        var cls = classifyStatus(pcts, eps);
        if (filter!=='all' && cls.status!==filter) return;

        var tr=document.createElement('tr');
        var statusText = (cls.status==='allup'?'같이 상승':cls.status==='alldown'?'같이 하락':cls.status==='allflat'?'모두 보합':'혼조');
        var statusHtml = `<span class="status ${cls.status}">${statusText}</span>`;
        var summaryHtml = `<span class="tag up">상승 ${cls.up}</span> <span class="tag down">하락 ${cls.down}</span> <span class="tag flat">보합 ${cls.flat}</span> <span class="tag">총 ${cls.total}</span>`;

        var details = state.symbols.map(function(s){
            var v=entry[s]; var n=cnts[s]||0;
            var dcls=(v==null)?'muted':(Math.abs(v)<eps?'muted':(v>=0?'pos':'neg'));
            var tip=n?` title="샘플 ${n}개 평균"`:'';
            return `<span class="caps ${dcls}"${tip}>${s}</span>: <span class="mono ${dcls}">${v==null?'':fmt(v,3)}</span>%`;
        }).join(' &nbsp; | &nbsp; ');

        tr.innerHTML = `<td class="mono">${t}</td><td>${statusHtml}</td><td>${summaryHtml}</td><td>${details}</td>`;
        frag.appendChild(tr);
    });
    sumBody.appendChild(frag);
}
function renderPivot(){
    var eps = Math.max(0, Number(epsilonEl.value)||0);
    var ths = ['<th style="min-width:120px">시각(슬롯)</th>'].concat(state.symbols.map(s=>`<th class="right caps">${s}</th>`)).join('');
    pivotHead.innerHTML = `<tr>${ths}</tr>`;

    var frag=document.createDocumentFragment(); pivotBody.innerHTML='';
    state.times.forEach(function(t){
        var entry=state.map.get(t)||{}; var cnts=state.counts.get(t)||{};
        var tds=[`<td class="mono">${t}</td>`];
        state.symbols.forEach(function(s){
            var v=entry[s]; var n=cnts[s]||0;
            var cls=(v==null)?'muted':(Math.abs(v)<eps?'muted':(v>=0?'pos':'neg'));
            var td=document.createElement('td');
            td.className='right mono '+cls;
            if (v!=null) td.setAttribute('data-pct', v.toFixed(6));
            if (n) td.title=`샘플 ${n}개 평균`;
            td.innerHTML=`<span>${v==null?'':fmt(v,3)}</span>`;
            tds.push(td.outerHTML);
        });
        var tr=document.createElement('tr'); tr.innerHTML=tds.join(''); frag.appendChild(tr);
    });
    pivotBody.appendChild(frag);
}

// ========= CSV 내보내기 =========
function downloadSummaryCSV(){
    var eps=Math.max(0, Number(epsilonEl.value)||0); var out=[];
    state.times.forEach(function(t){
        var entry=state.map.get(t)||{}; var pcts=state.symbols.map(s=>entry[s]!=null?entry[s]:null);
        var cls=classifyStatus(pcts,eps);
        var row={ slot:t, status:cls.status, up:cls.up, down:cls.down, flat:cls.flat, total:cls.total };
        state.symbols.forEach(function(s){ row[s]=entry[s]!=null? Number(entry[s].toFixed(6)) : ''; });
        out.push(row);
    });
    downloadCSV('comove_summary_by_slots.csv', out);
}
function downloadPivotCSV(){
    var out=[];
    state.times.forEach(function(t){
        var entry=state.map.get(t)||{}; var row={ slot:t };
        state.symbols.forEach(function(s){ row[s]=entry[s]!=null? Number(entry[s].toFixed(6)) : ''; });
        out.push(row);
    });
    downloadCSV('pivot_changes_by_slots.csv', out);
}
</script>
</body>
</html>
