<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Binance USDT-PERP 50EMA 크로스 스캐너 (1D)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root { --bg:#0b1220; --fg:#e8eefc; --muted:#9fb0d0; --accent:#6ab0ff; --ok:#35c46a; --bad:#ff6a6a; }
        body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Helvetica, Arial; background:var(--bg); color:var(--fg); }
        header { padding: 20px; border-bottom: 1px solid #1b2742; }
        h1 { margin:0 0 8px; font-size: 20px; }
        p.note { margin:6px 0 0; color:var(--muted); font-size: 13px; }
        main { padding: 16px 20px 60px; max-width: 1200px; }
        .controls { display: grid; grid-template-columns: repeat(4, minmax(180px, 1fr)); gap: 10px; margin-bottom: 12px; }
        .controls > div { background:#0f1a33; border:1px solid #1b2742; border-radius:12px; padding:12px; }
        label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
        input, select, button { width:100%; box-sizing:border-box; border-radius:8px; border:1px solid #2a3b63; background:#0b172f; color:var(--fg); padding:10px 12px; font-size:14px; }
        button.primary { background:linear-gradient(180deg,#1e86ff,#1063cf); border:0; cursor:pointer; }
        button.secondary { background:#142449; border:1px solid #2a3b63; cursor:pointer; }
        .row { display:flex; gap:10px; align-items:center; margin: 14px 0; }
        .progress { height:10px; background:#122043; border-radius:999px; overflow:hidden; border:1px solid #213362; }
        .bar { height:100%; width:0%; background:linear-gradient(90deg,#37a8ff,#6ab0ff); transition:width .2s ease; }
        table { width:100%; border-collapse: collapse; margin-top: 12px; }
        th, td { padding:10px 12px; border-bottom: 1px solid #1b2742; text-align:left; font-size:14px; }
        th { position: sticky; top:0; background:#0f1a33; z-index:1; }
        .pill { font-size: 12px; padding:3px 8px; border-radius:999px; border:1px solid #2a3b63; color:var(--muted); }
        .ok { color:var(--ok); }
        .bad { color:var(--bad); }
        .small { font-size:12px; color:var(--muted); }
        footer { position:fixed; inset:auto 0 0 0; background:#0f1a33; border-top:1px solid #1b2742; padding:10px 20px; display:flex; gap:10px; align-items:center; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; }
        .right { margin-left:auto; display:flex; gap:10px; }
        .hint { color:var(--muted); font-size:12px; }
        .nowrap { white-space: nowrap; }
    </style>
</head>
<body>
<header>
    <h1>Binance USDT-PERP 50EMA 크로스 스캐너 (1D)</h1>
    <p class="note">조건: ① 2봉 전 종가 &lt; 50EMA ② 1봉 전 종가 &gt; 50EMA (1일봉 기준). 바이낸스 선물 API를 사용합니다.</p>
</header>
<main>
    <section class="controls">
        <div>
            <label>EMA 길이</label>
            <input id="emaLength" type="number" value="50" min="2" />
            <div class="hint">기본 50EMA</div>
        </div>
        <div>
            <label>Kline 개수 (limit)</label>
            <input id="klineLimit" type="number" value="200" min="60" />
            <div class="hint">최소 EMA길이 + 2 이상 권장</div>
        </div>
        <div>
            <label>동시 요청 개수</label>
            <input id="concurrency" type="number" value="5" min="1" max="20" />
            <div class="hint">레이트 리밋 보호</div>
        </div>
        <div>
            <label>심볼 필터(포함, 선택)</label>
            <input id="symbolFilter" placeholder="예: BTC,ETH,SOL (비워두면 전체)" />
            <div class="hint">쉼표로 여러 개</div>
        </div>
    </section>

    <div class="row">
        <button id="scanBtn" class="primary">스캔 시작</button>
        <button id="stopBtn" class="secondary">중지</button>
        <span id="status" class="small">준비됨</span>
    </div>

    <div class="row">
        <div class="progress" style="flex:1;">
            <div class="bar" id="bar"></div>
        </div>
        <span id="progText" class="small nowrap">0 / 0</span>
    </div>

    <table id="resultTable">
        <thead>
            <tr>
                <th>심볼</th>
                <th>2봉 전 종가</th>
                <th>2봉 전 50EMA</th>
                <th>1봉 전 종가</th>
                <th>1봉 전 50EMA</th>
                <th>조건 충족</th>
                <th>비고</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</main>

<footer>
    <span class="hint">출처: Binance Futures API (1d)</span>
    <div class="right">
        <button id="exportBtn" class="secondary">CSV 내보내기</button>
    </div>
</footer>

<script>
    // ======= 설정값 / DOM =======
    const API = "https://fapi.binance.com";
    const $scanBtn = document.getElementById('scanBtn');
    const $stopBtn = document.getElementById('stopBtn');
    const $emaLength = document.getElementById('emaLength');
    const $klineLimit = document.getElementById('klineLimit');
    const $concurrency = document.getElementById('concurrency');
    const $symbolFilter = document.getElementById('symbolFilter');
    const $status = document.getElementById('status');
    const $bar = document.getElementById('bar');
    const $progText = document.getElementById('progText');
    const $tbody = document.querySelector('#resultTable tbody');
    const $exportBtn = document.getElementById('exportBtn');

    let abortFlag = false;
    let lastResults = [];

    // ======= 유틸 =======
    function sleep(ms) {
        return new Promise(res => setTimeout(res, ms));
    }

    function toCSV(rows) {
        const esc = (v) => {
            if (v == null) return '';
            const s = String(v);
            if (s.includes('"') || s.includes(',') || s.includes('\n')) {
                return `"${s.replace(/"/g, '""')}"`;
            }
            return s;
        };
        const header = ["symbol","close_2","ema_2","close_1","ema_1","match","note"];
        const lines = [header.join(',')];
        for (const r of rows) {
            lines.push([r.symbol, r.close2, r.ema2, r.close1, r.ema1, r.match, r.note || ""].map(esc).join(','));
        }
        return lines.join('\n');
    }

    function downloadText(filename, text) {
        const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    function addRow(r) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="mono">${r.symbol}</td>
            <td>${Number(r.close2).toFixed(6)}</td>
            <td>${Number(r.ema2).toFixed(6)}</td>
            <td>${Number(r.close1).toFixed(6)}</td>
            <td>${Number(r.ema1).toFixed(6)}</td>
            <td class="${r.match ? 'ok' : 'bad'}">${r.match ? '충족' : '불충족'}</td>
            <td class="small">${r.note || ''}</td>
        `;
        $tbody.appendChild(tr);
    }

    function setProgress(done, total) {
        const pct = total ? Math.round(done * 100 / total) : 0;
        $bar.style.width = pct + '%';
        $progText.textContent = `${done} / ${total}`;
    }

    // ======= Binance API =======
    async function fetchUSDTPerpSymbols() {
        const url = `${API}/fapi/v1/exchangeInfo`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('exchangeInfo 실패: ' + res.status);
        const data = await res.json();
        // USDT QUOTE + PERPETUAL 컨트랙트 + TRADING 상태만
        const syms = data.symbols.filter(s =>
            s.quoteAsset === 'USDT' &&
            s.contractType === 'PERPETUAL' &&
            s.status === 'TRADING'
        ).map(s => s.symbol);

        return syms;
    }

    async function fetchKlines1D(symbol, limit) {
        const url = `${API}/fapi/v1/klines?symbol=${symbol}&interval=1d&limit=${limit}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`klines 실패(${symbol}): ` + res.status);
        const data = await res.json();
        // 배열: [openTime, open, high, low, close, volume, closeTime, ...]
        return data.map(row => ({
            openTime: row[0],
            open: Number(row[1]),
            high: Number(row[2]),
            low: Number(row[3]),
            close: Number(row[4]),
            closeTime: row[6]
        }));
    }

    // ======= EMA =======
    function ema(values, length) {
        if (values.length < length) return [];
        const k = 2 / (length + 1);
        const out = new Array(values.length);
        // 초기값: 첫 length개 SMA
        let sum = 0;
        for (let i = 0; i < length; i++) sum += values[i];
        out[length - 1] = sum / length;
        for (let i = length; i < values.length; i++) {
            out[i] = values[i] * k + out[i - 1] * (1 - k);
        }
        // 앞쪽 비어있는 부분은 undefined 유지
        return out;
    }

    // ======= 조건 검사 =======
    function checkCondition(candles, length) {
        const closes = candles.map(c => c.close);
        const e = ema(closes, length);
        const lastIdx = candles.length - 1;
        const iPrev = lastIdx - 1; // 1봉 전
        const iPrev2 = lastIdx - 2; // 2봉 전
        if (iPrev2 < 0 || !e[iPrev] || !e[iPrev2]) {
            return { ok: false, reason: '데이터 부족' };
        }
        const close2 = closes[iPrev2];
        const ema2 = e[iPrev2];
        const close1 = closes[iPrev];
        const ema1 = e[iPrev];

        const cond1 = close2 < ema2;
        const cond2 = close1 > ema1;

        return {
            ok: (cond1 && cond2),
            close2, ema2, close1, ema1
        };
    }

    // ======= 스캔 루프 =======
    async function scan() {
        abortFlag = false;
        $tbody.innerHTML = '';
        lastResults = [];
        $status.textContent = '심볼 목록 불러오는 중...';

        const limit = Math.max(parseInt($klineLimit.value, 10) || 200, 60);
        const emaLen = Math.max(parseInt($emaLength.value, 10) || 50, 2);
        const conc = Math.min(Math.max(parseInt($concurrency.value, 10) || 5, 1), 20);

        let symbols = await fetchUSDTPerpSymbols();

        // 사용자가 필터를 지정하면 해당 심볼만 스캔
        const filter = ($symbolFilter.value || '').trim();
        if (filter) {
            const picks = filter.split(',').map(s => s.trim().toUpperCase()).filter(Boolean);
            symbols = symbols.filter(sym => picks.some(p => sym.startsWith(p)));
        }

        const total = symbols.length;
        let done = 0;
        setProgress(0, total);
        $status.textContent = `스캔 시작: ${total} 종목`;

        // 간단한 작업 큐 (동시성 제한)
        const queue = [...symbols];
        const workers = new Array(conc).fill(0).map(() => worker());
        await Promise.all(workers);
        $status.textContent = `완료: ${lastResults.filter(r => r.match).length} 종목 조건 충족 / 총 ${total}`;

        async function worker() {
            while (queue.length && !abortFlag) {
                const sym = queue.shift();
                try {
                    const candles = await fetchKlines1D(sym, limit);
                    const res = checkCondition(candles, emaLen);
                    const row = {
                        symbol: sym,
                        close2: res.close2,
                        ema2: res.ema2,
                        close1: res.close1,
                        ema1: res.ema1,
                        match: !!res.ok,
                        note: res.ok ? '' : (res.reason || '')
                    };
                    lastResults.push(row);
                    if (row.match) addRow(row);
                } catch (e) {
                    const row = { symbol: sym, close2: '', ema2: '', close1: '', ema1: '', match: false, note: (e && e.message) ? e.message : '에러' };
                    lastResults.push(row);
                    // 에러는 표에는 추가하지 않음 (결과 정리 시 보려면 여기서 addRow(row)로 바꾸세요)
                } finally {
                    done += 1;
                    setProgress(done, total);
                    $status.textContent = `스캔 중... ${done}/${total}`;
                    // 너무 빠른 폭격 방지: 살짝 휴지
                    await sleep(50);
                }
            }
        }
    }

    // ======= 이벤트 =======
    $scanBtn.addEventListener('click', async () => {
        if ($scanBtn.disabled) return;
        $scanBtn.disabled = true;
        $stopBtn.disabled = false;
        try {
            await scan();
        } catch (e) {
            console.error(e);
            $status.textContent = '오류: ' + (e && e.message ? e.message : e);
        } finally {
            $scanBtn.disabled = false;
            $stopBtn.disabled = true;
        }
    });

    $stopBtn.addEventListener('click', () => {
        abortFlag = true;
        $status.textContent = '중지 요청됨';
    });

    $exportBtn.addEventListener('click', () => {
        if (!lastResults.length) {
            alert('내보낼 결과가 없습니다.');
            return;
        }
        const matched = lastResults.filter(r => r.match);
        const csv = toCSV(matched);
        const now = new Date();
        const ts = now.toISOString().slice(0,19).replace(/[:T]/g,'-');
        downloadText(`scanner_1d_ema${document.getElementById('emaLength').value}_${ts}.csv`, csv);
    });
</script>
</body>
</html>
