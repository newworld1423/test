<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>CSV 96슬롯 비교 (KST 09:00 시작)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg:#0b1020; --panel:#111831; --text:#e7ecff; --muted:#a6b0d4;
            --accent:#5b8cff; --pos:#12c48b; --neg:#ff6a6a; --border:#223057; --chip:#1a2445;
        }
        html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR;}
        .wrap{max-width:1200px;margin:24px auto;padding:0 16px;}
        .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;}
        .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        .muted{color:var(--muted);font-size:12px}
        button{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600}
        button.ghost{background:transparent;border:1px solid var(--border)}
        table{width:100%;border-collapse:collapse}
        th,td{border-bottom:1px solid var(--border);padding:10px 8px;text-align:right;font-variant-numeric:tabular-nums}
        th.left,td.left{text-align:left}
        .scroll{max-height:70vh;overflow:auto;border:1px solid var(--border);border-radius:12px}
        .pill{display:inline-block;padding:.15rem .5rem;border-radius:999px;background:var(--chip)}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
        .pos{color:var(--pos)} .neg{color:var(--neg)} .zero{color:var(--muted)}
        label{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0e1632}
    </style>
</head>
<body>
<div class="wrap">
    <div class="panel">
        <div class="row">
            <input id="fileInput" type="file" accept=".csv,text/csv" multiple />
            <button id="runBtn">분석</button>
            <button id="downloadBtn" class="ghost" disabled>CSV 다운로드</button>
        </div>
        <div class="row" style="margin-top:8px">
            <span class="muted">값 열 선택 (B=open, C=high, E=close)</span>
            <label><input type="radio" name="valcol" value="E" checked /> E: close(기본)</label>
            <label><input type="radio" name="valcol" value="C" /> C: high</label>
        </div>
        <p class="muted">• KST 기준 하루를 <b>09:00</b>에 시작(15분 × 96행). • (1) (Vₙ−B₂)/B₂, (2) (Vₙ−Bₙ)/Bₙ 표시 (V=선택한 값열).</p>
    </div>

    <div class="panel" style="margin-top:12px">
        <h3 style="margin:0 0 8px">비교 테이블 (KST 09:00~다음날 08:45)</h3>
        <div id="tableWrap" class="scroll"></div>
        <p id="meta" class="muted" style="margin-top:6px"></p>
    </div>
</div>

<script>
    // ====== 상수 ======
    const KST_OFFSET_MS = 9 * 60 * 60 * 1000;
    const SLOT_MIN = 15;                 // 15분
    const SLOT_COUNT = 96;               // 24h / 15m
    const DAY_START_MIN = 9 * 60;        // 09:00

    // 09:00부터 96칸 라벨
    function buildSlotLabels() {
        const labels = [];
        for (let i = 0; i < SLOT_COUNT; i++) {
            const total = DAY_START_MIN + i * SLOT_MIN;
            const hh = Math.floor((total % (24*60)) / 60);
            const mm = total % 60;
            labels.push(`${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}`);
        }
        return labels;
    }
    const SLOT_LABELS = buildSlotLabels();

    // CSV 파서
    function parseCSV(text) {
        const rows = [];
        let i=0, cur='', row=[], inQuotes=false;
        while (i<text.length) {
            const ch=text[i];
            if (inQuotes) {
                if (ch === '"') {
                    if (text[i+1] === '"') { cur += '"'; i+=2; continue; }
                    inQuotes = false; i++; continue;
                }
                cur += ch; i++; continue;
            }
            if (ch === '"') { inQuotes = true; i++; continue; }
            if (ch === ',') { row.push(cur); cur=''; i++; continue; }
            if (ch === '\n') { row.push(cur); rows.push(row); cur=''; row=[]; i++; continue; }
            if (ch === '\r') { i++; continue; }
            cur += ch; i++;
        }
        if (cur.length || row.length) { row.push(cur); rows.push(row); }
        return rows;
    }
    const toNum = (x)=> {
        if (x==null) return NaN;
        const s = String(x).trim().replace(/,/g,'');
        const v = Number(s);
        return Number.isFinite(v) ? v : NaN;
    };
    const toMsAuto = (n)=> {
        const abs = Math.floor(Math.abs(n));
        return String(abs).length <= 10 ? n*1000 : n; // 10자리≈초, 13자리≈ms
    };

    // UTC epoch(ms) → KST Date
    const toKSTDate = (ms)=> new Date(ms + KST_OFFSET_MS);

    // KST Date → 09:00 기준 15분 슬롯 index (0~95)
    function slotIndexKST(dateKST) {
        // 오프셋을 더해 만들어서 UTC 필드 = KST
        const mins = dateKST.getUTCHours()*60 + dateKST.getUTCMinutes();
        let after9 = mins - DAY_START_MIN;
        if (after9 < 0) after9 += 24*60;
        return Math.floor(after9 / SLOT_MIN) % SLOT_COUNT;
    }

    function pctHtml(x){
        if (!Number.isFinite(x)) return '<span class="mono muted">–</span>';
        const p = (x*100).toFixed(2);
        const cls = x>0 ? 'pos' : x<0 ? 'neg' : 'zero';
        return `<span class="mono ${cls}">${p}%</span>`;
    }

    async function processFile(file, valueCol) {
        const text = await file.text();
        const rows = parseCSV(text);
        const recs = [];

        for (const r of rows) {
            if (!r || r.length < 5) continue;
            // Binance: A=open_time, B=open, C=high, D=low, E=close
            const a = toNum(r[0]);              // epoch(초/밀리초)
            const b = toNum(r[1]);              // B=open
            const v = toNum(valueCol === 'C' ? r[2] : r[4]); // C=high 또는 E=close

            if (!Number.isFinite(a)) continue;  // 헤더 스킵
            const ms = toMsAuto(a);
            const dKST = toKSTDate(ms);
            const sidx = slotIndexKST(dKST);

            recs.push({ ms, b, v, sidx });
        }

        // 슬롯별 첫 레코드 채택
        const slots = new Array(SLOT_COUNT).fill(null);
        recs.sort((x,y)=>x.ms-y.ms);
        for (const r of recs) {
            if (!slots[r.sidx]) slots[r.sidx] = r;
        }

        // B2 = 슬롯0(09:00)의 B (없으면 파일 내 첫 B)
        let B2 = slots[0]?.b;
        if (!Number.isFinite(B2)) {
            const firstB = recs.find(z=>Number.isFinite(z.b));
            B2 = firstB ? firstB.b : NaN;
        }

        // 각 슬롯별 계산
        const calc = slots.map(item => {
            if (!item) return { m1: NaN, m2: NaN, b: NaN, v: NaN };
            const { b, v } = item;
            const m1 = (Number.isFinite(v) && Number.isFinite(B2)) ? (v - B2) / B2 : NaN;
            const m2 = (Number.isFinite(v) && Number.isFinite(b))  ? (v - b)  / b  : NaN;
            return { m1, m2, b, v };
        });

        return { name:file.name, calc, B2 };
    }

    function renderTable(container, results){
        if (!results.length){
            container.innerHTML = '<p class="muted">표시할 데이터가 없습니다.</p>';
            return;
        }

        let thead = '<thead><tr><th class="left">KST</th>';
        for (const r of results) {
            thead += `<th colspan="2"><div class="left" style="display:flex;gap:8px;align-items:center">
                        <span class="mono">${r.name}</span>
                        <span class="pill mono">B2=${Number.isFinite(r.B2)?r.B2:'NaN'}</span>
                      </div></th>`;
        }
        thead += '</tr><tr><th class="left muted">HH:MM</th>';
        for (let i=0;i<results.length;i++){
            thead += `<th class="mono muted">(Vₙ−B₂)/B₂</th><th class="mono muted">(Vₙ−Bₙ)/Bₙ</th>`;
        }
        thead += '</tr></thead>';

        let tbody = '<tbody>';
        for (let s=0; s<SLOT_COUNT; s++){
            tbody += `<tr><td class="left mono">${SLOT_LABELS[s]}</td>`;
            for (const r of results){
                const cell = r.calc[s] || {m1:NaN,m2:NaN};
                tbody += `<td>${pctHtml(cell.m1)}</td><td>${pctHtml(cell.m2)}</td>`;
            }
            tbody += '</tr>';
        }
        tbody += '</tbody>';

        container.innerHTML = `<table>${thead}${tbody}</table>`;
    }

    function buildCSV(results){
        const head = ['KST(HH:MM)'];
        for (const r of results) head.push(`${r.name} (V-B2)/B2`, `${r.name} (V-B)/B`);
        const rows = [head];

        for (let s=0; s<SLOT_COUNT; s++){
            const line = [SLOT_LABELS[s]];
            for (const r of results){
                const c = r.calc[s] || {};
                const m1 = Number.isFinite(c.m1) ? (c.m1*100).toFixed(4)+'%' : '';
                const m2 = Number.isFinite(c.m2) ? (c.m2*100).toFixed(4)+'%' : '';
                line.push(m1, m2);
            }
            rows.push(line);
        }
        const esc = v => {
            const s = String(v ?? '');
            return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        };
        return rows.map(r => r.map(esc).join(',')).join('\r\n');
    }

    // ====== UI ======
    const fileInput = document.getElementById('fileInput');
    const runBtn = document.getElementById('runBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const tableWrap = document.getElementById('tableWrap');
    const meta = document.getElementById('meta');

    let lastResults = null;

    runBtn.addEventListener('click', async () => {
        const files = [...fileInput.files];
        if (!files.length) return alert('CSV 파일을 선택하세요.');

        runBtn.disabled = true; runBtn.textContent = '분석 중...';
        try {
            const valcol = (document.querySelector('input[name="valcol"]:checked')?.value || 'E'); // 'E' or 'C'
            const out = [];
            for (const f of files) out.push(await processFile(f, valcol));
            renderTable(tableWrap, out);
            lastResults = out;
            downloadBtn.disabled = false;
            meta.textContent = `파일 ${out.length}개 · 값 열: ${valcol} · 기준(B2)=09:00 슬롯의 B(없으면 파일 첫 B) · KST 기준 09:00 시작 96행 고정`;
        } catch (e){
            console.error(e);
            alert('처리 중 오류가 발생했습니다. CSV 형식을 확인해주세요.');
        } finally {
            runBtn.disabled = false; runBtn.textContent = '분석';
        }
    });

    downloadBtn.addEventListener('click', () => {
        if (!lastResults) return;
        const csv = buildCSV(lastResults);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `comparison_kst_0900_${Date.now()}.csv`;
        document.body.appendChild(a); a.click();
        URL.revokeObjectURL(url); a.remove();
    });
</script>
</body>
</html>
