<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>바이낸스 선물 USDT페어 거래량 급증 스캐너</title>
    <style>
        :root {
            --bg: #0b0c0f; --card:#161a23; --muted:#8b92a6; --text:#e8ebf1;
            --pos:#1db954; --neg:#ff4d4f; --accent:#6ea8fe; --warn:#ffb020;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial; }
        header { padding: 22px 18px 10px; max-width: 1200px; margin: 0 auto; }
        h1 { margin: 0 0 8px; font-size: 20px; }
        .muted { color: var(--muted); }
        .wrap { max-width: 1200px; margin: 0 auto; padding: 12px 18px 28px; }

        .panel { background: var(--card); border: 1px solid #1f2430; border-radius: 16px; padding: 14px; }
        .grid { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 10px; }
        .grid .item { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 12px; color: var(--muted); }
        select, input, button {
            width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #2a3140;
            background: #0f1218; color: var(--text);
        }
        button.primary { background: var(--accent); border-color: var(--accent); color: #0b0c0f; font-weight: 600; }
        button.ghost { background: transparent; border-color: #2a3140; }

        .toolbar { display: flex; gap: 10px; margin-top: 12px; }
        .status { margin-left: auto; font-size: 12px; color: var(--muted); display: flex; align-items: center; gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--warn); display: inline-block; }

        table { width: 100%; border-collapse: collapse; margin-top: 14px; }
        thead th {
            position: sticky; top: 0; background: #121621; z-index: 1;
            text-align: left; font-weight: 600; font-size: 12px; color: var(--muted);
            padding: 10px 8px; border-bottom: 1px solid #232a3a; cursor: pointer;
        }
        tbody td { padding: 10px 8px; border-bottom: 1px solid #1f2430; font-variant-numeric: tabular-nums; }
        tbody tr:hover { background: #121621; }
        .pill { font-size: 12px; padding: 3px 8px; border-radius: 999px; background: #0f1218; border: 1px solid #2a3140; }
        .good { color: var(--pos); }
        .bad  { color: var(--neg); }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
        .note { margin-top: 10px; color: var(--muted); font-size: 12px; }

        @media (max-width: 880px) {
            .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .toolbar { flex-direction: column; align-items: stretch; }
            .status { margin: 0; }
        }
    </style>
</head>
<body>
<header>
    <h1>바이낸스 선물 USDT페어 거래량 급증 스캐너</h1>
    <div class="muted">마지막 1개 봉의 거래량이 직전 N봉 평균 대비 얼마나 커졌는지(스파이크 비율)로 정렬합니다.</div>
</header>

<div class="wrap">
    <div class="panel">
        <div class="grid">
            <div class="item">
                <label>캔들 간격 (Interval)</label>
                <select id="interval">
                    <option value="1m">1m</option>
                    <option value="5m">5m</option>
                    <option value="15m" selected>15m</option>
                    <option value="1h">1h</option>
                </select>
            </div>
            <div class="item">
                <label>기준 구간 (Lookback, 직전 N봉 평균)</label>
                <input id="lookback" type="number" min="5" max="200" step="1" value="30" />
            </div>
            <div class="item">
                <label>스파이크 배수 (현재봉 ÷ 평균 ≥)</label>
                <input id="threshold" type="number" min="1" max="50" step="0.1" value="3" />
            </div>
            <div class="item">
                <label>최소 거래량 (현재봉, Base)</label>
                <input id="minVol" type="number" min="0" step="0.0001" value="0" />
            </div>
            <div class="item">
                <label>상위 노출 개수 (Top N)</label>
                <input id="topN" type="number" min="5" max="300" step="1" value="100" />
            </div>
            <div class="item">
                <label>자동 갱신 (초)</label>
                <input id="refreshSec" type="number" min="0" step="1" value="0" />
            </div>
        </div>

        <div class="toolbar">
            <button id="scanBtn" class="primary">스캔</button>
            <button id="stopBtn" class="ghost">자동 갱신 중지</button>
            <div class="status">
                <span class="dot" id="dot"></span>
                <span id="status">대기</span>
            </div>
        </div>

        <div class="note">
            • 선물 퍼페추얼 심볼만 포함 (e.g., BTCUSDT, ETHUSDT).  
            • 스파이크 비율 = <span class="mono">현재봉 거래량 / 직전 N봉 평균 거래량</span>  
            • 거래량은 선물 K라인의 <span class="mono">volume(베이스자산)</span> 사용. 필요시 quoteVolume으로 변경 가능.
        </div>
    </div>

    <table id="result">
        <thead>
            <tr>
                <th data-sort="symbol">심볼</th>
                <th data-sort="ratio">스파이크 비율</th>
                <th data-sort="vol">현재봉 거래량</th>
                <th data-sort="avg">평균 거래량(N)</th>
                <th data-sort="chg">현재봉 %변화</th>
                <th data-sort="price">현재가</th>
                <th data-sort="time">캔들 시간(종가)</th>
                <th>링크</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    // ===== 설정 =====
    const FAPI = 'https://fapi.binance.com';
    const EXCHANGE_INFO_URL = FAPI + '/fapi/v1/exchangeInfo';
    const KLINES_URL = FAPI + '/fapi/v1/klines';
    const CONCURRENCY = 8;         // 동시 요청 제한
    const RETRY = 2;               // 실패 재시도 횟수
    const TIMEOUT_MS = 12000;      // 각 요청 타임아웃

    const $interval = document.getElementById('interval');
    const $lookback = document.getElementById('lookback');
    const $threshold = document.getElementById('threshold');
    const $minVol = document.getElementById('minVol');
    const $topN = document.getElementById('topN');
    const $refreshSec = document.getElementById('refreshSec');

    const $scanBtn = document.getElementById('scanBtn');
    const $stopBtn = document.getElementById('stopBtn');
    const $tbody = document.querySelector('#result tbody');
    const $status = document.getElementById('status');
    const $dot = document.getElementById('dot');

    let autoTimer = null;
    let abortAll = null;

    function setStatus(text, busy = false) {
        $status.textContent = text;
        $dot.style.background = busy ? '#5fd4fb' : '#ffb020';
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    function withTimeout(promise, ms, label = 'timeout') {
        let timer;
        const t = new Promise((_, rej) => { timer = setTimeout(() => rej(new Error(label)), ms); });
        return Promise.race([promise, t]).finally(() => clearTimeout(timer));
    }

    async function safeFetch(url, opts = {}, tries = RETRY) {
        for (let i = 0; i <= tries; i++) {
            try {
                return await withTimeout(fetch(url, opts), TIMEOUT_MS, 'request-timeout');
            } catch (e) {
                if (i === tries) throw e;
                await sleep(200 + i * 400);
            }
        }
    }

    // 1) 선물 USDT Perpetual 심볼 목록 수집
    async function fetchFuturesUSDTPerpSymbols() {
        const res = await safeFetch(EXCHANGE_INFO_URL);
        const json = await res.json();
        // USDT 마진 & PERPETUAL 유형만
        return json.symbols
            .filter(s => s.contractType === 'PERPETUAL' && s.quoteAsset === 'USDT' && s.status === 'TRADING')
            .map(s => s.symbol);
    }

    // 2) 심볼당 K라인 가져와서 거래량 스파이크 계산
    //    - 마지막 봉(가장 최근 종가가 닫힌 봉)을 기준
    async function fetchSymbolSpike(symbol, interval, lookback) {
        const limit = Math.max(lookback + 2, 35); // 여유분
        const url = `${KLINES_URL}?symbol=${symbol}&interval=${interval}&limit=${limit}`;
        const res = await safeFetch(url);
        const arr = await res.json();
        if (!Array.isArray(arr) || arr.length < lookback + 1) return null;

        // K라인 포맷:
        // [0] openTime, [1] open, [2] high, [3] low, [4] close, [5] volume, [6] closeTime,
        // [7] quoteVolume, [8] numTrades, [9] takerBuyBase, [10] takerBuyQuote, [11] ignore]
        const last = arr[arr.length - 1];
        const prevSlice = arr.slice(arr.length - 1 - lookback, arr.length - 1);

        const nowVol = parseFloat(last[5]);
        const avgVol = prevSlice.reduce((a, c) => a + parseFloat(c[5]), 0) / prevSlice.length;

        const open = parseFloat(last[1]);
        const close = parseFloat(last[4]);
        const chgPct = ((close - open) / open) * 100;
        const ratio = avgVol > 0 ? nowVol / avgVol : 0;

        return {
            symbol,
            ratio,
            nowVol,
            avgVol,
            chgPct,
            price: close,
            closeTime: last[6]
        };
    }

    // 3) 동시성 제한 큐
    async function mapLimit(items, limit, worker) {
        const ret = [];
        let i = 0;
        const exec = async () => {
            while (true) {
                const idx = i++;
                if (idx >= items.length) return;
                try {
                    const v = await worker(items[idx], idx);
                    ret[idx] = v;
                } catch (e) {
                    ret[idx] = null;
                }
            }
        };
        const tasks = Array.from({ length: limit }, exec);
        await Promise.all(tasks);
        return ret;
    }

    // 4) 스캔 메인
    async function scan() {
        if (abortAll) { try { abortAll.abort(); } catch(e){} }
        abortAll = new AbortController();

        const interval = $interval.value;
        const lookback = Math.max(5, parseInt($lookback.value || '30', 10));
        const threshold = parseFloat($threshold.value || '3');
        const minVol = parseFloat($minVol.value || '0');
        const topN = Math.max(1, parseInt($topN.value || '100', 10));

        setStatus('심볼 불러오는 중…', true);
        let symbols = [];
        try {
            symbols = await fetchFuturesUSDTPerpSymbols();
        } catch (e) {
            setStatus('심볼 조회 실패: ' + e.message, false);
            return;
        }

        setStatus(`총 ${symbols.length}개 심볼 스캔 중… (${interval}, N=${lookback})`, true);

        // 심볼 순서는 무관. 네트워크 부담 완화를 위해 약간의 대기 삽입 가능.
        const results = await mapLimit(symbols, CONCURRENCY, async (sym) => {
            try {
                const r = await fetchSymbolSpike(sym, interval, lookback);
                if (!r) return null;
                if (r.nowVol < minVol) return null;
                if (r.ratio < threshold) return null;
                return r;
            } catch (e) {
                return null;
            }
        });

        const list = results.filter(Boolean)
            .sort((a, b) => b.ratio - a.ratio)
            .slice(0, topN);

        render(list);
        setStatus(`완료: ${list.length}개 감지`, false);
    }

    // 5) 렌더
    function render(rows) {
        const fmt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 6 });
        const fmt2 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 });
        const toTime = (t) => {
            const d = new Date(t);
            return d.toLocaleString();
        };

        $tbody.innerHTML = rows.map(r => {
            const cls = r.chgPct >= 0 ? 'good' : 'bad';
            const tv = `https://www.tradingview.com/chart/?symbol=BINANCE:${r.symbol}`;
            const bi = `https://www.binance.com/en/futures/${r.symbol}`;
            return `
                <tr>
                    <td class="mono">${r.symbol}</td>
                    <td><span class="pill">${fmt2.format(r.ratio)}×</span></td>
                    <td class="mono">${fmt.format(r.nowVol)}</td>
                    <td class="mono">${fmt.format(r.avgVol)}</td>
                    <td class="${cls} mono">${fmt2.format(r.chgPct)}%</td>
                    <td class="mono">${fmt.format(r.price)}</td>
                    <td class="mono">${toTime(r.closeTime)}</td>
                    <td>
                        <a href="${tv}" target="_blank" rel="noopener">TV</a> ·
                        <a href="${bi}" target="_blank" rel="noopener">Binance</a>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // 6) 정렬 (헤더 클릭)
    let sortKey = 'ratio';
    let sortDir = 'desc';
    document.querySelectorAll('thead th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
            const key = th.getAttribute('data-sort');
            if (sortKey === key) {
                sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
            } else {
                sortKey = key; sortDir = 'desc';
            }
            // 현재 테이블을 다시 정렬 (빠른 UX용)
            const rows = Array.from($tbody.querySelectorAll('tr')).map(tr => {
                const tds = tr.querySelectorAll('td');
                const obj = {
                    symbol: tds[0].textContent.trim(),
                    ratio: parseFloat(tds[1].innerText.replace(/[^0-9.]/g,'')) || 0,
                    nowVol: parseFloat(tds[2].innerText.replace(/,/g,'')) || 0,
                    avgVol: parseFloat(tds[3].innerText.replace(/,/g,'')) || 0,
                    chgPct: parseFloat(tds[4].innerText.replace('%','')) || 0,
                    price: parseFloat(tds[5].innerText.replace(/,/g,'')) || 0,
                    time: tds[6].textContent.trim(),
                    links: tds[7].innerHTML
                };
                return obj;
            });
            rows.sort((a,b) => {
                if (a[sortKey] < b[sortKey]) return sortDir === 'asc' ? -1 : 1;
                if (a[sortKey] > b[sortKey]) return sortDir === 'asc' ? 1 : -1;
                return 0;
            });
            // 재렌더
            $tbody.innerHTML = rows.map(r => {
                const cls = r.chgPct >= 0 ? 'good' : 'bad';
                return `
                    <tr>
                        <td class="mono">${r.symbol}</td>
                        <td><span class="pill">${r.ratio.toFixed(2)}×</span></td>
                        <td class="mono">${r.nowVol.toLocaleString()}</td>
                        <td class="mono">${r.avgVol.toLocaleString()}</td>
                        <td class="${cls} mono">${r.chgPct.toFixed(2)}%</td>
                        <td class="mono">${r.price.toLocaleString()}</td>
                        <td class="mono">${r.time}</td>
                        <td>${r.links}</td>
                    </tr>
                `;
            }).join('');
        });
    });

    // 7) 버튼/자동
    $scanBtn.addEventListener('click', () => {
        if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
        scan();
        const sec = parseInt($refreshSec.value || '0', 10);
        if (sec > 0) {
            autoTimer = setInterval(scan, Math.max(5, sec) * 1000);
            setStatus(`자동 갱신 ${Math.max(5, sec)}초`, true);
        }
    });

    $stopBtn.addEventListener('click', () => {
        if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
        setStatus('자동 갱신 중지', false);
    });

    // 초기 상태
    setStatus('대기', false);
</script>
</body>
</html>
