<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>15분봉 전행 계산 — B2/Bn 동시 계산</title>
    <style>
        :root { --bg:#0b0f16; --panel:#121826; --muted:#9aa4b2; --text:#e5e7eb; --accent:#60a5fa; --pos:#16a34a; --neg:#ef4444; --grid:#1f2937; }
        *{ box-sizing:border-box }
        body{ margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial }
        header{ padding:20px 24px; border-bottom:1px solid var(--grid); position:sticky; top:0; background:linear-gradient(180deg,rgba(11,15,22,.95),rgba(11,15,22,.85)); backdrop-filter:blur(8px) }
        h1{ margin:0 0 6px; font-size:20px }
        .sub{ color:var(--muted); font-size:13px }
        main{ padding:18px 24px 48px }
        .panel{ background:var(--panel); border:1px solid var(--grid); border-radius:16px; padding:16px }
        .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center }
        .grow{ flex:1 1 240px }
        input[type=file]{ width:100%; padding:10px; border:1px dashed var(--grid); background:transparent; color:var(--muted); border-radius:12px }
        .btn{ padding:10px 14px; border-radius:10px; border:1px solid var(--grid); background:#0f172a; color:var(--text); cursor:pointer }
        .btn.primary{ background:var(--accent); color:#0b0f16; border-color:transparent; font-weight:700 }
        .btn.ghost{ background:transparent }
        .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--grid); color:var(--muted) }
        .grid{ display:grid; gap:12px; grid-template-columns:1fr }
        @media(min-width:1100px){ .grid{ grid-template-columns:360px 1fr } }
        .list{ max-height:140px; overflow:auto; border:1px solid var(--grid); border-radius:12px; padding:8px; font-size:13px; background:#0d1320 }
        .list div{ padding:6px 8px; border-radius:8px }
        .list div:hover{ background:rgba(96,165,250,.12) }
        .scroll{ overflow:auto; max-height:70vh; border:1px solid var(--grid); border-radius:12px }
        table{ width:100%; border-collapse:separate; border-spacing:0; font-size:13px }
        thead th{ position:sticky; top:0; background:#0f172a; z-index:1; text-align:left; padding:8px 10px; border-bottom:1px solid var(--grid); font-weight:700 }
        tbody td{ padding:8px 10px; border-bottom:1px solid var(--grid) }
        tbody tr:hover{ background:rgba(148,163,184,.08) }
        .mono{ font-variant-numeric:tabular-nums; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }
        .right{ text-align:right }
        .pos{ color:var(--pos) }
        .neg{ color:var(--neg) }
        .muted{ color:var(--muted) }
        .footer{ margin-top:12px; display:flex; gap:10px; align-items:center; justify-content:space-between; color:var(--muted); font-size:12px }
        .pill{ background:#0d1320; border:1px solid var(--grid); padding:6px 10px; border-radius:999px; font-size:12px }
        label.small{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px }
        input[type=number], select{ width:100%; padding:8px 10px; border:1px solid var(--grid); background:#0b0f16; color:var(--text); border-radius:10px }
        .controls{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
    </style>
</head>
<body>
<header>
    <h1>15분봉 전행 계산 — B2/Bn 동시 계산</h1>
    <div class="sub">
        CSV의 <b>모든 행</b>에 대해 두 값을 계산합니다:<br>
        1) <b>(Dn − B2)/B2</b> — 해당 날짜의 <b>KST 09:00 시가(B2)</b> 기준 (없으면 그날 09:00 이후 첫 봉 시가)<br>
        2) <b>(Dn − Bn)/Bn</b> — <b>그 행의 시가(Bn)</b> 기준
    </div>
</header>

<main class="grid">
    <section class="panel">
        <div class="row">
            <div class="grow">
                <label class="sub">CSV 파일 선택 (여러 개 가능)</label>
                <input id="fileInput" type="file" accept=".csv" multiple />
            </div>
            <button id="loadBtn" class="btn primary">분석하기</button>
            <button id="clearBtn" class="btn ghost">초기화</button>
        </div>
        <div style="height:12px"></div>
        <div class="row">
            <span class="badge">타임존: Asia/Seoul (UTC+9)</span>
            <span class="badge">기준가: B2=09:00 시가</span>
            <span class="badge" id="countBadge">파일 0개</span>
        </div>
        <div style="height:12px"></div>
        <div class="controls">
            <div>
                <label class="small">소수 자리수(표시)</label>
                <input id="decimals" type="number" min="0" max="6" step="1" value="3" />
            </div>
            <div>
                <label class="small">빈 값 행</label>
                <select id="emptyFilter">
                    <option value="show">보이기</option>
                    <option value="hide">숨기기(두 값 모두 비었을 때)</option>
                </select>
            </div>
            <div>
                <label class="small">정렬</label>
                <select id="sortBy">
                    <option value="file_time">파일-시간</option>
                    <option value="date_time">날짜-시간</option>
                    <option value="pct_b2_desc">% (B2기준) 내림차순</option>
                    <option value="pct_bn_desc">% (Bn기준) 내림차순</option>
                </select>
            </div>
        </div>
        <div style="height:12px"></div>
        <div>
            <div class="sub">선택된 파일</div>
            <div id="fileList" class="list"></div>
        </div>
    </section>

    <section class="panel">
        <div class="scroll">
            <table>
                <thead>
                    <tr>
                        <th style="min-width:120px">파일(라벨)</th>
                        <th style="min-width:110px">날짜(KST)</th>
                        <th style="min-width:90px">시각(HH:MM)</th>
                        <th class="right">B2 (09:00 시가)</th>
                        <th class="right">Bn (행 시가)</th>
                        <th class="right">Dn (행 종가)</th>
                        <th class="right">% (Dn−B2)/B2</th>
                        <th class="right">% (Dn−Bn)/Bn</th>
                    </tr>
                </thead>
                <tbody id="rowsBody"></tbody>
            </table>
        </div>
        <div class="footer">
            <div class="pill" id="stats">총 0행</div>
            <div>
                <button id="downloadRows" class="btn">CSV로 저장</button>
            </div>
        </div>
    </section>
</main>

<script>
/* ========== 유틸 ========== */
function getSeriesLabel(name){
    return name.replace(/\.[^.]+$/,'').toUpperCase();
}
function toEpochMs(x){
    var n = Number(x);
    if (!isFinite(n)) return NaN;
    return n < 1e11 ? n * 1000 : n; // 초→ms 보정
}
// CSV 포맷: [open_time, open, high, low, close, volume, close_time, ..., trades] 가정
function parseCSV(text){
    var lines = text.trim().split(/\r?\n/);
    var rows = [];
    for (var i = 0; i < lines.length; i++) {
        var cols = lines[i].split(',');
        if (cols.length < 12) continue;
        rows.push({
            open_time: toEpochMs(cols[0]),
            open: Number(cols[1]),
            high: Number(cols[2]),
            low: Number(cols[3]),
            close: Number(cols[4]),
            volume: Number(cols[5]),
            close_time: toEpochMs(cols[6]),
            trades: Number(cols[8])
        });
    }
    return rows;
}
// KST(UTC+9) 기준 날짜/시각
function kstDateAndHHMM(ms){
    var d = new Date(ms + 9*3600*1000);
    var yyyy = d.getUTCFullYear();
    var mm = ('0' + (d.getUTCMonth()+1)).slice(-2);
    var dd = ('0' + d.getUTCDate()).slice(-2);
    var hh = ('0' + d.getUTCHours()).slice(-2);
    var mi = ('0' + d.getUTCMinutes()).slice(-2);
    return { date: `${yyyy}-${mm}-${dd}`, hhmm: `${hh}:${mi}` };
}
function clockToMinutes(hhmm){
    var p = (hhmm || '00:00').split(':');
    return (parseInt(p[0]||'0',10)*60) + (parseInt(p[1]||'0',10));
}
function fmt(n, d){
    if (n == null || isNaN(n)) return '';
    return Number(n).toLocaleString(undefined, { maximumFractionDigits:d, minimumFractionDigits:d });
}
function downloadCSV(filename, rows){
    if (!rows.length) return;
    var headers = Object.keys(rows[0]);
    var esc = v => v==null? '' : (String(v).includes(',') ? '"' + String(v).replace(/"/g,'""') + '"' : String(v));
    var csv = [headers.join(',')].concat(rows.map(r => headers.map(h => esc(r[h])).join(','))).join('\n');
    var blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    setTimeout(() => URL.revokeObjectURL(url), 3000);
}

/* ========== 상태/DOM ========== */
var state = {
    files: [],
    rowsAll: [] // { series, date, hhmm, baseOpen(B2), open(Bn), close(Dn), pctB2, pctBn, _ts }
};
var fileInput = document.getElementById('fileInput');
var fileList = document.getElementById('fileList');
var countBadge = document.getElementById('countBadge');
var loadBtn = document.getElementById('loadBtn');
var clearBtn = document.getElementById('clearBtn');
var decimalsEl = document.getElementById('decimals');
var emptyFilterEl = document.getElementById('emptyFilter');
var sortByEl = document.getElementById('sortBy');
var rowsBody = document.getElementById('rowsBody');
var statsEl = document.getElementById('stats');
var downloadRowsBtn = document.getElementById('downloadRows');

/* ========== 이벤트 ========== */
fileInput.addEventListener('change', function(){
    state.files = Array.prototype.slice.call(fileInput.files || []);
    fileList.innerHTML = state.files.map(f => `<div>${f.name} <span class="muted">(${(f.size/1024).toFixed(1)} KB)</span></div>`).join('');
    countBadge.textContent = `파일 ${state.files.length}개`;
});
clearBtn.addEventListener('click', function(){
    state = { files: [], rowsAll: [] };
    fileInput.value = '';
    fileList.innerHTML = '';
    countBadge.textContent = '파일 0개';
    rowsBody.innerHTML = '';
    statsEl.textContent = '총 0행';
});
loadBtn.addEventListener('click', runAnalysis);
decimalsEl.addEventListener('change', renderRows);
emptyFilterEl.addEventListener('change', renderRows);
sortByEl.addEventListener('change', renderRows);
downloadRowsBtn.addEventListener('click', function(){
    if (!state.rowsAll.length) return;
    var out = state.rowsAll.map(r => ({
        series: r.series,
        date_kst: r.date,
        time_hhmm: r.hhmm,
        base_open_B2: r.baseOpen != null ? Number(r.baseOpen.toFixed(8)) : '',
        open_Bn: r.open != null ? Number(r.open.toFixed(8)) : '',
        close_Dn: r.close != null ? Number(r.close.toFixed(8)) : '',
        pct_vs_B2: r.pctB2 != null ? Number(r.pctB2.toFixed(6)) : '',
        pct_vs_Bn: r.pctBn != null ? Number(r.pctBn.toFixed(6)) : ''
    }));
    downloadCSV('rows_changes_B2_and_Bn.csv', out);
});

/* ========== 핵심: 모든 행에 대해 B2/Bn 동시 계산 ========== */
function runAnalysis(){
    if (!state.files.length) {
        alert('CSV 파일을 선택해 주세요.');
        return;
    }

    var all = [];
    var tasks = state.files.map(file => file.text().then(text => {
        var series = getSeriesLabel(file.name);
        var arr = parseCSV(text);

        // 원본 시간순 정렬(안전)
        arr.sort((a,b) => a.open_time - b.open_time);

        // 날짜별로 묶고 B2(09:00 시가, 없으면 09:00 이후 첫 봉 시가) 선정
        var byDate = new Map(); // date -> [{ open_time, open, close, hhmm }]
        for (var i = 0; i < arr.length; i++) {
            var o = arr[i];
            var k = kstDateAndHHMM(o.open_time);
            if (!byDate.has(k.date)) byDate.set(k.date, []);
            byDate.get(k.date).push({ open_time: o.open_time, open: o.open, close: o.close, hhmm: k.hhmm });
        }

        var baseByDate = new Map(); // date -> baseOpen(B2)
        byDate.forEach((list, date) => {
            list.sort((a,b) => (a.hhmm < b.hhmm ? -1 : a.hhmm > b.hhmm ? 1 : a.open_time - b.open_time));
            var baseOpen = null;

            // 09:00 정확히
            for (var j = 0; j < list.length; j++) {
                if (list[j].hhmm === '09:00') { baseOpen = list[j].open; break; }
            }
            // 없으면 09:00 이후 첫 봉
            if (baseOpen == null) {
                for (var j2 = 0; j2 < list.length; j2++) {
                    if (clockToMinutes(list[j2].hhmm) >= 9*60) { baseOpen = list[j2].open; break; }
                }
            }
            if (baseOpen != null) baseByDate.set(date, baseOpen);
        });

        // 모든 행에 대해 두 퍼센트 계산
        byDate.forEach((list, date) => {
            var baseOpen = baseByDate.get(date); // B2
            for (var k = 0; k < list.length; k++) {
                var it = list[k];
                var pctB2 = null, pctBn = null;
                if (baseOpen != null && baseOpen !== 0) {
                    pctB2 = ((it.close - baseOpen) / baseOpen) * 100;
                }
                if (it.open != null && it.open !== 0) {
                    pctBn = ((it.close - it.open) / it.open) * 100;
                }
                all.push({
                    series: series,
                    date: date,
                    hhmm: it.hhmm,
                    baseOpen: baseOpen != null ? baseOpen : null, // B2
                    open: it.open,  // Bn
                    close: it.close, // Dn
                    pctB2: pctB2,
                    pctBn: pctBn,
                    _ts: it.open_time
                });
            }
        });
    }));

    Promise.all(tasks).then(() => {
        // 기본 정렬: 파일-시간
        all.sort((a,b) => a.series < b.series ? -1 : a.series > b.series ? 1 : (a._ts - b._ts));
        state.rowsAll = all;
        renderRows();
    });
}

/* ========== 렌더링 ========== */
function renderRows(){
    var d = Math.max(0, Math.min(6, Number(decimalsEl.value) || 3));
    var hideEmpty = (emptyFilterEl.value === 'hide');
    var sort = sortByEl.value;

    // 정렬 옵션
    var a = state.rowsAll.slice();
    if (sort === 'date_time') {
        a.sort((x,y) => (x.date < y.date ? -1 : x.date > y.date ? 1 : (x._ts - y._ts)));
    } else if (sort === 'pct_b2_desc') {
        a.sort((x,y) => (Number(y.pctB2 ?? -Infinity) - Number(x.pctB2 ?? -Infinity)));
    } else if (sort === 'pct_bn_desc') {
        a.sort((x,y) => (Number(y.pctBn ?? -Infinity) - Number(x.pctBn ?? -Infinity)));
    } else { // file_time
        a.sort((x,y) => x.series < y.series ? -1 : x.series > y.series ? 1 : (x._ts - y._ts));
    }

    rowsBody.innerHTML = '';
    var frag = document.createDocumentFragment();
    var count = 0;

    for (var i = 0; i < a.length; i++) {
        var r = a[i];
        var bothEmpty = (r.pctB2 == null || isNaN(r.pctB2)) && (r.pctBn == null || isNaN(r.pctBn));
        if (hideEmpty && bothEmpty) continue;

        var clsB2 = (r.pctB2 == null) ? 'muted' : (r.pctB2 >= 0 ? 'pos' : 'neg');
        var clsBn = (r.pctBn == null) ? 'muted' : (r.pctBn >= 0 ? 'pos' : 'neg');

        var tr = document.createElement('tr');
        tr.innerHTML =
            `<td class="caps">${r.series}</td>` +
            `<td class="mono">${r.date}</td>` +
            `<td class="mono">${r.hhmm}</td>` +
            `<td class="right mono">${r.baseOpen == null ? '' : r.baseOpen.toFixed(8)}</td>` +
            `<td class="right mono">${r.open == null ? '' : r.open.toFixed(8)}</td>` +
            `<td class="right mono">${r.close == null ? '' : r.close.toFixed(8)}</td>` +
            `<td class="right mono ${clsB2}">${r.pctB2 == null ? '' : r.pctB2.toFixed(d)}</td>` +
            `<td class="right mono ${clsBn}">${r.pctBn == null ? '' : r.pctBn.toFixed(d)}</td>`;
        frag.appendChild(tr);
        count++;
    }

    rowsBody.appendChild(frag);
    statsEl.textContent = `총 ${count}행`;
}
</script>
</body>
</html>
