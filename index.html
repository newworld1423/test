<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Binance Perp 1D Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif; margin: 24px; }
        h1 { margin: 0 0 16px; font-size: 20px; }
        .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
        input, button, select { padding: 8px 10px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        th, td { border: 1px solid #e5e7eb; padding: 8px 10px; text-align: right; }
        th:nth-child(1), td:nth-child(1),
        th:nth-child(2), td:nth-child(2) { text-align: left; }
        thead th { background: #f8fafc; }
        .muted { opacity: 0.7; }
    </style>
</head>
<body>
    <h1>바이낸스 선물 1일봉 스캔 (최근 N일)</h1>

    <div class="row">
        <label>USDT 페어:
            <input id="symbol" value="SQDUSDT" placeholder="예: BTCUSDT / SQDUSDT" />
        </label>
        <label>최근 N일:
            <input id="days" type="number" min="3" max="60" value="10" />
        </label>
        <label class="muted">
            <input id="skipTodayHiLo" type="checkbox" checked />
            오늘 봉은 고가/저가 스킵
        </label>
        <button id="run">스캔</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>날짜</th>
                <th>코인</th>
                <th>직전봉 상승률</th>
                <th>시가</th>
                <th>고가</th>
                <th>시가대비 고가</th>
                <th>저가</th>
                <th>시가대비 저가</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <tr><td colspan="8" style="text-align:center;" class="muted">입력 후 [스캔]을 눌러주세요</td></tr>
        </tbody>
    </table>

    <script>
        // 바이낸스 선물 API (CORS 허용)
        const FAPI_BASE = "https://fapi.binance.com";

        document.getElementById("run").addEventListener("click", async () => {
            const symbol = document.getElementById("symbol").value.trim().toUpperCase();
            const days = Math.max(3, Math.min(60, parseInt(document.getElementById("days").value, 10) || 10));
            const skipTodayHiLo = document.getElementById("skipTodayHiLo").checked;
            const $tbody = document.getElementById("tbody");

            if (!symbol.endsWith("USDT")) {
                alert("심볼은 반드시 USDT 페어여야 합니다. (예: BTCUSDT)");
                return;
            }

            $tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;" class="muted">불러오는 중...</td></tr>`;

            try {
                // N일 + 이전봉(전일 상승률 계산용) 확보를 위해 넉넉히 가져오기
                const limit = days + 2;
                const url = `${FAPI_BASE}/fapi/v1/klines?symbol=${encodeURIComponent(symbol)}&interval=1d&limit=${limit}`;
                const resp = await fetch(url, { method: "GET" });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const klines = await resp.json();

                if (!Array.isArray(klines) || klines.length < 3) {
                    throw new Error("데이터가 충분하지 않습니다.");
                }

                // kline 구조: [openTime, open, high, low, close, volume, closeTime, ...]
                const rows = klines.map(k => ({
                    openTime: Number(k[0]),
                    open: parseFloat(k[1]),
                    high: parseFloat(k[2]),
                    low: parseFloat(k[3]),
                    close: parseFloat(k[4]),
                    closeTime: Number(k[6]),
                }));

                // 최신이 맨 뒤에 오므로 그대로 사용. 최근 N개를 대상으로 출력하되,
                // 각 행의 '직전봉 상승률'은 바로 앞 봉의 (close-open)/open 로 계산
                const recent = rows.slice(-days - 1); // 전일 계산 위해 N+1개
                const nowUtc = Date.now();

                const base = symbol.replace(/USDT$/i, "");
                const fmtPct = (x) => `${(x >= 0 ? "" : "")}${(x * 100).toFixed(2)}%`;
                const fmtNum = (x) => (Number.isFinite(x) ? String(x) : "");
                const toKSTDate = (ms) => {
                    // 아시아/서울 기준 날짜 문자열
                    const d = new Date(ms);
                    // 한국 사용자를 고려해 KST로 보기 (UTC+9)
                    const kst = new Date(d.getTime() + 9 * 60 * 60 * 1000);
                    return kst.toISOString().slice(0, 10);
                };

                // 테이블 렌더
                const out = [];
                for (let i = 1; i < recent.length; i++) {
                    const prev = recent[i - 1];
                    const cur = recent[i];

                    const dateStr = toKSTDate(cur.openTime); // 해당 "날짜" (봉 시작일)
                    const prevChange = (prev.close - prev.open) / prev.open; // 직전봉 상승률

                    // 오늘 봉(진행중)인지 판정: 1일봉은 openTime + 24h가 봉 종료 시각(UTC)
                    const candleEnd = cur.openTime + 24 * 60 * 60 * 1000;
                    const isTodayOpen = nowUtc < candleEnd; // 아직 닫히지 않았으면 진행중

                    let high = cur.high;
                    let low = cur.low;
                    let oh = (cur.high - cur.open) / cur.open;
                    let ol = (cur.low - cur.open) / cur.open;

                    if (isTodayOpen && skipTodayHiLo) {
                        high = "";
                        low = "";
                        oh = NaN;
                        ol = NaN;
                    }

                    out.push(`
                        <tr>
                            <td>${dateStr}</td>
                            <td>${base}</td>
                            <td>${fmtPct(prevChange)}</td>
                            <td>${fmtNum(cur.open)}</td>
                            <td>${fmtNum(high)}</td>
                            <td>${Number.isFinite(oh) ? fmtPct(oh) : ""}</td>
                            <td>${fmtNum(low)}</td>
                            <td>${Number.isFinite(ol) ? fmtPct(ol) : ""}</td>
                        </tr>
                    `);
                }

                if (out.length === 0) {
                    $tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;" class="muted">표시할 데이터가 없습니다.</td></tr>`;
                } else {
                    $tbody.innerHTML = out.join("");
                }
            } catch (err) {
                console.error(err);
                $tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#b91c1c;">
                    오류: ${err.message || err}
                </td></tr>`;
            }
        });
    </script>
</body>
</html>
