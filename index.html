<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Binance Futures 15m EMA50 Cross Scanner (USDT Perp)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root{
            --bg:#0b0c0f; --card:#151821; --muted:#8b92a6; --text:#e8ebf1;
            --pos:#1db954; --neg:#ff4d4f; --accent:#6ea8fe; --line:#2a2f3a;
        }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',Arial}
        header{max-width:1200px;margin:0 auto;padding:24px 16px 8px}
        h1{margin:0 0 6px;font-size:20px}
        .muted{color:var(--muted)}
        .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
        .controls label{display:flex;align-items:center;gap:6px;background:var(--card);border:1px solid var(--line);padding:8px 10px;border-radius:8px}
        .controls input{background:transparent;border:none;outline:none;color:var(--text);width:120px}
        .btn{background:var(--accent);color:#0b0c0f;border:none;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
        .btn:disabled{opacity:.6;cursor:not-allowed}
        .wrap{max-width:1200px;margin:0 auto;padding:0 16px 24px}
        table{width:100%;border-collapse:collapse;margin-top:16px}
        th,td{border-bottom:1px solid var(--line);padding:10px;text-align:center}
        th{background:var(--card);position:sticky;top:0}
        tbody tr:hover{background:#12141a}
        .right{text-align:right}
        .pos{color:var(--pos)}
        .neg{color:var(--neg)}
        .badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#11141a;color:var(--muted);font-size:12px}
        .status{margin-top:8px}
        .footer-note{margin-top:10px;color:var(--muted);font-size:12px}
        .small{font-size:12px}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    </style>
</head>
<body>
<header>
    <h1>바이낸스 선물 15분봉 EMA50 크로스 스캐너 <span class="badge">USDT Perp</span></h1>
    <div class="muted small">조건: <span class="mono">2봉전 종가 &lt; 50EMA</span> 이고 <span class="mono">1봉전 종가 &gt; 50EMA</span> (15분봉 기준)</div>

    <div class="controls">
        <label>최소 24h 거래대금(USDT):
            <input id="minQuoteVolume" type="number" step="100000" value="20000000" />
        </label>
        <label>동시성(Concurrent Requests):
            <input id="concurrency" type="number" min="1" max="20" value="8" />
        </label>
        <button id="scanBtn" class="btn">재스캔</button>
        <span id="status" class="status muted">대기 중…</span>
    </div>
</header>

<div class="wrap">
    <table id="resultTable">
        <thead>
            <tr>
                <th style="width:140px">심볼</th>
                <th>최신가</th>
                <th>24h 거래대금 (quoteVolume, USDT)</th>
                <th>24h 변동률</th>
                <th>조건 일치 캔들</th>
                <th>체크 시각</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div class="footer-note">
        데이터: Binance Futures API (USDT Perpetual). 최신 15분봉 300개로 EMA50 계산. 마지막 봉은 진행 중일 수 있음 → 조건은 <b>1·2봉 전</b>으로 판정.
    </div>
</div>

<script>
    // ====== 설정 ======
    const FAPI = 'https://fapi.binance.com'; // Binance Futures API base
    const INTERVAL = '15m';
    const LIMIT = 300; // EMA50 계산을 위한 여유 확보
    const EMA_PERIOD = 50;

    const $tbody = document.querySelector('#resultTable tbody');
    const $scanBtn = document.getElementById('scanBtn');
    const $status = document.getElementById('status');
    const $minQuoteVolume = document.getElementById('minQuoteVolume');
    const $concurrency = document.getElementById('concurrency');

    // 숫자 포맷터
    const fmt0 = (n) => Number(n).toLocaleString('en-US', { maximumFractionDigits: 0 });
    const fmt2 = (n) => Number(n).toLocaleString('en-US', { maximumFractionDigits: 2 });
    const pct = (n) => (Number(n) >= 0 ? `<span class="pos">+${fmt2(n)}%</span>` : `<span class="neg">${fmt2(n)}%</span>`);

    // 지수이동평균
    function ema(values, period) {
        const k = 2 / (period + 1);
        const out = new Array(values.length).fill(null);
        let sum = 0;
        for (let i = 0; i < values.length; i++) {
            const v = Number(values[i]);
            if (i < period) {
                sum += v;
                if (i === period - 1) out[i] = sum / period;
            } else {
                out[i] = v * k + out[i - 1] * (1 - k);
            }
        }
        return out;
    }

    // 유틸: 제한 동시성 실행
    async function pLimitAll(items, limit, worker) {
        const results = [];
        let i = 0;
        const workers = new Array(Math.min(limit, items.length)).fill(0).map(async () => {
            while (i < items.length) {
                const cur = i++;
                try {
                    results[cur] = await worker(items[cur], cur);
                } catch (e) {
                    results[cur] = { error: e };
                }
            }
        });
        await Promise.all(workers);
        return results;
    }

    async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status} @ ${url}`);
        return res.json();
    }

    async function getPerpUSDTTradingSymbols() {
        // 선물 exchangeInfo
        const info = await fetchJSON(`${FAPI}/fapi/v1/exchangeInfo`);
        const list = info.symbols.filter(s =>
            s.contractType === 'PERPETUAL' &&
            s.quoteAsset === 'USDT' &&
            s.status === 'TRADING'
        ).map(s => s.symbol);
        return list;
    }

    async function get24hTickersMap() {
        // 모든 선물 24h ticker
        const arr = await fetchJSON(`${FAPI}/fapi/v1/ticker/24hr`);
        const map = new Map();
        for (const t of arr) {
            map.set(t.symbol, t);
        }
        return map;
    }

    async function getKlines(symbol) {
        const url = `${FAPI}/fapi/v1/klines?symbol=${symbol}&interval=${INTERVAL}&limit=${LIMIT}`;
        const data = await fetchJSON(url);
        // kline: [openTime, open, high, low, close, volume, closeTime, ...]
        const closes = data.map(k => Number(k[4]));
        const volumes = data.map(k => Number(k[5]));
        return { closes, volumes, raw: data };
    }

    function checkCondition(closes) {
        if (!closes || closes.length < EMA_PERIOD + 2) return { ok: false };
        const ema50 = ema(closes, EMA_PERIOD);
        const n = closes.length;

        // 판정은 2봉 전 / 1봉 전 기준
        const close_2 = closes[n - 3];
        const close_1 = closes[n - 2];
        const ema_2 = ema50[n - 3];
        const ema_1 = ema50[n - 2];

        if (ema_2 == null || ema_1 == null) return { ok: false };

        const cond = (close_2 < ema_2) && (close_1 > ema_1);
        return { ok: cond, indices: { i2: n - 3, i1: n - 2 }, values: { close_2, ema_2, close_1, ema_1 } };
    }

    function renderRows(rows) {
        $tbody.innerHTML = '';
        const now = new Date();
        for (const r of rows) {
            const tr = document.createElement('tr');

            const symTD = document.createElement('td');
            symTD.innerHTML = `<a href="https://www.binance.com/ko/futures/${r.symbol}" target="_blank" rel="noopener">${r.symbol}</a>`;
            tr.appendChild(symTD);

            const priceTD = document.createElement('td');
            priceTD.className = 'right mono';
            priceTD.textContent = r.lastPrice != null ? r.lastPrice : '-';
            tr.appendChild(priceTD);

            const qvTD = document.createElement('td');
            qvTD.className = 'right mono';
            qvTD.textContent = r.quoteVolume != null ? fmt0(r.quoteVolume) : '-';
            tr.appendChild(qvTD);

            const chgTD = document.createElement('td');
            chgTD.innerHTML = r.priceChangePercent != null ? pct(r.priceChangePercent) : '-';
            tr.appendChild(chgTD);

            const condTD = document.createElement('td');
            condTD.innerHTML = `<span class="badge">2봉 전 C(${fmt2(r.check?.values?.close_2)}) &lt; EMA50(${fmt2(r.check?.values?.ema_2)})</span> · 
                                <span class="badge">1봉 전 C(${fmt2(r.check?.values?.close_1)}) &gt; EMA50(${fmt2(r.check?.values?.ema_1)})</span>`;
            tr.appendChild(condTD);

            const timeTD = document.createElement('td');
            timeTD.className = 'small';
            timeTD.textContent = now.toLocaleString();
            tr.appendChild(timeTD);

            $tbody.appendChild(tr);
        }
    }

    async function scan() {
        try {
            $scanBtn.disabled = true;
            $status.textContent = '심볼 수집 중…';

            const [symbols, tickerMap] = await Promise.all([
                getPerpUSDTTradingSymbols(),
                get24hTickersMap()
            ]);

            // 24h quoteVolume 필터 먼저 적용(네트워크 절약)
            const minQV = Number($minQuoteVolume.value || 0);
            const filtered = symbols.filter(s => {
                const t = tickerMap.get(s);
                return t && Number(t.quoteVolume) >= minQV;
            });

            $status.textContent = `총 ${symbols.length}개 중 거래대금 필터 통과 ${filtered.length}개 → 15분봉/EMA 체크 중…`;

            const conc = Math.max(1, Math.min(20, Number($concurrency.value || 8)));
            const results = await pLimitAll(filtered, conc, async (symbol) => {
                try {
                    const { closes } = await getKlines(symbol);
                    const check = checkCondition(closes);
                    if (!check.ok) return null;

                    const t = tickerMap.get(symbol) || {};
                    return {
                        symbol,
                        check,
                        lastPrice: t.lastPrice ? Number(t.lastPrice) : null,
                        quoteVolume: t.quoteVolume ? Number(t.quoteVolume) : null,
                        priceChangePercent: t.priceChangePercent ? Number(t.priceChangePercent) : null
                    };
                } catch (e) {
                    // 개별 심볼 실패는 무시
                    return null;
                }
            });

            const matched = results.filter(Boolean);
            // 거래대금(quoteVolume) 내림차순 정렬
            matched.sort((a, b) => (b.quoteVolume || 0) - (a.quoteVolume || 0));

            renderRows(matched);
            $status.textContent = `완료: 조건 일치 ${matched.length}개 (정렬: 24h 거래대금 내림차순)`;
        } catch (e) {
            console.error(e);
            $status.textContent = `에러: ${e.message || e}`;
        } finally {
            $scanBtn.disabled = false;
        }
    }

    $scanBtn.addEventListener('click', scan);

    // 초기 1회 자동 실행
    scan();
</script>
</body>
</html>