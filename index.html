<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Binance Perp USDT – 1D 이전 봉 상승률 스캐너</title>
    <style>
        :root {
            --bg:#0b0c0f; --card:#151821; --muted:#9aa3b2; --text:#e8ebf1;
            --pos:#1db954; --neg:#ff4d4f; --accent:#6ea8fe; --border:#232735;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; background: var(--bg); color: var(--text);
            font: 14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',Arial;
        }
        header { max-width: 1200px; margin: 0 auto; padding: 20px; }
        h1 { margin: 0 0 6px; font-size: 22px; }
        .muted { color: var(--muted); }
        .toolbar {
            display: grid; gap: 10px; grid-template-columns: 1fr; margin-top: 10px;
        }
        .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 14px; padding: 14px 16px;
        }
        input, select, button {
            background: #0f1117; color: var(--text); border: 1px solid var(--border);
            border-radius: 10px; padding: 10px 12px; outline: none;
        }
        button {
            background: var(--accent); color: #0b0c0f; border: none; cursor: pointer;
            font-weight: 600;
        }
        button.secondary { background: #2a2f42; color: var(--text); }
        button:disabled { opacity: .6; cursor: not-allowed; }
        .progress { height: 8px; background:#0f1117; border:1px solid var(--border); border-radius: 999px; overflow: hidden; }
        .bar { height: 100%; width: 0%; background: var(--accent); transition: width .2s ease; }
        main { max-width: 1200px; margin: 0 auto; padding: 0 20px 40px; }
        table {
            width: 100%; border-collapse: collapse; margin-top: 12px; font-variant-numeric: tabular-nums;
        }
        th, td {
            border-bottom: 1px solid var(--border); padding: 10px 8px; text-align: right;
        }
        th { text-align: right; color: var(--muted); font-weight: 600; }
        th:first-child, td:first-child { text-align: left; }
        .pill {
            display: inline-block; padding: 2px 8px; border-radius: 999px; font-weight: 700;
        }
        .pill.pos { color: #0b0c0f; background: var(--pos); }
        .pill.neg { color: #0b0c0f; background: var(--neg); }
        .small { font-size: 12px; color: var(--muted); }
        .status { margin-top: 8px; }
        .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 720px) { .grid2 { grid-template-columns: 1fr; } }
        .right { text-align: right; }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <header>
        <h1>바이낸스 USDT 무기한 – 1일봉 ‘어제’ 상승률 스캐너</h1>
        <div class="muted">USDT 무기한 선물(PERPETUAL) 종목을 대상으로, 어제 1D 캔들의 수익률로 정렬합니다.</div>

        <div class="toolbar card">
            <div class="grid2">
                <div class="row">
                    <label class="small">최소 어제 거래대금(USDT)</label>
                    <input id="minQuote" type="number" min="0" step="100000" value="0" />
                </div>
                <div class="row">
                    <label class="small">동시 요청 수</label>
                    <input id="concurrency" type="number" min="1" max="20" value="8" />
                    <label class="small">재시도</label>
                    <input id="retries" type="number" min="0" max="3" value="1" />
                </div>
            </div>
            <div class="row">
                <button id="scanBtn">스캔 시작</button>
                <button id="cancelBtn" class="secondary" disabled>취소</button>
                <div class="small status" id="status">대기 중</div>
            </div>
            <div class="progress"><div class="bar" id="bar"></div></div>
        </div>
    </header>

    <main class="card">
        <div class="row">
            <div class="small">정렬: 어제 수익률 내림차순 · 어제 거래대금(USDT) 표시</div>
            <div class="right small" id="summary"></div>
        </div>
        <table id="table">
            <thead>
                <tr>
                    <th>심볼</th>
                    <th>어제 수익률</th>
                    <th>어제 시가</th>
                    <th>어제 종가</th>
                    <th>어제 거래대금(USDT)</th>
                    <th>링크</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </main>

    <script>
        //    바이낸스 선물 REST (Futures)
        const FAPI = "https://fapi.binance.com";
        const $ = (sel) => document.querySelector(sel);

        const ui = {
            scanBtn: $("#scanBtn"),
            cancelBtn: $("#cancelBtn"),
            minQuote: $("#minQuote"),
            concurrency: $("#concurrency"),
            retries: $("#retries"),
            bar: $("#bar"),
            status: $("#status"),
            tbody: document.querySelector("#table tbody"),
            summary: $("#summary"),
        };

        let aborter = null;

        function fmt(x, digits = 2) {
            if (x === null || x === undefined || Number.isNaN(x)) return "-";
            return Number(x).toLocaleString(undefined, { maximumFractionDigits: digits });
        }

        function pill(pct) {
            const cls = pct >= 0 ? "pos" : "neg";
            const sign = pct > 0 ? "+" : "";
            return `<span class="pill ${cls}">${sign}${fmt(pct, 2)}%</span>`;
        }

        async function fetchJSON(url, signal, tries = 1) {
            let lastErr;
            for (let i = 0; i < Math.max(1, tries); i++) {
                try {
                    const res = await fetch(url, { signal, cache: "no-cache", credentials: "omit" });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } catch (e) {
                    lastErr = e;
                    if (signal?.aborted) throw e;
                    await new Promise(r => setTimeout(r, 250 * (i + 1)));
                }
            }
            throw lastErr;
        }

        async function getPerpUSDTList(signal) {
            const info = await fetchJSON(`${FAPI}/fapi/v1/exchangeInfo`, signal);
            const list = (info.symbols || []).filter(s =>
                s.contractType === "PERPETUAL" &&
                s.quoteAsset === "USDT" &&
                s.status === "TRADING"
            ).map(s => s.symbol);
            return list;
        }

        // 1일봉 klines: limit=2 → [어제, 오늘진행중]
        async function getPrevDayStats(symbol, signal, tries) {
            const arr = await fetchJSON(
                `${FAPI}/fapi/v1/klines?symbol=${symbol}&interval=1d&limit=2`,
                signal,
                tries
            );
            if (!Array.isArray(arr) || arr.length < 1) return null;

            // 안전하게: 길이가 2면 [0]=어제, [1]=오늘진행; 길이 1인 경우도 대비
            const prev = arr.length >= 2 ? arr[0] : arr[0];
            const open = Number(prev[1]);
            const close = Number(prev[4]);
            const quoteVol = Number(prev[7]); // 거래대금(USDT)
            if (!isFinite(open) || !isFinite(close)) return null;

            const changePct = ((close - open) / open) * 100;
            return { symbol, open, close, changePct, quoteVol };
        }

        async function poolMap(items, worker, limit, signal) {
            const ret = [];
            let i = 0, inFlight = 0, done = 0;

            return new Promise((resolve, reject) => {
                const kick = () => {
                    if (signal?.aborted) return reject(new DOMException("Aborted", "AbortError"));
                    while (inFlight < limit && i < items.length) {
                        const idx = i++, item = items[idx];
                        inFlight++;
                        Promise.resolve()
                            .then(() => worker(item))
                            .then(val => { ret[idx] = val; })
                            .catch(err => { ret[idx] = null; console.error(item, err); })
                            .finally(() => {
                                inFlight--; done++;
                                const pct = (done / items.length) * 100;
                                ui.bar.style.width = `${pct}%`;
                                ui.status.textContent = `처리 중… ${done}/${items.length}`;
                                if (done === items.length) resolve(ret);
                                else kick();
                            });
                    }
                };
                kick();
            });
        }

        function renderRows(rows) {
            ui.tbody.innerHTML = rows.map(r => `
                <tr>
                    <td>${r.symbol.replace("USDT", "/USDT")}</td>
                    <td>${pill(r.changePct)}</td>
                    <td>${fmt(r.open, 6)}</td>
                    <td>${fmt(r.close, 6)}</td>
                    <td>${fmt(r.quoteVol, 0)}</td>
                    <td>
                        <a href="https://www.binance.com/en/futures/${r.symbol}" target="_blank" rel="noopener">Binance</a> ·
                        <a href="https://www.tradingview.com/chart/?symbol=BINANCE:${r.symbol}" target="_blank" rel="noopener">TV</a>
                    </td>
                </tr>
            `).join("");
        }

        async function scan() {
            try {
                // UI 준비
                ui.scanBtn.disabled = true;
                ui.cancelBtn.disabled = false;
                ui.tbody.innerHTML = "";
                ui.summary.textContent = "";
                ui.bar.style.width = "0%";
                ui.status.textContent = "심볼 목록 불러오는 중…";

                aborter = new AbortController();
                const signal = aborter.signal;

                const retries = Math.max(0, Number(ui.retries.value) | 0);
                const limit = Math.min(20, Math.max(1, Number(ui.concurrency.value) | 0));
                const minQuote = Math.max(0, Number(ui.minQuote.value) || 0);

                // 1) USDT 무기한 종목 수집
                const symbols = await getPerpUSDTList(signal);

                // 2) 통계 수집 (동시 요청 제한)
                const stats = await poolMap(
                    symbols,
                    (sym) => getPrevDayStats(sym, signal, retries + 1),
                    limit,
                    signal
                );

                // 3) 필터/정렬
                const rows = stats
                    .filter(Boolean)
                    .filter(r => isFinite(r.changePct) && isFinite(r.quoteVol))
                    .filter(r => r.quoteVol >= minQuote)
                    .sort((a, b) => b.changePct - a.changePct);

                // 4) 렌더
                renderRows(rows);
                ui.summary.textContent = `표시: ${rows.length}개 / 전체: ${symbols.length}개 (거래대금 ≥ ${fmt(minQuote, 0)} USDT)`;
                ui.status.textContent = "완료";
            } catch (e) {
                if (e?.name === "AbortError") {
                    ui.status.textContent = "사용자 취소";
                } else {
                    console.error(e);
                    ui.status.textContent = "에러 발생 – 콘솔 확인";
                }
            } finally {
                ui.scanBtn.disabled = false;
                ui.cancelBtn.disabled = true;
                aborter = null;
            }
        }

        ui.scanBtn.addEventListener("click", scan);
        ui.cancelBtn.addEventListener("click", () => {
            if (aborter) aborter.abort();
        });
    </script>
</body>
</html>
