<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Binance USDT-PERP 15m 단타 스캐너</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { margin:0; font-family: ui-sans-serif,system-ui; background:#0b1220; color:#e8eefc; }
        header { padding:20px; border-bottom:1px solid #1b2742; }
        h1 { margin:0 0 8px; font-size:20px; }
        p.note { margin:6px 0 0; color:#9fb0d0; font-size:13px; }
        main { padding:16px 20px 72px; max-width:1200px; }
        button { padding:10px 16px; border-radius:8px; cursor:pointer; font-size:14px; }
        button.primary { background:linear-gradient(180deg,#1e86ff,#1063cf); border:0; color:#fff; }
        .progress { height:10px; background:#122043; border-radius:999px; overflow:hidden; margin:14px 0; }
        .bar { height:100%; width:0%; background:linear-gradient(90deg,#37a8ff,#6ab0ff); transition:width .2s; }
        table { width:100%; border-collapse:collapse; margin-top:12px; }
        th,td { padding:8px 10px; border-bottom:1px solid #1b2742; text-align:left; font-size:13px; }
        th { background:#0f1a33; position:sticky; top:0; }
        .ok { color:#35c46a; }
        .bad { color:#ff6a6a; }
        .small { font-size:12px; color:#9fb0d0; }
    </style>
</head>
<body>
<header>
    <h1>15분 단타 스캐너</h1>
    <p class="note">조건: (1) 2봉전 종가 < 50EMA (2) 1봉전 종가 > 50EMA (3) ADX≥20 (4) +DI > -DI</p>
</header>
<main>
    <button id="scanBtn" class="primary">스캔 시작</button>
    <span id="status" class="small">준비됨</span>
    <div class="progress"><div class="bar" id="bar"></div></div>

    <table>
        <thead>
            <tr>
                <th>#</th><th>심볼</th><th>현재가</th>
                <th>ADX</th><th>+DI</th><th>-DI</th>
                <th>추세율%</th><th>최종 점수</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</main>

<script>
const API = "https://fapi.binance.com";
const $scanBtn = document.getElementById('scanBtn');
const $status = document.getElementById('status');
const $bar = document.getElementById('bar');
const $tbody = document.getElementById('tbody');

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function fmt(x,d=2){return (x==null||x==='')?'':Number(x).toFixed(d);}
function pf(x){if(x==null||x==='')return ''; const n=Number(x); return n>=0?`+${n.toFixed(2)}%`:`${n.toFixed(2)}%`; }

async function fetchUSDTPerpSymbols(){
    const res=await fetch(`${API}/fapi/v1/exchangeInfo`);
    const j=await res.json();
    return j.symbols.filter(s=>s.quoteAsset==='USDT'&&s.contractType==='PERPETUAL'&&s.status==='TRADING').map(s=>s.symbol);
}
async function fetchKlines(symbol,limit=300){
    const url=`${API}/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=${limit}`;
    const res=await fetch(url); return (await res.json()).map(r=>({open:+r[1],high:+r[2],low:+r[3],close:+r[4]}));
}
async function fetchPrices(){
    const res=await fetch(`${API}/fapi/v1/ticker/price`);
    const j=await res.json(); return new Map(j.map(o=>[o.symbol,+o.price]));
}
function ema(vals,len){const k=2/(len+1);const out=[];let sum=0;for(let i=0;i<len;i++)sum+=vals[i];out[len-1]=sum/len;for(let i=len;i<vals.length;i++){out[i]=vals[i]*k+out[i-1]*(1-k);}return out;}
function computeADX(candles,period=14){
    const H=candles.map(c=>c.high),L=candles.map(c=>c.low),C=candles.map(c=>c.close);
    let tr=[],pDM=[],mDM=[];
    for(let i=1;i<candles.length;i++){
        let up=H[i]-H[i-1],dn=L[i-1]-L[i];
        pDM[i]=(up>dn&&up>0)?up:0; mDM[i]=(dn>up&&dn>0)?dn:0;
        let r1=H[i]-L[i],r2=Math.abs(H[i]-C[i-1]),r3=Math.abs(L[i]-C[i-1]);
        tr[i]=Math.max(r1,r2,r3);
    }
    let atr=0,pd=0,md=0;
    for(let i=1;i<=period;i++){atr+=tr[i];pd+=pDM[i];md+=mDM[i];}
    atr/=period; pd/=period; md/=period;
    let plusDI=100*(pd/atr),minusDI=100*(md/atr),dx=100*Math.abs(plusDI-minusDI)/(plusDI+minusDI);
    let adx=dx;
    for(let i=period+1;i<candles.length;i++){
        atr=(atr*(period-1)+tr[i])/period;
        pd=(pd*(period-1)+pDM[i])/period;
        md=(md*(period-1)+mDM[i])/period;
        plusDI=100*(pd/atr); minusDI=100*(md/atr);
        dx=100*Math.abs(plusDI-minusDI)/(plusDI+minusDI);
        adx=(adx*(period-1)+dx)/period;
    }
    return {adx,plusDI,minusDI};
}
function singleTrend(candles,len,lastPrice){
    const closes=candles.map(c=>c.close);
    const e=ema(closes,len); const iPrev=closes.length-2,iPrev2=closes.length-3;
    if(iPrev2<0||!e[iPrev]||!e[iPrev2]) return {ok:false};
    const cond=closes[iPrev2]<e[iPrev2] && closes[iPrev]>e[iPrev];
    const priceNow=lastPrice??closes[iPrev];
    const dist=((priceNow-e[iPrev])/e[iPrev])*100;
    const slopeLookback=5,emaSlope=(iPrev-slopeLookback>=0)?((e[iPrev]-e[iPrev-slopeLookback])/e[iPrev-slopeLookback])*100:0;
    const trend=dist*0.6+emaSlope*0.4;
    return {ok:cond,trend};
}

$scanBtn.onclick=async()=>{
    $tbody.innerHTML=''; $status.textContent='심볼 불러오는 중...'; const syms=await fetchUSDTPerpSymbols();
    const priceMap=await fetchPrices(); let done=0; const out=[];
    for(const sym of syms){
        try{
            const kl=await fetchKlines(sym,300);
            const lastPrice=priceMap.get(sym);
            const {adx,plusDI,minusDI}=computeADX(kl);
            const {ok,trend}=singleTrend(kl,50,lastPrice);
            if(ok && adx>=20 && plusDI>minusDI){
                const finalScore=trend*(1+Math.max(0,adx-20)/100);
                out.push({sym,lastPrice,adx,plusDI,minusDI,trend,finalScore});
            }
        }catch(e){}
        done++; $bar.style.width=(done/syms.length*100).toFixed(1)+'%';
        $status.textContent=`스캔중... ${done}/${syms.length}`;
        await sleep(30);
    }
    out.sort((a,b)=>b.finalScore-a.finalScore);
    $tbody.innerHTML='';
    out.forEach((r,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${i+1}</td><td>${r.sym}</td>
        <td>${fmt(r.lastPrice)}</td><td>${r.adx.toFixed(2)}</td>
        <td>${r.plusDI.toFixed(2)}</td><td>${r.minusDI.toFixed(2)}</td>
        <td>${pf(r.trend)}</td><td class="ok">${pf(r.finalScore)}</td>`;
        $tbody.appendChild(tr);
    });
    $status.textContent=`완료: ${out.length}종목 조건 충족`;
};
</script>
</body>
</html>
