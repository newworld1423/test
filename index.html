<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Binance Futures 15m EMA50/200 조건 스캐너 (USDT Perp)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root{
            --bg:#0b0c0f; --card:#151821; --muted:#8b92a6; --text:#e8ebf1;
            --pos:#1db954; --neg:#ff4d4f; --accent:#6ea8fe; --line:#2a2f3a;
        }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',Arial}
        header{max-width:1200px;margin:0 auto;padding:24px 16px 8px}
        h1{margin:0 0 6px;font-size:20px}
        .muted{color:var(--muted)}
        .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px}
        .controls label{display:flex;align-items:center;gap:6px;background:var(--card);border:1px solid var(--line);padding:8px 10px;border-radius:8px}
        .controls input{background:transparent;border:none;outline:none;color:var(--text);width:140px}
        .btn{background:var(--accent);color:#0b0c0f;border:none;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
        .btn:disabled{opacity:.6;cursor:not-allowed}
        .wrap{max-width:1200px;margin:0 auto;padding:0 16px 24px}
        table{width:100%;border-collapse:collapse;margin-top:16px}
        th,td{border-bottom:1px solid var(--line);padding:10px;text-align:center}
        th{background:var(--card);position:sticky;top:0}
        tbody tr:hover{background:#12141a}
        .right{text-align:right}
        .pos{color:var(--pos)}
        .neg{color:var(--neg)}
        .badge{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:#11141a;color:var(--muted);font-size:12px}
        .status{margin-top:8px}
        .footer-note{margin-top:10px;color:var(--muted);font-size:12px}
        .small{font-size:12px}
        .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    </style>
</head>
<body>
<header>
    <h1>바이낸스 선물 15분봉 EMA50/200 조건 스캐너 <span class="badge">USDT Perp</span></h1>
    <div class="muted small">
        조건: <span class="mono">2봉 전 C &gt; EMA50 &amp;&amp; C &lt; EMA200</span> ·
        <span class="mono">1봉 전 C &gt; EMA200 &amp;&amp; C &gt; EMA50</span>
    </div>

    <div class="controls">
        <label>최소 24h 거래대금(USDT):
            <input id="minQuoteVolume" type="number" step="100000" value="0" />
        </label>
        <label>동시성(Concurrent):
            <input id="concurrency" type="number" min="1" max="20" value="8" />
        </label>
        <button id="scanBtn" class="btn">재스캔</button>
        <span id="status" class="status muted">대기 중…</span>
    </div>
</header>

<div class="wrap">
    <table id="resultTable">
        <thead>
            <tr>
                <th style="width:140px">심볼</th>
                <th>최신가</th>
                <th>24h 거래대금 (quoteVolume, USDT)</th>
                <th>24h 변동률</th>
                <th>조건 체크(2봉/1봉)</th>
                <th>체크 시각</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <div class="footer-note">
        데이터: Binance Futures API (USDT Perpetual). 15분봉 최근 300개로 EMA50/EMA200 계산. 진행 중 봉은 제외하고 <b>1·2봉 전</b>으로 판정합니다.
    </div>
</div>

<script>
    // ====== 설정 ======
    const FAPI = 'https://fapi.binance.com'; // Binance Futures API base
    const INTERVAL = '15m';
    const LIMIT = 300; // EMA 계산 여유치
    const EMA_50 = 50;
    const EMA_200 = 200;

    const $tbody = document.querySelector('#resultTable tbody');
    const $scanBtn = document.getElementById('scanBtn');
    const $status = document.getElementById('status');
    const $minQuoteVolume = document.getElementById('minQuoteVolume');
    const $concurrency = document.getElementById('concurrency');

    // 숫자 포맷터
    const fmt0 = (n) => Number(n).toLocaleString('en-US', { maximumFractionDigits: 0 });
    const fmt2 = (n) => Number(n).toLocaleString('en-US', { maximumFractionDigits: 2 });
    const pct = (n) => (Number(n) >= 0 ? `<span class="pos">+${fmt2(n)}%</span>` : `<span class="neg">${fmt2(n)}%</span>`);

    // 지수이동평균
    function ema(values, period) {
        const k = 2 / (period + 1);
        const out = new Array(values.length).fill(null);
        let sum = 0;
        for (let i = 0; i < values.length; i++) {
            const v = Number(values[i]);
            if (i < period) {
                sum += v;
                if (i === period - 1) out[i] = sum / period;
            } else {
                out[i] = v * k + out[i - 1] * (1 - k);
            }
        }
        return out;
    }

    // 제한 동시성 실행
    async function pLimitAll(items, limit, worker) {
        const results = [];
        let i = 0;
        const workers = new Array(Math.min(limit, items.length)).fill(0).map(async () => {
            while (i < items.length) {
                const cur = i++;
                try {
                    results[cur] = await worker(items[cur], cur);
                } catch (e) {
                    results[cur] = { error: e };
                }
            }
        });
        await Promise.all(workers);
        return results;
    }

    async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status} @ ${url}`);
        return res.json();
    }

    async function getPerpUSDTTradingSymbols() {
        const info = await fetchJSON(`${FAPI}/fapi/v1/exchangeInfo`);
        return info.symbols
            .filter(s => s.contractType === 'PERPETUAL' && s.quoteAsset === 'USDT' && s.status === 'TRADING')
            .map(s => s.symbol);
    }

    async function get24hTickersMap() {
        const arr = await fetchJSON(`${FAPI}/fapi/v1/ticker/24hr`);
        const map = new Map();
        for (const t of arr) map.set(t.symbol, t);
        return map;
    }

    async function getKlines(symbol) {
        const url = `${FAPI}/fapi/v1/klines?symbol=${symbol}&interval=${INTERVAL}&limit=${LIMIT}`;
        const data = await fetchJSON(url);
        const closes = data.map(k => Number(k[4]));
        return { closes, raw: data };
    }

    function checkCondition(closes) {
        // EMA200까지 필요 → 최소 202개 이상 + 판정용 2봉 여유
        if (!closes || closes.length < EMA_200 + 2) return { ok: false };
        const e50 = ema(closes, EMA_50);
        const e200 = ema(closes, EMA_200);
        const n = closes.length;

        const c2 = closes[n - 3];      // 2봉 전 종가
        const c1 = closes[n - 2];      // 1봉 전 종가
        const e50_2 = e50[n - 3];
        const e50_1 = e50[n - 2];
        const e200_2 = e200[n - 3];
        const e200_1 = e200[n - 2];

        if ([e50_2,e50_1,e200_2,e200_1].some(v => v == null)) return { ok: false };

        // 조건:
        // 1) 2봉 전: C > EMA50 && C < EMA200
        // 2) 1봉 전: C > EMA200 && C > EMA50
        const cond2 = (c2 > e50_2) && (c2 < e200_2);
        const cond1 = (c1 > e200_1) && (c1 > e50_1);
        const ok = cond2 && cond1;

        return { ok, values: { c2, e50_2, e200_2, c1, e50_1, e200_1 } };
    }

    function renderRows(rows) {
        $tbody.innerHTML = '';
        const now = new Date();
        for (const r of rows) {
            const tr = document.createElement('tr');

            const symTD = document.createElement('td');
            symTD.innerHTML = `<a href="https://www.binance.com/ko/futures/${r.symbol}" target="_blank" rel="noopener">${r.symbol}</a>`;
            tr.appendChild(symTD);

            const priceTD = document.createElement('td');
            priceTD.className = 'right mono';
            priceTD.textContent = r.lastPrice != null ? r.lastPrice : '-';
            tr.appendChild(priceTD);

            const qvTD = document.createElement('td');
            qvTD.className = 'right mono';
            qvTD.textContent = r.quoteVolume != null ? fmt0(r.quoteVolume) : '-';
            tr.appendChild(qvTD);

            const chgTD = document.createElement('td');
            chgTD.innerHTML = r.priceChangePercent != null ? pct(r.priceChangePercent) : '-';
            tr.appendChild(chgTD);

            const condTD = document.createElement('td');
            const v = r.check?.values || {};
            condTD.innerHTML =
                `<div class="small">
                    <div><span class="badge">2봉 전</span> C=${fmt2(v.c2)} · EMA50=${fmt2(v.e50_2)} · EMA200=${fmt2(v.e200_2)}</div>
                    <div><span class="badge">1봉 전</span> C=${fmt2(v.c1)} · EMA50=${fmt2(v.e50_1)} · EMA200=${fmt2(v.e200_1)}</div>
                 </div>`;
            tr.appendChild(condTD);

            const timeTD = document.createElement('td');
            timeTD.className = 'small';
            timeTD.textContent = now.toLocaleString();
            tr.appendChild(timeTD);

            $tbody.appendChild(tr);
        }
    }

    async function scan() {
        try {
            $scanBtn.disabled = true;
            $status.textContent = '심볼 수집 중…';

            const [symbols, tickerMap] = await Promise.all([
                getPerpUSDTTradingSymbols(),
                get24hTickersMap()
            ]);

            // 사전 필터: 최소 거래대금
            const minQV = Number($minQuoteVolume.value || 0);
            const cand = symbols.filter(s => {
                const t = tickerMap.get(s);
                return t && Number(t.quoteVolume) >= minQV;
            });

            $status.textContent = `총 ${symbols.length}개 중 거래대금 ≥ ${fmt0(minQV)} 조건 통과 ${cand.length}개 → 15분봉/EMA 체크 중…`;

            const conc = Math.max(1, Math.min(20, Number($concurrency.value || 8)));
            const results = await pLimitAll(cand, conc, async (symbol) => {
                try {
                    const { closes } = await getKlines(symbol);
                    const check = checkCondition(closes);
                    if (!check.ok) return null;

                    const t = tickerMap.get(symbol) || {};
                    return {
                        symbol,
                        check,
                        lastPrice: t.lastPrice ? Number(t.lastPrice) : null,
                        quoteVolume: t.quoteVolume ? Number(t.quoteVolume) : null,
                        priceChangePercent: t.priceChangePercent ? Number(t.priceChangePercent) : null
                    };
                } catch {
                    return null;
                }
            });

            const matched = results.filter(Boolean);
            // 거래대금 "낮은 순" (오름차순)
            matched.sort((a, b) => (a.quoteVolume || 0) - (b.quoteVolume || 0));

            renderRows(matched);
            $status.textContent = `완료: 조건 일치 ${matched.length}개 (정렬: 24h 거래대금 오름차순)`;
        } catch (e) {
            console.error(e);
            $status.textContent = `에러: ${e.message || e}`;
        } finally {
            $scanBtn.disabled = false;
        }
    }

    document.getElementById('scanBtn').addEventListener('click', scan);
    scan(); // 초기 1회 자동 실행
</script>
</body>
</html>