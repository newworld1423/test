<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Binance USDT Perp 1m — 50EMA Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --gap: 12px;
            --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
        }
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", Arial, sans-serif;
            line-height: 1.45;
            margin: 0 auto;
            padding: 24px;
            max-width: 1200px;
        }
        h1 { margin: 0 0 8px; }
        .bar {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: var(--gap);
            margin-bottom: 16px;
            align-items: end;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--gap);
        }
        .controls label {
            display: flex;
            flex-direction: column;
            font-size: 14px;
            gap: 6px;
        }
        input[type="number"], select {
            height: 36px;
            padding: 0 8px;
            font-size: 14px;
        }
        button {
            height: 40px;
            padding: 0 14px;
            font-size: 14px;
            cursor: pointer;
        }
        .status {
            font-family: var(--mono);
            white-space: pre-wrap;
            background: #f6f8fa;
            border: 1px solid #e5e7eb;
            padding: 10px;
            border-radius: 6px;
            min-height: 44px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-variant-numeric: tabular-nums;
        }
        thead th {
            position: sticky;
            top: 0;
            background: #fff;
            border-bottom: 2px solid #e5e7eb;
            text-align: left;
            padding: 10px 8px;
            font-size: 13px;
        }
        tbody td {
            border-bottom: 1px solid #eee;
            padding: 8px;
            font-size: 13px;
        }
        .right { text-align: right; }
        .mono  { font-family: var(--mono); }
        .green { color: #138000; }
        .red   { color: #b00020; }
        .muted { color: #6b7280; }
        .chip {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #eef2ff;
            border: 1px solid #dbeafe;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Binance 선물 USDT — 1분봉 50EMA 스캐너</h1>
    <p class="muted">최근 200개 1분봉에서 <strong>종가 &gt; 50EMA</strong> 인 봉 개수를 세고, 많은 순으로 정렬합니다.</p>

    <div class="bar">
        <div class="controls">
            <label>
                봉 개수 (limit)
                <input id="limit" type="number" min="60" max="1000" value="200" />
            </label>
            <label>
                EMA 기간
                <input id="period" type="number" min="2" max="500" value="50" />
            </label>
            <label>
                동시 요청 (concurrency)
                <input id="concurrency" type="number" min="1" max="20" value="8" />
            </label>
            <label>
                간격(ms, 배치마다)
                <input id="batchDelay" type="number" min="0" max="5000" value="400" />
            </label>
            <label>
                인터벌
                <select id="interval">
                    <option value="1m" selected>1m</option>
                    <option value="3m">3m</option>
                    <option value="5m">5m</option>
                    <option value="15m">15m</option>
                </select>
            </label>
            <div style="align-self:center; display:flex; gap:8px; margin-top: 20px;">
                <button id="btnScan">스캔 시작</button>
                <button id="btnStop" disabled>중지</button>
                <button id="btnExport" disabled>CSV 내보내기</button>
            </div>
        </div>
        <div style="justify-self:end; align-self:center;">
            <span class="chip" id="chipSymbols">-</span>
        </div>
    </div>

    <div class="status" id="status">준비됨.</div>

    <table id="resultTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Symbol</th>
                <th class="right">count_above</th>
                <th class="right">defined_bars</th>
                <th class="right">pct_above</th>
                <th class="right">last_close</th>
                <th class="right">last_ema50</th>
                <th>last_above</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

<script>
(function(){
    "use strict";

    const API_BASE = "https://fapi.binance.com";
    const $ = (sel) => document.querySelector(sel);

    const els = {
        limit: $("#limit"),
        period: $("#period"),
        concurrency: $("#concurrency"),
        batchDelay: $("#batchDelay"),
        interval: $("#interval"),
        btnScan: $("#btnScan"),
        btnStop: $("#btnStop"),
        btnExport: $("#btnExport"),
        status: $("#status"),
        tableBody: $("#resultTable tbody"),
        chipSymbols: $("#chipSymbols"),
    };

    let stopRequested = false;
    let results = [];

    function setStatus(text) {
        els.status.textContent = text;
    }

    function sleep(ms) {
        return new Promise(res => setTimeout(res, ms));
    }

    async function fetchJSON(url, params) {
        const u = new URL(url);
        if (params && typeof params === "object") {
            Object.entries(params).forEach(([k, v]) => u.searchParams.set(k, v));
        }
        const r = await fetch(u.toString(), { method: "GET" });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        return r.json();
    }

    async function getUSDTPerpSymbols() {
        const data = await fetchJSON(`${API_BASE}/fapi/v1/exchangeInfo`);
        const symbols = (data.symbols || [])
            .filter(s =>
                s.quoteAsset === "USDT" &&
                s.contractType === "PERPETUAL" &&
                s.status === "TRADING"
            )
            .map(s => s.symbol)
            .sort();
        return symbols;
    }

    async function getKlines1m(symbol, interval, limit) {
        return fetchJSON(`${API_BASE}/fapi/v1/klines`, {
            symbol,
            interval,
            limit: String(limit)
        });
    }

    function ema(values, period) {
        const out = new Array(values.length).fill(NaN);
        if (values.length < period) return out;

        let sum = 0;
        for (let i = 0; i < period; i++) sum += values[i];
        const sma = sum / period;
        out[period - 1] = sma;

        const k = 2 / (period + 1);
        let prev = sma;
        for (let i = period; i < values.length; i++) {
            prev = (values[i] - prev) * k + prev;
            out[i] = prev;
        }
        return out;
    }

    function analyzeSymbol(symbol, klines, period) {
        const closes = klines.map(k => parseFloat(k[4]));
        const emaVec = ema(closes, period);

        let count = 0;
        let defined = 0;
        for (let i = 0; i < closes.length; i++) {
            const e = emaVec[i];
            if (!Number.isNaN(e)) {
                defined++;
                if (closes[i] > e) count++;
            }
        }
        const pct = defined ? (count / defined * 100) : 0;
        const lastClose = closes[closes.length - 1];
        const lastEma = emaVec[emaVec.length - 1];
        const lastAbove = !Number.isNaN(lastEma) ? (lastClose > lastEma) : false;

        return {
            symbol,
            count_above: count,
            defined_bars: defined,
            pct_above: Number(pct.toFixed(2)),
            last_close: lastClose,
            last_ema50: lastEma,
            last_above: lastAbove
        };
    }

    function renderTable(rows) {
        const tbody = els.tableBody;
        tbody.innerHTML = "";
        rows.forEach((row, idx) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="right mono">${idx + 1}</td>
                <td class="mono">${row.symbol}</td>
                <td class="right mono">${row.count_above}</td>
                <td class="right mono">${row.defined_bars}</td>
                <td class="right mono">${row.pct_above.toFixed(2)}%</td>
                <td class="right mono">${row.last_close}</td>
                <td class="right mono">${Number.isNaN(row.last_ema50) ? "-" : row.last_ema50}</td>
                <td>${row.last_above ? '<span class="green">▲</span>' : '<span class="red">▼</span>'}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function sortResults(arr) {
        return [...arr].sort((a, b) => {
            if (b.count_above !== a.count_above) return b.count_above - a.count_above;
            if (b.pct_above !== a.pct_above) return b.pct_above - a.pct_above;
            return (b.last_above === a.last_above) ? 0 : (b.last_above ? 1 : -1);
        });
    }

    function chunk(array, size) {
        const out = [];
        for (let i = 0; i < array.length; i += size) out.push(array.slice(i, i + size));
        return out;
    }

    async function scan() {
        stopRequested = false;
        results = [];
        els.btnScan.disabled = true;
        els.btnStop.disabled = false;
        els.btnExport.disabled = true;
        setStatus("심볼 목록 불러오는 중...");

        try {
            const symbols = await getUSDTPerpSymbols();
            els.chipSymbols.textContent = `${symbols.length} symbols`;
            setStatus(`총 ${symbols.length}개 심볼 스캔 시작`);

            const limit = Math.max(60, Math.min(1000, parseInt(els.limit.value, 10) || 200));
            const period = Math.max(2, Math.min(500, parseInt(els.period.value, 10) || 50));
            const interval = els.interval.value;
            const concurrency = Math.max(1, Math.min(20, parseInt(els.concurrency.value, 10) || 8));
            const batchDelay = Math.max(0, Math.min(5000, parseInt(els.batchDelay.value, 10) || 400));

            // 배치(동시 요청 제한)
            const batches = chunk(symbols, concurrency);
            let done = 0;

            for (let b = 0; b < batches.length; b++) {
                if (stopRequested) break;

                const tasks = batches[b].map(async (sym) => {
                    try {
                        const kl = await getKlines1m(sym, interval, limit);
                        const row = analyzeSymbol(sym, kl, period);
                        results.push(row);
                    } catch (err) {
                        // 실패 심볼은 건너뜀
                    } finally {
                        done++;
                    }
                });

                await Promise.all(tasks);

                const sorted = sortResults(results);
                renderTable(sorted);
                setStatus(`진행: ${done}/${symbols.length} (배치 ${b + 1}/${batches.length})`);

                if (b < batches.length - 1 && batchDelay > 0) {
                    await sleep(batchDelay);
                }
            }

            const finalSorted = sortResults(results);
            renderTable(finalSorted);
            setStatus(stopRequested
                ? `중지됨. 수집된 ${results.length}개 심볼 결과 정렬 완료`
                : `완료! ${results.length}개 심볼 스캔 및 정렬 완료`
            );
            els.btnExport.disabled = results.length === 0;

        } catch (e) {
            console.error(e);
            setStatus(`오류: ${e && e.message ? e.message : e}`);
        } finally {
            els.btnScan.disabled = false;
            els.btnStop.disabled = true;
        }
    }

    function stop() {
        stopRequested = true;
        els.btnStop.disabled = true;
        setStatus("중지 요청됨… 현재 배치가 끝나면 멈춥니다.");
    }

    function toCSV(rows) {
        const headers = [
            "symbol",
            "count_above",
            "defined_bars",
            "pct_above",
            "last_close",
            "last_ema50",
            "last_above"
        ];
        const lines = [headers.join(",")];
        rows.forEach(r => {
            const line = [
                r.symbol,
                r.count_above,
                r.defined_bars,
                r.pct_above,
                r.last_close,
                Number.isNaN(r.last_ema50) ? "" : r.last_ema50,
                r.last_above
            ].join(",");
            lines.push(line);
        });
        return lines.join("\n");
    }

    function exportCSV() {
        const sorted = sortResults(results);
        const csv = toCSV(sorted);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const ts = new Date().toISOString().replace(/[-:T]/g, "").slice(0, 14);
        const name = `binance_usdt_perp_1m_ema50_scan_${ts}.csv`;

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    els.btnScan.addEventListener("click", scan);
    els.btnStop.addEventListener("click", stop);
    els.btnExport.addEventListener("click", exportCSV);

    // 최초 상태
    renderTable([]);
})();
</script>
</body>
</html>