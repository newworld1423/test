<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>USDT Perp — 1분봉 직전봉 99SMA 크로스 스캐너 (전체 심볼)</title>
    <style>
        :root {
            --bg:#0b0f14; --card:#111827; --muted:#9ca3af; --text:#e5e7eb;
            --ok:#22c55e; --no:#ef4444; --warn:#f59e0b; --border:#1f2937;
        }
        html, body { height: 100%; }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
        }
        .wrap { max-width: 1200px; margin: 28px auto; padding: 0 16px; }
        h1 { margin: 0 0 8px 0; }
        .hint { color: var(--muted); font-size: 12px; }
        .toolbar {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            margin: 12px 0;
            align-items: center;
        }
        .btn {
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: #182033;
            color: var(--text);
            font-weight: 700;
            cursor: pointer;
        }
        .btn[disabled] { opacity: .6; cursor: not-allowed; }
        progress { width: 100%; height: 10px; accent-color: var(--ok); display: none; }
        .panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
        }
        .stats { color: var(--muted); font-size: 14px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        thead th {
            text-align: left; padding: 10px 8px; border-bottom: 1px solid var(--border); color: var(--muted);
        }
        tbody td { padding: 10px 8px; border-bottom: 1px solid var(--border); }
        .right { text-align: right; }
        .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; }
        .tag { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #14532d; background:#0b2f1f; color:#86efac; font-size:12px; vertical-align:middle; }
        .ok { color: var(--ok); font-weight: 800; }
        .error { color: var(--no); margin-top: 10px; font-size: 13px; }
        .badge-w { display:inline-block; padding:2px 6px; border-radius:6px; background:#0e1525; border:1px solid var(--border); font-size:12px; }
    </style>
</head>
<body>
<div class="wrap">
    <h1>USDT Perp — 1분봉 직전봉 99SMA 크로스 스캐너</h1>
    <div class="hint">조건: <b>직전 1분봉 저가 &lt; 99SMA</b> AND <b>직전 1분봉 고가 &gt; 99SMA</b> • SMA(99)는 직전봉까지의 종가로 계산 • 1분봉은 <b>바이낸스 서버(UTC)</b> 기준</div>

    <div class="toolbar">
        <div class="stats" id="stats">대기 중</div>
        <div style="display:flex; gap:8px;">
            <button id="scanBtn" class="btn">스캔 시작</button>
        </div>
    </div>

    <progress id="prog" value="0" max="100"></progress>

    <div class="panel" style="margin-top:12px;">
        <table>
            <thead>
                <tr>
                    <th style="width:64px;">순위</th>
                    <th>심볼</th>
                    <th class="right">직전봉 시간(OPEN)</th>
                    <th class="right">저가(L)</th>
                    <th class="right">99SMA</th>
                    <th class="right">고가(H)</th>
                    <th class="right">관통폭</th>
                </tr>
            </thead>
            <tbody id="rows">
                <tr><td colspan="7" style="padding:18px; color:var(--muted);">스캔을 시작하면 결과가 표시됩니다.</td></tr>
            </tbody>
        </table>
        <div id="error" class="error" style="display:none;"></div>
    </div>

    <div class="hint" id="syncInfo" style="margin-top:8px;">분 경계 동기화 대기 중…</div>
</div>

<script>
    // ===================== 설정/엔드포인트 =====================
    const API = {
        base: 'https://fapi.binance.com',
        exchangeInfo: '/fapi/v1/exchangeInfo',
        klines: '/fapi/v1/klines',
        time: '/fapi/v1/time',
    };
    const CONCURRENCY = 10; // 동시 요청 개수(레이트리밋 방지용으로 너무 높이지 마세요)

    // ===================== 포맷터/유틸 =====================
    const n6 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 6 });
    const n8 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 8 });
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    async function fetchJSON(url){
        const res = await fetch(url, { mode: 'cors' });
        if(!res.ok){
            const t = await res.text().catch(()=> '');
            throw new Error(`HTTP ${res.status} ${res.statusText}${t? ' - ' + t : ''}`);
        }
        return res.json();
    }

    function toLocal(ts){ return new Date(ts).toLocaleString(); }
    function sum(a){ return a.reduce((x,y)=>x+y,0); }

    // 간단한 풀 처리
    async function runPool(items, worker, concurrency, onProgress){
        let i=0, done=0;
        const out = new Array(items.length);
        const workers = new Array(Math.min(concurrency, items.length)).fill(0).map(async ()=>{
            while(true){
                const idx = i++;
                if(idx >= items.length) break;
                try{
                    out[idx] = await worker(items[idx], idx);
                }catch(e){
                    out[idx] = { error: e instanceof Error ? e.message : String(e) };
                }finally{
                    done++;
                    onProgress?.(done, items.length);
                }
            }
        });
        await Promise.all(workers);
        return out;
    }

    // ===================== 전역 상태 =====================
    let SYMBOLS = null;          // 스캔 대상 심볼 캐시
    let scanning = false;
    let serverOffsetMs = 0;      // 서버시간 - 로컬시간
    let tickTimeout = null;
    let tickInterval = null;

    // ===================== 서버 시간 동기화/스케줄 =====================
    async function syncServerTime(){
        const t0 = Date.now();
        const { serverTime } = await fetchJSON(`${API.base}${API.time}`);
        const t1 = Date.now();
        const rtt2 = Math.floor((t1 - t0) / 2);
        serverOffsetMs = Number(serverTime) + rtt2 - t1;
        return Number(serverTime);
    }
    function serverNow(){ return Date.now() + serverOffsetMs; }
    function msUntilNextMinute(){
        const now = serverNow();
        const next = Math.ceil(now / 60000) * 60000;
        return Math.max(0, next - now) + 200; // 여유 200ms
    }

    async function scheduleAuto(){
        const syncInfo = document.getElementById('syncInfo');
        if (tickTimeout) { clearTimeout(tickTimeout); tickTimeout = null; }
        if (tickInterval) { clearInterval(tickInterval); tickInterval = null; }

        syncInfo.textContent = '서버 시간 동기화 중…';
        try{
            await syncServerTime();
            const wait = msUntilNextMinute();
            syncInfo.textContent = `분 경계 동기화 완료 • ${Math.floor(wait/1000)}초 후 자동 스캔 시작`;
            tickTimeout = setTimeout(async ()=>{
                await scanAll();
                syncInfo.textContent = '자동 스캔: 매 1분(서버 기준) 실행 중';
                tickInterval = setInterval(()=> scanAll(), 60000);
            }, wait);
        }catch(e){
            syncInfo.textContent = `동기화 실패: ${e instanceof Error ? e.message : String(e)} • 로컬 분 기준으로 실행합니다.`;
            const wait = (60000 - (Date.now() % 60000)) + 200;
            tickTimeout = setTimeout(async ()=>{
                await scanAll();
                tickInterval = setInterval(()=> scanAll(), 60000);
            }, wait);
        }
    }

    // ===================== 심볼 로드 =====================
    async function loadSymbols(){
        if (SYMBOLS) return SYMBOLS;
        const info = await fetchJSON(`${API.base}${API.exchangeInfo}`);
        const all = info.symbols || [];
        SYMBOLS = all.filter(s =>
            s.contractType === 'PERPETUAL' &&
            s.quoteAsset === 'USDT' &&
            s.status === 'TRADING'
        ).map(s => s.symbol);
        return SYMBOLS;
    }

    // ===================== 핵심: 전체 스캔 =====================
    async function scanAll(){
        if (scanning) return; // 이전 수행 중이면 스킵
        scanning = true;

        const stats = document.getElementById('stats');
        const prog = document.getElementById('prog');
        const tbody = document.getElementById('rows');
        const errBox = document.getElementById('error');

        errBox.style.display = 'none';
        errBox.textContent = '';
        prog.style.display = 'block';
        prog.value = 0;

        try{
            const symbols = await loadSymbols();
            if (!symbols.length) throw new Error('USDT 무기한 선물 심볼을 찾을 수 없습니다.');

            stats.textContent = `스캔 준비… (심볼 ${symbols.length}개)`;
            const t0 = Date.now();
            let lastP = 0;

            const results = await runPool(
                symbols,
                async (symbol) => {
                    // 1분봉 200개(직전봉 포함 99개 이상 확보)
                    const url = `${API.base}${API.klines}?symbol=${symbol}&interval=1m&limit=200`;
                    for (let tries=0; tries<3; tries++){
                        try{
                            const data = await fetchJSON(url);
                            if (!Array.isArray(data) || data.length < 100) return null;

                            const prevIdx = data.length - 2;
                            if (prevIdx < 98) return null;

                            const prev = data[prevIdx];
                            const prevHigh = Number(prev[2]);
                            const prevLow  = Number(prev[3]);
                            const prevClose= Number(prev[4]);
                            const prevOpenTime = Number(prev[0]);

                            // SMA(99) @직전봉: prevIdx-98 .. prevIdx 의 종가
                            let sumClose = 0;
                            for (let i = prevIdx - 98; i <= prevIdx; i++){
                                sumClose += Number(data[i][4]);
                            }
                            const ma99 = sumClose / 99;

                            // 조건 체크
                            const cond1 = prevLow < ma99;
                            const cond2 = prevHigh > ma99;
                            if (!(cond1 && cond2)) return null;

                            // 관통폭(둘 중 작은 쪽 거리로 강도 추정)
                            const penetration = Math.min(prevHigh - ma99, ma99 - prevLow);

                            return {
                                symbol, t: prevOpenTime,
                                low: prevLow, ma: ma99, high: prevHigh, close: prevClose,
                                penetration
                            };
                        }catch(e){
                            if (tries === 2) throw e;
                            await sleep(200 + 300*tries);
                        }
                    }
                },
                CONCURRENCY,
                (done, total) => {
                    const p = Math.round(done * 100 / total);
                    if (p !== lastP) {
                        lastP = p;
                        prog.value = p;
                        stats.textContent = `스캔 중… ${done}/${total} (${p}%)`;
                    }
                }
            );

            // 필터/정렬
            const rows = results.filter(Boolean).sort((a,b)=> b.penetration - a.penetration);

            // 출력
            tbody.innerHTML = '';
            if (!rows.length){
                tbody.innerHTML = `<tr><td colspan="7" style="padding:18px; color:var(--muted);">조건을 만족하는 심볼이 없습니다.</td></tr>`;
            } else {
                rows.forEach((r, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="mono">${idx+1}</td>
                        <td><span class="tag">PERP</span> <strong>${r.symbol}</strong></td>
                        <td class="right mono">${toLocal(r.t)}</td>
                        <td class="right mono">${n6.format(r.low)}</td>
                        <td class="right mono">${n8.format(r.ma)}</td>
                        <td class="right mono">${n6.format(r.high)}</td>
                        <td class="right mono"><span class="badge-w">${n6.format(r.penetration)}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            const sec = ((Date.now() - t0)/1000).toFixed(1);
            stats.textContent = `완료 • 결과 ${rows.length}개 • 소요 ${sec}s • ${new Date().toLocaleString()}`;
        }catch(e){
            errBox.style.display = 'block';
            errBox.textContent = `오류: ${e instanceof Error ? e.message : String(e)}`;
            stats.textContent = '실패';
        }finally{
            prog.style.display = 'none';
            scanning = false;
        }
    }

    // ===================== 이벤트 바인딩 =====================
    document.getElementById('scanBtn').addEventListener('click', async ()=>{
        document.getElementById('stats').textContent = '스캔 시작…';
        await scanAll();      // 즉시 1회
        scheduleAuto();       // 1분봉 경계에 맞춰 자동스캔 예약
    });
</script>
</body>
</html>
