<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Binance Perp USDT — 15분봉 99MA 브레이크 스캐너</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #0b0c10;
            --card: #121318;
            --muted: #9aa0a6;
            --text: #e8eaed;
            --accent: #3ea6ff;
            --good: #00c853;
            --bad: #ff5252;
            --border: #2a2e36;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
                         Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo",
                         "Noto Sans KR", sans-serif;
            background-color: var(--bg);
            color: var(--text);
        }
        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }
        h1 {
            font-size: 20px;
            margin: 0 0 12px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }
        button {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--accent);
            color: #000;
            font-weight: 600;
            cursor: pointer;
        }
        button[disabled] {
            opacity: 0.5;
            cursor: default;
        }
        .status {
            font-size: 13px;
            color: var(--muted);
        }
        .card {
            background: var(--card);
            border-radius: 10px;
            border: 1px solid var(--border);
            padding: 12px;
            margin-top: 10px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
            font-size: 12px;
        }
        thead {
            background: rgba(255, 255, 255, 0.04);
        }
        th, td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            text-align: right;
            white-space: nowrap;
        }
        th:first-child,
        td:first-child {
            text-align: left;
        }
        th {
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .num {
            font-family: "SF Mono", "Roboto Mono", ui-monospace, Menlo, Monaco,
                         Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .good {
            color: var(--good);
        }
        .bad {
            color: var(--bad);
        }
        .muted {
            color: var(--muted);
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid var(--border);
            font-size: 11px;
            margin-left: 4px;
            color: var(--muted);
        }
        .footer-info {
            margin-top: 8px;
            font-size: 11px;
            color: var(--muted);
        }
    </style>
</head>
<body>
<div class="wrap">
    <h1>Binance Perp USDT — 15분봉 99MA 브레이크 스캐너</h1>

    <div class="controls">
        <button id="scanBtn">스캔 실행</button>
        <span class="status" id="statusText">준비됨</span>
        <span class="badge">15m · 이전봉 &gt; 99MA · 그 이전 연속 &lt; 99MA</span>
    </div>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>심볼</th>
                    <th>이전봉 종가</th>
                    <th>이전봉 99MA</th>
                    <th>이전봉 / 99MA (%)</th>
                    <th>연속 하회 캔들 수</th>
                    <th>이전봉 Quote Vol</th>
                    <th>이전봉 시간 (UTC)</th>
                </tr>
            </thead>
            <tbody id="resultBody">
                <tr>
                    <td class="muted" colspan="7">스캔을 실행하면 결과가 여기에 표시됩니다.</td>
                </tr>
            </tbody>
        </table>
        <div class="footer-info">
            · 15m 캔들 300개 조회 (약 75시간 데이터)<br>
            · 마지막 캔들은 진행 중 캔들이라 제외하고, 그 바로 전 캔들을 “이전봉”으로 사용합니다.<br>
            · 결과는 “이전봉 Quote Volume” 기준으로 내림차순 정렬됩니다.
        </div>
    </div>
</div>

<script>
    const API_BASE = 'https://fapi.binance.com';
    const INTERVAL = '15m';
    const LIMIT = 300;   // 15분봉 300개 ≒ 75시간
    const CONCURRENCY = 5; // 동시에 몇 개 심볼까지 병렬 요청할지

    const scanBtn = document.getElementById('scanBtn');
    const statusText = document.getElementById('statusText');
    const resultBody = document.getElementById('resultBody');

    function formatNumber(value, decimals) {
        const num = Number(value);
        if (!Number.isFinite(num)) return '-';
        return num.toLocaleString('en-US', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    function formatUtcTime(ms) {
        const d = new Date(ms);
        const y = d.getUTCFullYear();
        const m = String(d.getUTCMonth() + 1).padStart(2, '0');
        const day = String(d.getUTCDate()).padStart(2, '0');
        const hh = String(d.getUTCHours()).padStart(2, '0');
        const mm = String(d.getUTCMinutes()).padStart(2, '0');
        return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    async function fetchJson(url) {
        const res = await fetch(url);
        if (!res.ok) {
            throw new Error(`HTTP ${res.status} for ${url}`);
        }
        return res.json();
    }

    async function getUsdtPerpSymbols() {
        const data = await fetchJson(`${API_BASE}/fapi/v1/exchangeInfo`);
        const list = data.symbols
            .filter(s =>
                s.contractType === 'PERPETUAL' &&
                s.quoteAsset === 'USDT' &&
                s.status === 'TRADING'
            )
            .map(s => s.symbol);
        return list;
    }

    async function fetchKlines(symbol) {
        const url = `${API_BASE}/fapi/v1/klines?symbol=${symbol}&interval=${INTERVAL}&limit=${LIMIT}`;
        return fetchJson(url);
    }

    function analyzeSymbol(symbol, klines) {
        const n = klines.length;
        if (n < 120) {
            // 데이터가 너무 적으면 패스
            return null;
        }

        const closes = new Array(n);
        const quoteVols = new Array(n);
        const closeTimes = new Array(n);

        for (let i = 0; i < n; i++) {
            const k = klines[i];
            closes[i] = parseFloat(k[4]);      // 종가
            quoteVols[i] = parseFloat(k[7]);   // quote asset volume
            closeTimes[i] = k[6];              // closeTime (ms)
        }

        // 99MA 계산 (단순 이동평균)
        const ma99 = new Array(n).fill(null);
        let sum = 0;
        for (let i = 0; i < n; i++) {
            sum += closes[i];
            if (i >= 99) {
                sum -= closes[i - 99];
            }
            if (i >= 98) {
                ma99[i] = sum / 99;
            }
        }

        const lastIndex = n - 1;        // 진행 중 캔들
        const prevIndex = n - 2;        // 바로 직전, 닫힌 캔들 = “이전봉”

        if (prevIndex < 100 || ma99[prevIndex] == null) {
            return null;
        }

        const prevClose = closes[prevIndex];
        const prevMa = ma99[prevIndex];

        // 조건 1) 이전봉 종가 > 이전봉 99MA
        if (!(prevClose > prevMa)) {
            return null;
        }

        // 조건 2) 그 앞의 캔들들이 연속으로 99MA 하회
        let runLength = 0;
        let idx = prevIndex - 1;
        while (idx >= 0 && ma99[idx] != null) {
            if (closes[idx] < ma99[idx]) {
                runLength++;
                idx--;
            } else {
                break;
            }
        }

        if (runLength <= 0) {
            // 바로 앞 캔들이 99MA 아래가 아닌 경우 → 패턴 아님
            return null;
        }

        const ratioPct = (prevClose / prevMa - 1) * 100;
        const prevQuoteVol = quoteVols[prevIndex];
        const prevCloseTime = closeTimes[prevIndex];

        return {
            symbol,
            prevClose,
            prevMa,
            ratioPct,
            runLength,
            prevQuoteVol,
            prevCloseTime
        };
    }

    function renderResults(results) {
        resultBody.innerHTML = '';

        if (!results || results.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 7;
            td.className = 'muted';
            td.textContent = '조건을 만족하는 심볼이 없습니다.';
            tr.appendChild(td);
            resultBody.appendChild(tr);
            return;
        }

        for (const r of results) {
            const tr = document.createElement('tr');

            const tdSymbol = document.createElement('td');
            tdSymbol.textContent = r.symbol;

            const tdClose = document.createElement('td');
            tdClose.className = 'num';
            tdClose.textContent = formatNumber(r.prevClose, 4);

            const tdMa = document.createElement('td');
            tdMa.className = 'num';
            tdMa.textContent = formatNumber(r.prevMa, 4);

            const tdRatio = document.createElement('td');
            tdRatio.className = 'num ' + (r.ratioPct >= 0 ? 'good' : 'bad');
            tdRatio.textContent = formatNumber(r.ratioPct, 2);

            const tdRun = document.createElement('td');
            tdRun.className = 'num';
            tdRun.textContent = r.runLength.toString();

            const tdQv = document.createElement('td');
            tdQv.className = 'num';
            tdQv.textContent = formatNumber(r.prevQuoteVol, 0);

            const tdTime = document.createElement('td');
            tdTime.textContent = formatUtcTime(r.prevCloseTime);

            tr.appendChild(tdSymbol);
            tr.appendChild(tdClose);
            tr.appendChild(tdMa);
            tr.appendChild(tdRatio);
            tr.appendChild(tdRun);
            tr.appendChild(tdQv);
            tr.appendChild(tdTime);

            resultBody.appendChild(tr);
        }
    }

    async function scanAll() {
        scanBtn.disabled = true;
        statusText.textContent = '심볼 목록 불러오는 중...';

        try {
            const symbols = await getUsdtPerpSymbols();
            if (!symbols || symbols.length === 0) {
                statusText.textContent = 'USDT 무기한 심볼을 찾지 못했습니다.';
                scanBtn.disabled = false;
                return;
            }

            const total = symbols.length;
            const results = [];
            let index = 0;

            async function worker(workerId) {
                while (true) {
                    const myIndex = index;
                    if (myIndex >= total) break;
                    index++;

                    const sym = symbols[myIndex];
                    statusText.textContent = `스캔 중 ${myIndex + 1}/${total} (${sym})`;

                    try {
                        const klines = await fetchKlines(sym);
                        const r = analyzeSymbol(sym, klines);
                        if (r) {
                            results.push(r);
                        }
                    } catch (err) {
                        console.error('Error for', sym, err);
                    }
                }
            }

            const workers = [];
            const workerCount = Math.min(CONCURRENCY, total);
            for (let i = 0; i < workerCount; i++) {
                workers.push(worker(i));
            }

            await Promise.all(workers);

            // 거래대금(이전봉 quoteVolume) 기준 내림차순 정렬
            results.sort((a, b) => b.prevQuoteVol - a.prevQuoteVol);

            renderResults(results);
            statusText.textContent = `완료: ${results.length}개 심볼이 조건을 만족했습니다. (총 ${total}개 심볼 스캔)`;
        } catch (err) {
            console.error(err);
            statusText.textContent = '에러 발생: 콘솔을 확인하세요.';
        } finally {
            scanBtn.disabled = false;
        }
    }

    scanBtn.addEventListener('click', () => {
        scanAll();
    });
</script>
</body>
</html>
