<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>Binance Perp USDT â€” 15m 2â†’1ë´‰ 99MA ê·¼ì ‘ë„ ìŠ¤ìºë„ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --bg: #05060a;
            --card: #12131a;
            --muted: #9aa0a6;
            --text: #e8eaed;
            --accent: #3ea6ff;
            --good: #00c853;
            --bad: #ff5252;
            --border: #2a2e36;
            --row-alt: #181924;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #151821 0, #050609 55%, #020308 100%);
            color: var(--text);
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        h1 {
            font-size: 20px;
            margin: 0 0 6px;
        }

        .desc {
            margin: 0 0 12px;
            font-size: 13px;
            color: var(--muted);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }

        button {
            padding: 8px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: #1c1e27;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        button:hover {
            background: #252735;
        }

        button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .status {
            font-size: 13px;
            color: var(--muted);
        }

        .meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .meta span.label {
            color: var(--muted);
            margin-right: 4px;
        }

        .table-wrap {
            margin-top: 8px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: var(--card);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead {
            background: #181924;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        th, td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            text-align: right;
            white-space: nowrap;
        }

        th:first-child,
        td:first-child {
            text-align: center;
        }

        th:nth-child(2),
        td:nth-child(2) {
            text-align: left;
        }

        th {
            font-weight: 600;
            font-size: 11px;
            color: var(--muted);
        }

        tbody tr:nth-child(even) {
            background: var(--row-alt);
        }

        .rank {
            font-size: 11px;
            color: var(--muted);
        }

        .sym {
            font-weight: 600;
            font-size: 12px;
        }

        .delta-strong {
            color: var(--good);
            font-weight: 600;
        }

        .log {
            margin-top: 10px;
            padding: 8px;
            border-radius: 8px;
            background: #0a0b10;
            border: 1px solid var(--border);
            font-size: 11px;
            max-height: 140px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        @media (max-width: 768px) {
            .app {
                padding: 12px;
            }
            table {
                font-size: 11px;
            }
            th, td {
                padding: 4px 6px;
            }
            h1 {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <h1>Binance Perp USDT â€” 15m 2â†’1ë´‰ 99MA ê·¼ì ‘ë„ ìŠ¤ìºë„ˆ</h1>
        <p class="desc">
            15ë¶„ë´‰ ê¸°ì¤€ìœ¼ë¡œ <strong>2ì „ë´‰ ì¢…ê°€ì™€ 99MA</strong> ì‚¬ì´ ê±°ë¦¬ë³´ë‹¤
            <strong>1ì „ë´‰ ì¢…ê°€ì™€ 99MA</strong> ì‚¬ì´ ê±°ë¦¬ê°€ ë” ì§§ì•„ì§„ USDT í˜ì–´ë“¤ì„ ì°¾ê³ ,<br>
            ê±°ë¦¬ ê°ì†Œí­(2ì „ë´‰ ê±°ë¦¬ âˆ’ 1ì „ë´‰ ê±°ë¦¬, % ê¸°ì¤€)ì´ í° ìˆœì„œëŒ€ë¡œ ì •ë ¬í•©ë‹ˆë‹¤.
        </p>

        <div class="controls">
            <button id="startScanBtn">ìŠ¤ìº” ì‹œì‘ + ìë™ìŠ¤ìº” On</button>
            <button id="stopScanBtn">ìë™ìŠ¤ìº” ì¤‘ì§€</button>
            <span id="statusText" class="status">ì‹¬ë³¼ ëª©ë¡ ì¤€ë¹„ ì¤‘...</span>
        </div>

        <div class="meta">
            <div>
                <span class="label">ì‹¬ë³¼ ìˆ˜:</span>
                <span id="symbolCount">-</span>
            </div>
            <div>
                <span class="label">ì§„í–‰ ìƒí™©:</span>
                <span id="progressText">-</span>
            </div>
            <div>
                <span class="label">ìµœê·¼ ìŠ¤ìº” ì‹œê°:</span>
                <span id="lastScanText">-</span>
            </div>
            <div>
                <span class="label">ë‹¤ìŒ ìë™ ìŠ¤ìº” ì˜ˆì •:</span>
                <span id="nextScanText">-</span>
            </div>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>ì‹¬ë³¼</th>
                        <th>2ì „ë´‰ ì¢…ê°€</th>
                        <th>2ì „ë´‰ 99MA</th>
                        <th>2ì „ë´‰ ê±°ë¦¬(%)</th>
                        <th>1ì „ë´‰ ì¢…ê°€</th>
                        <th>1ì „ë´‰ 99MA</th>
                        <th>1ì „ë´‰ ê±°ë¦¬(%)</th>
                        <th>ê±°ë¦¬ ê°ì†Œí­(%)</th>
                    </tr>
                </thead>
                <tbody id="resultBody">
                </tbody>
            </table>
        </div>

        <pre id="logArea" class="log"></pre>
    </div>

    <script>
        (function () {
            const API_BASE = "https://fapi.binance.com";

            let allSymbols = [];
            let symbolsLoaded = false;
            let isLoadingSymbols = false;
            let isScanning = false;
            let autoEnabled = false;
            let autoTimer = null;

            const startBtn = document.getElementById("startScanBtn");
            const stopBtn = document.getElementById("stopScanBtn");
            const statusText = document.getElementById("statusText");
            const symbolCountEl = document.getElementById("symbolCount");
            const progressText = document.getElementById("progressText");
            const lastScanText = document.getElementById("lastScanText");
            const nextScanText = document.getElementById("nextScanText");
            const resultBody = document.getElementById("resultBody");
            const logArea = document.getElementById("logArea");

            function log(msg) {
                const now = new Date();
                const t = now.toTimeString().slice(0, 8);
                logArea.textContent = `[${t}] ${msg}\n` + logArea.textContent;
            }

            function formatKoreanTime(date) {
                if (!date) {
                    return "-";
                }
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, "0");
                const d = String(date.getDate()).padStart(2, "0");
                const hh = String(date.getHours()).padStart(2, "0");
                const mm = String(date.getMinutes()).padStart(2, "0");
                const ss = String(date.getSeconds()).padStart(2, "0");
                return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
            }

            async function loadSymbols() {
                if (symbolsLoaded || isLoadingSymbols) {
                    return;
                }
                isLoadingSymbols = true;
                statusText.textContent = "ì‹¬ë³¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
                log("exchangeInfo ë¡œë”© ì‹œì‘");

                try {
                    const res = await fetch(`${API_BASE}/fapi/v1/exchangeInfo`);
                    if (!res.ok) {
                        throw new Error("exchangeInfo ì—ëŸ¬: " + res.status);
                    }
                    const data = await res.json();
                    const symbols = data.symbols || [];
                    allSymbols = symbols
                        .filter(function (s) {
                            return s.contractType === "PERPETUAL" &&
                                s.quoteAsset === "USDT" &&
                                s.status === "TRADING";
                        })
                        .map(function (s) {
                            return s.symbol;
                        })
                        .sort();

                    symbolsLoaded = true;
                    symbolCountEl.textContent = String(allSymbols.length);
                    statusText.textContent = "ì‹¬ë³¼ ëª©ë¡ ì¤€ë¹„ ì™„ë£Œ (" + allSymbols.length + "ê°œ)";
                    log("ì‹¬ë³¼ " + allSymbols.length + "ê°œ ë¡œë”© ì™„ë£Œ");
                } catch (err) {
                    console.error(err);
                    statusText.textContent = "ì‹¬ë³¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨ (ì½˜ì†” í™•ì¸)";
                    log("ì‹¬ë³¼ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨: " + err.message);
                } finally {
                    isLoadingSymbols = false;
                }
            }

            function renderResults(rows) {
                resultBody.innerHTML = "";
                if (!rows.length) {
                    const tr = document.createElement("tr");
                    const td = document.createElement("td");
                    td.colSpan = 9;
                    td.textContent = "ì¡°ê±´ì— ë§ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.";
                    tr.appendChild(td);
                    resultBody.appendChild(tr);
                    return;
                }

                rows.forEach(function (row, idx) {
                    const tr = document.createElement("tr");

                    function addCell(text, cls) {
                        const td = document.createElement("td");
                        td.textContent = text;
                        if (cls) {
                            td.className = cls;
                        }
                        tr.appendChild(td);
                    }

                    addCell(String(idx + 1), "rank");
                    addCell(row.symbol, "sym");
                    addCell(row.close2.toFixed(4));
                    addCell(row.ma2.toFixed(4));
                    addCell(row.dist2Pct.toFixed(4));
                    addCell(row.close1.toFixed(4));
                    addCell(row.ma1.toFixed(4));
                    addCell(row.dist1Pct.toFixed(4));
                    addCell(row.deltaPct.toFixed(4), "delta-strong");

                    resultBody.appendChild(tr);
                });
            }

            // ê°œë³„ ì‹¬ë³¼ ìŠ¤ìº”: 15m, ì¶©ë¶„í•œ ìº”ë“¤(120ê°œ)ë¡œ 2ì „/1ì „ 99MA ì •í™•íˆ ê³„ì‚°
            async function scanSymbol(symbol) {
                // 99MAë¥¼ 2ì „ë´‰ê¹Œì§€ ì •í™•íˆ ê³„ì‚°í•˜ë ¤ë©´ ìµœì†Œ 101ê°œ ì´ìƒ í•„ìš”í•´ì„œ ì—¬ìœ  ìˆê²Œ 120ê°œ ìš”ì²­
                const url = `${API_BASE}/fapi/v1/klines?symbol=${symbol}&interval=15m&limit=120`;

                const res = await fetch(url);
                if (!res.ok) {
                    return null; // ë ˆì´íŠ¸ë¦¬ë°‹/ì—ëŸ¬ëŠ” ê·¸ëƒ¥ ìŠ¤í‚µ
                }

                const data = await res.json();
                if (!Array.isArray(data) || data.length < 101) {
                    // 2ì „ë´‰ ê¸°ì¤€ 99MAë¥¼ ê³„ì‚°í•˜ë ¤ë©´ ìµœì†Œ 101ê°œ í•„ìš”
                    return null;
                }

                const closes = data.map(function (k) {
                    return parseFloat(k[4]); // ì¢…ê°€
                });
                const n = closes.length;

                // idxCurrent = í˜„ì¬ ì§„í–‰ ì¤‘ ìº”ë“¤ (ì‚¬ìš© X)
                const idxCurrent = n - 1;

                // 1ì „ë´‰ = ë°”ë¡œ ì´ì „ ì™„ì„± ë´‰
                const idx1 = n - 2;

                // 2ì „ë´‰ = ê·¸ ì´ì „ ì™„ì„± ë´‰
                const idx2 = n - 3;

                // 2ì „ë´‰ì—ì„œ 99MAë¥¼ ê³„ì‚°í•  ë•Œ ì‹œì‘ ì¸ë±ìŠ¤ê°€ ìŒìˆ˜ê°€ ë˜ë©´ ì•ˆ ë¨
                if (idx2 - 98 < 0) {
                    return null;
                }

                const close1 = closes[idx1]; // 1ì „ë´‰ ì¢…ê°€
                const close2 = closes[idx2]; // 2ì „ë´‰ ì¢…ê°€

                // 1ì „ë´‰ 99MA: idx1ì—ì„œ ëë‚˜ëŠ” 99ê°œ (idx1-98 ~ idx1)
                const ma1Window = closes.slice(idx1 - 98, idx1 + 1);
                // 2ì „ë´‰ 99MA: idx2ì—ì„œ ëë‚˜ëŠ” 99ê°œ (idx2-98 ~ idx2)
                const ma2Window = closes.slice(idx2 - 98, idx2 + 1);

                const ma1 = ma1Window.reduce(function (acc, v) {
                    return acc + v;
                }, 0) / ma1Window.length;

                const ma2 = ma2Window.reduce(function (acc, v) {
                    return acc + v;
                }, 0) / ma2Window.length;

                const dist1 = Math.abs(close1 - ma1);
                const dist2 = Math.abs(close2 - ma2);

                // ê±°ë¦¬(%) = |ì¢…ê°€ - 99MA| / 99MA * 100
                const dist1Pct = (dist1 / ma1) * 100;
                const dist2Pct = (dist2 / ma2) * 100;

                // ì§„ì§œë¡œ "99MAê¹Œì§€ ê±°ë¦¬ê°€ ì¤„ì–´ë“  ê²ƒ"ë§Œ í†µê³¼ (1ì „ë´‰ì´ ë” ê°€ê¹Œì›Œì•¼ í•¨)
                if (dist1Pct >= dist2Pct) {
                    return null;
                }

                // ê±°ë¦¬ ê°ì†Œí­(%) = 2ì „ë´‰ ê±°ë¦¬ âˆ’ 1ì „ë´‰ ê±°ë¦¬
                const deltaPct = dist2Pct - dist1Pct;

                return {
                    symbol: symbol,
                    close2: close2,
                    ma2: ma2,
                    dist2Pct: dist2Pct,
                    close1: close1,
                    ma1: ma1,
                    dist1Pct: dist1Pct,
                    deltaPct: deltaPct
                };
            }

            async function runScanOnce() {
                await loadSymbols();
                if (!symbolsLoaded || !allSymbols.length) {
                    statusText.textContent = "ì‹¬ë³¼ ëª©ë¡ì´ ì—†ì–´ ìŠ¤ìº”ì„ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    return;
                }
                if (isScanning) {
                    log("ì´ë¯¸ ìŠ¤ìº” ì¤‘ì´ì–´ì„œ ì´ë²ˆ ìš”ì²­ì€ ë¬´ì‹œí•©ë‹ˆë‹¤.");
                    return;
                }

                isScanning = true;
                statusText.textContent = "ìŠ¤ìº” ì¤‘...";
                progressText.textContent = "0 / " + allSymbols.length;
                log("15m 2â†’1ë´‰ 99MA ê·¼ì ‘ë„ ìŠ¤ìº” ì‹œì‘");

                const results = [];
                const total = allSymbols.length;
                let processed = 0;
                const maxConcurrent = 3;  // ë ˆì´íŠ¸ë¦¬ë°‹ ê³ ë ¤í•´ì„œ ë„ˆë¬´ ë†’ê²Œ ì˜¬ë¦¬ì§€ ì•ŠëŠ” ê²Œ ì•ˆì „
                let index = 0;

                async function worker(workerId) {
                    while (true) {
                        const currentIndex = index;
                        if (currentIndex >= total) {
                            break;
                        }
                        index += 1;
                        const sym = allSymbols[currentIndex];

                        try {
                            const row = await scanSymbol(sym);
                            if (row) {
                                results.push(row);
                            }
                        } catch (err) {
                            console.error("scanSymbol error", sym, err);
                        } finally {
                            processed += 1;
                            progressText.textContent = processed + " / " + total;
                        }
                    }
                }

                const workers = [];
                for (let i = 0; i < maxConcurrent; i += 1) {
                    workers.push(worker(i));
                }
                await Promise.all(workers);

                results.sort(function (a, b) {
                    return b.deltaPct - a.deltaPct;
                });
                renderResults(results);

                const now = new Date();
                lastScanText.textContent = formatKoreanTime(now);
                statusText.textContent = "ìŠ¤ìº” ì™„ë£Œ (ë§¤ì¹˜ " + results.length + "ê°œ)";
                log("ìŠ¤ìº” ì™„ë£Œ: ì¡°ê±´ ë§¤ì¹˜ " + results.length + "ê°œ");

                isScanning = false;
            }

            // ğŸ”§ ì—¬ê¸° í•¨ìˆ˜ê°€ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„
            // í•­ìƒ "ì§€ê¸ˆë³´ë‹¤ ë’¤ì— ìˆëŠ”" 00/15/30/45 ì‹œê°ë§Œ ë°˜í™˜
            function computeNextQuarterHour(from) {
                const baseMs = (from ? from.getTime() : Date.now()) + 1000; // +1ì´ˆ ì—¬ìœ 
                const interval = 15 * 60 * 1000; // 15ë¶„
                const nextTs = Math.ceil(baseMs / interval) * interval;
                return new Date(nextTs);
            }

            function scheduleNextScan() {
                if (!autoEnabled) {
                    nextScanText.textContent = "-";
                    return;
                }
                const now = new Date();
                const next = computeNextQuarterHour(now);
                const delay = next.getTime() - now.getTime();

                nextScanText.textContent = formatKoreanTime(next);
                log("ë‹¤ìŒ ìë™ ìŠ¤ìº” ì˜ˆì•½: " + formatKoreanTime(next) +
                    " (ì•½ " + (delay / 1000).toFixed(0) + "ì´ˆ í›„)");

                if (autoTimer) {
                    clearTimeout(autoTimer);
                    autoTimer = null;
                }

                autoTimer = setTimeout(async function () {
                    if (!autoEnabled) {
                        return;
                    }
                    await runScanOnce();
                    scheduleNextScan();
                }, delay);
            }

            async function startAutoScan() {
                if (autoEnabled) {
                    log("ì´ë¯¸ ìë™ ìŠ¤ìº”ì´ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
                    return;
                }
                autoEnabled = true;
                log("ìë™ ìŠ¤ìº” ì‹œì‘ (ì²« ìŠ¤ìº” ì¦‰ì‹œ ì‹¤í–‰)");
                await runScanOnce();
                scheduleNextScan();
            }

            function stopAutoScan() {
                if (!autoEnabled) {
                    log("ìë™ ìŠ¤ìº”ì´ ì´ë¯¸ êº¼ì ¸ ìˆìŠµë‹ˆë‹¤.");
                    return;
                }
                autoEnabled = false;
                if (autoTimer) {
                    clearTimeout(autoTimer);
                    autoTimer = null;
                }
                nextScanText.textContent = "-";
                statusText.textContent = "ìë™ ìŠ¤ìº” ì¤‘ì§€ë¨";
                log("ìë™ ìŠ¤ìº” ì¤‘ì§€");
            }

            startBtn.addEventListener("click", function () {
                startAutoScan();
            });

            stopBtn.addEventListener("click", function () {
                stopAutoScan();
            });

            // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¬ë³¼ ëª©ë¡ë§Œ ë¯¸ë¦¬ ë¡œë”©
            loadSymbols();
        })();
    </script>
</body>
</html>
